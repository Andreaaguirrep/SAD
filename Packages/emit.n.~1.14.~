(* emit.n 6/1/2007 *)

With[{default={OneTurnInformation->False,
  Orbit->False,Matrix->False,ExpandElementValues->True,
  Emittance->True,SaveEMIT->False,InitialOrbit->Null,
  InitialBeamMatrix->Null,Output->0}},

  Emittance[opt___]:=Module[{
    e,r,op,mode,ex0=EMITX,ey0=EMITY,ez0=EMITZ,iniorbit,inibeam,out},
    Check[
      op=Override[opt,default];
      If[ExpandElementValues/.op,Element["EXPAND"]];
      mode=
        If[Matrix/.op,3,
          If[Orbit/.op,2,
            If[OneTurnInformation/.op,1,
              If[Emittance/.op,0,-1,0],0],0],0];
      {iniorbit,inibeam,out}={InitialOrbit,InitialBeamMatrix,Output}/.op;
      If[inibeam<=>Null,
        inibeam=Flatten[Table[inibeam[[i,j]],{i,6},{j,i}]]];
      e=CalculateEmittance[mode,out,{iniorbit,inibeam}];
      r={Stable->e[[1]],Tunes->e[[2,{7,8,9}]],
        EnergyLossU0->e[[2,10]],RfVoltageVc->e[[2,11]],
        EquilibriumPosition->e[[2,12]],MomentumCompaction->e[[2,13]],
        OrbitDilation->e[[2,14]],BucketHeight->e[[2,15]],
        HarmonicNumber->e[[2,27]],OrbitAtExit->e[[2,{1,2,3,4,5,6}]]};
      If[mode>=0,
        r=Join[r,
          {DampingRate->e[[2,{16,17,18}]],Emittances->e[[2,{22,23,24}]],
            MomentumSpread->e[[2,25]],BunchLength->e[[2,26]],
            TuneShiftByRadiation->e[[2,{28,29,30}]]/Pi/2}]];
      If[mode>0,
        r=Join[r,{
          OrbitAtEntrance->e[[3,1]],OneTurnTransferMatrix->e[[3,2]],
          OneTurnDampingMatrix->e[[3,3]],NormalCoordinates->e[[3,4]],
          ExtendedTwissParameters->
            {AX->e[[2,31]],BX->e[[2,32]],PSIX->e[[2,33]],
              AY->e[[2,34]],BY->e[[2,35]],PSIY->e[[2,36]],
              AZ->e[[2,51]],BZ->e[[2,52]],PSIZ->e[[2,53]],
              R1->e[[2,41]],R2->e[[2,42]],R3->e[[2,43]],R4->e[[2,44]],
              ZX->e[[2,54]],ZPX->e[[2,55]],ZY->e[[2,56]],ZPY->e[[2,57]],
              EX->e[[2,37]],EPX->e[[2,38]],EY->e[[2,39]],EPY->e[[2,40]]},
          OneTurnExcitation->
            Table[e[[3,5,((m+n+Abs[m-n])^2+2*(m+n)-6*Abs[m-n])/8]],
              {m,6},{n,6}],
          EquilibriumBeamMatrix->
            Table[e[[3,6,((m+n+Abs[m-n])^2+2*(m+n)-6*Abs[m-n])/8]],
              {m,6},{n,6}]}];
        If[mode>1,
          AppendTo[r,ClosedOrbit->e[[4]]];
          If[mode>2,
            AppendTo[r,TransferMatrices->e[[5]]];
            If[?INTRA,
              AppendTo[r,IntrabeamExcitation->e[[6]]]]]]];
      If[~(SaveEMIT/.op),EMITX=ex0;EMITY=ey0;EMITZ=ez0];
      r,
      EMITX=ex0;EMITY=ey0;EMITZ=ez0;{}]]
  ];

With[{default={AzimuthalModes->9}},
  SynchroBetaEmittance[nustart_:Real,opt___]:=SynchroBetaEmittance[{nustart},opt];
  SynchroBetaEmittance[{nustart_,nustop_:Null,nustep_:Null},opt___]:=Module[{am},
    am=AzimuthalModes/.{opt}/.default;
    SynchroBetaEmittance1[nustart,
      If[nustop===Null,nustart,nustop],
      If[nustep===Null,1,nustep],
      am]]];


SymplecticJ[n_]:=(SymplecticJ[n]=Module[{m},
  m=Table[0,{n},{n}];
  Do[m[i,i+1]=1;m[i+1,i]=-1,{i,1,Floor[n/2]*2-1,2}];
  m]);

SymplecticInverse[m_]:=
  -SymplecticJ[Length[m]].Transpose[m].SymplecticJ[Length[m]];


Protect[Emittance,SynchroBetaEmittance,SymplecticInverse,AX,AY,AZ,BX,BY,BZ,
    EX,EPX,EY,EPY,ZX,ZPX,ZY,ZPY,PSIX,PSIY,PSIZ,R1,R2,R3,R4];
