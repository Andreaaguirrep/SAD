(* Plots 11/24/2004 *)

SetAttributes[{Contours,MeshRange,ColorFunction,ContourColorFunction,
  MaxBend,PlotPoints,PlotDivision,FunctionLabel,ResultLabel,RaiseFit,
  Signal,GoodnessOfFit,ChiSquare,ConfidenceInterval,ColumnTags,MeshStyle,
  PlotStyle,Columns,Bins,BinRange,ColumnLabel,Mesh,MeshColor},
  Constant];

Show;

BeginPackage[Plots`,Global`]

Begin[Plots`]

With[{CP$def={Scale->{Linear,Linear},
  AspectRatio->Automatic,
  Frame->True,Tags->False,
  FillColor->{"black","red","blue","green","gray","magenta","cyan",
    "yellow"},
  MeshStyle->{None,"gray25","gray50"},
  ColumnOffset->0.15,Reference->0,Orientation->Vertical,
  TickSize->Automatic,PlotRegion->{{0,1},{0,1}},
  ColumnLabel->Automatic,
  ColumnTags->Null,
  FrameTicks->{Automatic,Automatic},Initialize->True,
  FrameLabel->{"","","",""},DisplayFunction:>$DisplayFunction,
  PlotLabel->"",Prolog->{},Epilog->{},
  background->"#ffffff"},
  r=(Rule|RuleDelayed)[Graphics$Options,_],Graphics$Options},

  ColumnPlot[ll_,opt___]:=Module[
    {n=Length[ll],d=Dimensions[ll],nc,ns,
      coff,cm,cw,x,y,cx,g,ref,of,pc,ms,pcx,msx,pr,or,sc,gopt,ld,
      cla,cl,ft,ts,tis,tx,t,tag,
      op=Override[opt,CP$def]
      },
    {coff,ref,of,pc,ms,or,cl,ft,tis,tag}={ColumnOffset,Reference,
      DisplayFunction,
      FillColor,MeshStyle,Orientation,ColumnLabel,FrameTicks,
      TickSize,ColumnTags}/.op;
    ld=Length[d];
    {nc,ns,ymin,ymax}=Switch[ld,
      1,
      Join[{1,1},MinMax[ref,ll]],
      2,
      Join[{Second[d],1},MinMax[ref,ll]],
      3,
      Join[{Second[d],Third[d]},MinMax[ref,ref+((Plus@@#)&/@#)&/@ll]],
      _,
      Message[ListPlot::highD];
      Return[]];
    {cw,cm}=If[nc==1,{1-2*coff,0},
      (1-2*coff)/nc*{1-coff,coff}];
    pr=PlotRange/.op/.PlotRange->{Automatic,
      {If[ymin==ref,ref,Automatic],If[ymax==ref,ref,Automatic]}};
    If[or=or===Horizontal,
      pr=Reverse[pr];dr={{ymin,ymax},{0,n}},
      dr={{0,n},{ymin,ymax}}];
    cx=Table[coff+(cw+cm)*i+(i>0)*cm,{i,0,nc-1}];
    cx=(Thread[{cx,cx+cw}]+#)&/@Range[0,n-1];
    cla=Table["",{n*nc}];
    Check[
      Which[
        Head[cl]===List,
        ft=False;
        cla=Flatten[cl];
        cla=Join[cla,Table["",{Max[n*nc-Length[cla],0]}]];
        tx=WindowScaled[If[$DisplayFunction===TopDrawer,0.8,2.3]];
        tis=0;
        ts=Max[Min[2,6/Max[1,StringLength/@cla],12/n/nc],0.9],
        cl===Automatic,
        ,
        cl===None||cl===False,
        tis=0;
        ft=False,
        True,
        cx=cl/@cx;
        dr=If[or,{First[dr],cl/@Second[dr]},{cl/@First[dr],Second[dr]}]],
      Return[Graphics[{}]]];
    pc=Flatten[{pc}];
    pcx=Take[Flatten[Table[pc,{Ceiling[nc/Max[Length[pc],1]]}]],nc];
    pcx=Flatten[Table[pcx,{n}]];
    ms=Flatten[{ms}];
    msx=Take[Flatten[Table[ms,{Ceiling[ns/Max[Length[ms],1]]}]],ns];
    msx=Table[msx,{n*nc}];
    t=If[tag===Null,
      Table[Null,{n*nc}],
      StandardForm[Table[tag//i,{i,n*nc}]]];
    cx=Thread[{Flatten[cx,1],Flatten[ll,1],pcx,msx,cla,t}];
    sc=Flatten[{Linear,Scale/.op}][[{-2,-1}]];
    gopt=Override[Scale->sc,DataRange->dr,
      PlotRange->pr,
      FrameTicks->If[or,{Automatic,ft},{ft,Automatic}],
      TickSize->If[or,{Automatic,tis},{tis,Automatic}],
      Cases[op,r,1]];
    g=Graphics[Flatten[{Prolog/.op,
      If[or,
        If[ld<3,
          {Rectangle[{ref,#[[1,1]]},{Second[#],#[[1,2]]},
            FillColor->Third[#],MeshStyle->#[[4,1]],
            If[#[[6]]<=>Null,
              Tags->#[[6]],
              Null[]]],
            If[#[[5]]<=>"",
              Text[{#[[5]],{tx,Scaled[(#[[1,1]]+#[[1,2]])/2]}},
                TextAlign->"e",TextSize->ts],
              Null[]]}&/@cx,
          (y=ref;
            With[{x=First[#],c=Third[#],t=#[[6]]},
              {MapThread[
                Rectangle[{y,First[x]},{y+=#,Second[x]},
                FillColor->c,MeshStyle->#2,
                If[t<=>Null,
                  Tags->t,
                  Null[]]]&,{Second[#],#[[4]]}],
                If[#[[5]]<=>"",
                  Text[{#[[5]],{tx,Scaled[(First[x]+Second[x])/2]}},
                    TextAlign->"e",TextSize->ts],
                  Null[]]}])&/@cx],
        If[ld<3,
          {Rectangle[{#[[1,1]],ref},{#[[1,2]],Second[#]},
            FillColor->Third[#],MeshStyle->#[[4,1]],
            If[#[[6]]<=>Null,
              Tags->#[[6]],
              Null[]]],
            If[#[[5]]<=>"",
              Text[{#[[5]],{Scaled[(#[[1,1]]+#[[1,2]])/2],
                WindowScaled[1.85]-0.1}},
                TextRotate->270,TextAlign->"n",TextSize->ts],
              Null[]]}&/@cx,
          (y=ref;
            With[{x=First[#],c=Third[#],t=#[[6]]},
              {MapThread[
                Rectangle[{First[x],y},{Second[x],y+=#},
                FillColor->c,MeshStyle->#2,
                If[t<=>Null,
                  Tags->t,
                  Null[]]]&,{Second[#],#[[4]]}],
                If[#[[5]]<=>"",
                  Text[{#[[5]],{Scaled[(First[x]+Second[x])/2],
                    WindowScaled[1.85]-0.1}},
                    TextRotate->270,TextAlign->"n",TextSize->ts],
                  Null[]]}])&/@cx]],
      Epilog/.op}],
      gopt];
    If[of<=>Identity && of<=>Null && of<=>None,
      Show[g,Initialize->(Initialize/.op),
        PlotRegion->(PlotRegion/.op)]];
    g
    ]];

With[{def={PlotStyle->ColumnPlot,Orientation->Vertical,
  Bins:>Max[5,Min[100,Sqrt[Max[Length/@l]]]],
  Dashing->{{1},{0.75,0.25},{0.4, 0.15},{0.2,0.1},{0.1,0.08},
  {0.8,0.08, 0.08, 0.08},{0.4,0.08,0.08,0.08}},
  PlotColor:>If[$DisplayFunction===TopDrawer,
    {"black","red","blue","green","gray","magenta","cyan","yellow"},
    {"black","tomato","dark slate blue","forest green","gray",
      "magenta","cyan","yellow"}]}},

  HistoPlot[l_,opt___]:=HistoPlot[{l},opt];
  HistoPlot[l:{{_,_},___},opt___]:=HistoPlot[{l},opt];
  HistoPlot[l:{_List,___},opt___]:=Module[{min,max,
      {nc,ps}={Bins,PlotStyle}/.{opt}/.def,
      dc,col,hist,x,histall,ll=Length[l],da,pc,or},
    If[Head[l[[1,1]]]===List,
      {min,max}=BinRange/.{opt}/.
      BinRange->MinMax[l[[,,1]]]*{1,1.00001};
      dc=(max-min)/nc;
      histall=(
        col=Select[Thread[{Floor[(#[[,1]]-min)/dc]+1,#[[,2]]}],(1<=First[#]<=nc)&];
        hist=Table[0,{nc}];
        Scan[(hist[[First[#]]]+=Second[#])&,col];
        hist)&/@l,
      {min,max}=BinRange/.{opt}/.BinRange->MinMax[l]*{1,1.00001};
      dc=(max-min)/nc;
      histall=(
        col=Select[Floor[(#-min)/dc]+1,(1<=#<=nc)&];
        hist=Table[0,{nc}];
        Scan[(hist[[#]]++)&,col];
        hist)&/@l];
    Switch[ps,
      ColumnPlot,
      With[{dc,min},
        ColumnPlot[Thread[histall],ColumnLabel->(#*dc+min&),opt]],
      ListPlot,
      {da,pc,or}={Dashing,PlotColor,Orientation}/.{opt}/.def;
      da=(Dashing->#)&/@Take[Flatten[Table[da,
        {Ceiling[ll/Max[Length[da],1]]}],1],ll];
      pc=(PlotColor->#)&/@Take[Flatten[Table[pc,
        {Ceiling[ll/Max[Length[pc],1]]}]],ll];
      x=(Range[nc]-0.5)*dc+min;
      Show[MapThread[ListPlot[
        If[or===Vertical,
          Thread[{x,#}],
          Thread[{#,x}]],
        ##2,
        DisplayFunction->Identity,opt]&,{histall,da,pc}]],
      FitPlot,
      {da,pc,or}={Dashing,PlotColor,Orientation}/.{opt}/.def;
      da=(Dashing->#)&/@Take[Flatten[Table[da,
        {Ceiling[ll/Max[Length[da],1]]}],1],ll];
      pc=(PlotColor->#)&/@Take[Flatten[Table[pc,
        {Ceiling[ll/Max[Length[pc],1]]}]],ll];
      x=(Range[nc]-0.5)*dc+min;
      With[{fp=Null@@(FitParameters/.{opt})},
        Show[MapThread[FitPlot[
          If[or===Vertical,
            Thread[{x,#}],
            Thread[{#,x}]],
          fp,
          ##2,
          DisplayFunction->Identity,opt][[2]]&,{histall,da,pc}]]]]
    ]];

With[{def={MaxBend->0.04,PlotPoints->25,PlotDivision->250,
  PlotJoined->True,StepRatio->1,Plot->False}},
  Plot[f_,{x_,xmin_,xmax_},opt___]:=Block[{x},Module[
    {{maxb,minp,minx,pj,sr,pt}=
      {MaxBend,PlotPoints,PlotDivision,PlotJoined,StepRatio,Plot}/.{opt}/.def},
    ListPlot[PlotInterpolate[f,{x,xmin,xmax},minp,minx,maxb],
      PlotJoined->pj,StepRatio->sr,Plot->pt,opt]]]];

With[{def={Dashing->{{1},{0.75,0.25},{0.4, 0.15},{0.2,0.1},{0.1,0.08},
  {0.8,0.08, 0.08, 0.08},{0.4,0.08,0.08,0.08}},
  PlotColor:>If[$DisplayFunction===TopDrawer,
    {"black","red","blue","green","gray","magenta","cyan","yellow"},
    {"black","red3","dark slate blue","forest green","gray",
      "magenta","cyan","yellow"}],
  DisplayFunction->Default}},
  Plot[f_List,{x_,xmin_,xmax_},opt___]:=Block[{x},Module[
    {da,pc,n,g,h=Map[Hold,Unevaluated[f]]},
    x=xmin;
    {da,pc}={Dashing,PlotColor}/.{opt}/.def;
    n=Length[h];
    da=(Dashing->#)&/@Take[Flatten[Table[da,
      {Ceiling[n/Max[Length[da],1]]}],1],n];
    pc=(PlotColor->#)&/@Take[Flatten[Table[pc,
      {Ceiling[n/Max[Length[pc],1]]}]],n];
    g=MapThread[Function[{a,b,c},Plot[ReleaseHold[a],{x,xmin,xmax},
      DisplayFunction->Null,b,c,opt]],{h,da,pc}];
    If[(DisplayFunction/.{opt}/.def)===Default,Show[g]];
    g]]];

PlotInterpolate[fin_,{y_,xmin_,xmax_},min_,maxdiv_,maxb_]:=Module[
  {f,fs,xs,s,l,l0,l1,l2,b,a,b,yw,ar,dx,x,yl},
  fs[x_]:=With[{y=x},{x,Check[fin,0]}];
  f[x_]:=With[{y=Vector[x]},Check[Thread[{x,ReleaseVector[fin]}],fs[Vector[x]]]];
  dx=(xmax-xmin)/min;
  l=f[Range[0,min]*dx+xmin];
  yl=l[[,2]];
  yw=Max[yl]-Min[yl];
  ar=Abs[yw/(xmax-xmin)];
  xs=(xmax-xmin)/maxdiv;
  s=True;
  While[s,
    l0=Take[l,{1,-3}];
    l1=Take[l,{2,-2}];
    l2=Take[l,{3,-1}];
    b=MapThread[{#[[1]],#2[[1]],#3[[1]],
      Abs[ar*(#[[1]]*#2[[2]]-#[[2]]*#2[[1]])/
        Sqrt[Restrict[((ar*#[[1]])^2+#[[2]]^2)*
          ((ar*#2[[1]])^2+#2[[2]]^2),1e-100,Infinity]]]}&,
      {l0-l1,l2-l1,l1}];
    a={};
    Scan[(If[#[[4]]>maxb,
      If[Abs[First[#]]>xs,
        a=Append[a,fs[Third[#]+First[#]/3]]];
      If[Abs[Second[#]]>xs,
        a=Append[a,fs[Third[#]+Second[#]/3]]]])&,
      b];
    s=Length[a]>0;
    If[s,l=Union[l,a]]];
  l];

SetAttributes[Plot,HoldAll];
SetAttributes[PlotInterpolate,HoldFirst];

FitPlot[data_,fun_,x_,par0__]:=
  Module[{s,g1,g,fun1,dy=0.28,xl,yl,dx,d,dm,x0,y0,lsym,
    {opt,par}=SwitchCases[{par0},{_Rule|_RuleDelayed,_}],
    x1,x2,ci,g3,xa=data[[,1]],lp,sc,ts,fn,re,col,pr,res,rf},
    lp=Length[par];
    sc=Weight/.opt/.Weight->None;
    ts=TextSize/.opt/.TextSize->1;
    fn=FunctionLabel/.opt/.FunctionLabel->{0.5,0.8};
    re=ResultLabel/.opt/.ResultLabel->{0.5,10};
    col=Columns/.opt/.Columns->Min[3,lp];
    pr=PlotRange/.opt/.PlotRange->Automatic;
    rf=RaiseFit/.opt/.RaiseFit->False;
    If[res=(Head[re]===List),{x0,y0}=re];
    s=Which[
      sc===Signal,
      d=Thread[data];
      dm=Max[Second[d]];
      Fit[
        Thread[Switch[Length[First[data]],
          2,
          d,
          3,
          {First[d],Second[d],Third[d]/Second[d]*dm},
          4,
          {First[d],Second[d],Third[d],d[[4]]/Second[d]*dm}]],
        fun,x,par0],
      Head[sc]===List,
      d=Thread[data];
      Fit[
        Thread[Switch[Length[First[data]],
          2,
          {First[d],Second[d],sc},
          3,
          {First[d],Second[d],Third[d]*sc},
          4,
          {First[d],Second[d],Third[d]*sc,d[[4]]*sc}]],
        fun,x,par0],
      True,
      Fit[data,fun,x,par0]];
    g1=ListPlot[data,DisplayFunction->Identity,Null@@opt];
!    ReleaseHold[Hold[fun1[y_]:=With[{x=y},fun]]/.s];
    {x1,x2}=Switch[pr,
      {{_Real,_Real},_},First[pr],
      {{_Real,Automatic},_},{pr[[1,1]],Max[xa]},
      {{Automatic,_Real},_},{Min[xa],pr[[1,2]]},
      _,MinMax[xa]];
    Block[{x},
      g=Plot[Evaluate[fun/.s],{x,x1,x2},DisplayFunction->Identity,Null@@opt,PlotColor->"blue"]];
    lsym=Min[Max[StringLength[SymbolNameRoot[#]]&/@par[[,1]]],8];
    StandardForm[$FORM="8.5";
      ci=ConfidenceInterval/.s;
      If[Head[fn]===List||Head[re]===List,
        g3=Graphics[Flatten[{
          If[Head[fn]===List,
            StandardForm[
              Text[{"Function = "//Unevaluated[fun],
                {WindowScaled[First[fn]],WindowScaled[Second[fn]]}},
                TextSize->ts]],
            Null[]],
          If[res,
            dx=13.5/col;
            xl=x0+(Mod[#,col]&/@Range[0,lp-1])*dx;
            yl=y0-(Floor[Range[0,lp-1]/col]+2.5)*dy;
            Null@@{Text[{"ChiSquare ="//(ChiSquare/.s)//
              "  Goodness  ="//(GoodnessOfFit/.s),
              {WindowScaled[x0],WindowScaled[y0-dy]}},TextSize->ts],
              MapThread[Text[{(SymbolNameRoot[#[[1]]]//"        ")[1,lsym]
                //" ="//(#[[1]]/.s)//" +/-"//#2,
                {WindowScaled[#3],WindowScaled[#4]}},TextSize->ts]&,
                  {par,ci,xl,yl}]},
            Null[]]}]],
        g3:=Null[]]];
    {s,If[rf,
      Show[g1,g,g3,Null@@opt],
      Show[g,g1,g3,Null@@opt]]}];
SetAttributes[FitPlot,HoldRest];

With[{def={PlotRange->Automatic,MeshRange->Default,
  ColorFunction->Automatic,DisplayFunction->Default,
  AspectRatio->1,ContourColorFunction->Automatic,
  Contours->10}},
  ListContourPlot[l_,opt___]:=Module[{
    m0,m1,mesh,x,gr,op,
    {pr,mr,lc,cf,df,nc,ar}={PlotRange,MeshRange,ContourColorFunction,
      ColorFunction,
      DisplayFunction,Contours,AspectRatio}/.opt/.def},
    pr=CP$PlotRange[pr,l];
    mr=mr/.Automatic->Default;
    If[mr===Default,
      mesh=Identity,
      mr=CP$MeshRange[mr,l];
      {m0,m1}=Thread[mr];
      m1=(m1-m0)/(Dimensions[l]-1);
      mesh[x_]=m0+(x-1)*m1];
    Switch[cf,
      _String,
      cf=With[{cf},cf&],
      Null|None|False,
      cf="white"&,
      Automatic,
      cf=CP$Color
      ];
    Switch[lc,
      _String,
      lc=With[{lc},lc&],
      Null|None|False,
      lc=Null&,
      Automatic,
      lc=CP$ContourColor];
    op=DeleteCases[Override[AspectRatio->ar,DataRange->mr,opt],_[PlotRange,_],1];
    gr=Graphics[CP$FindContour[l,pr,nc,mesh,cf,lc],op];
    If[df===Default,Show[gr,op]];
    gr]];

With[{def={PlotRange->Automatic,MeshRange->Default,
  ColorFunction->Automatic,DisplayFunction->Default,
  AspectRatio->1,Mesh->False,MeshColor->Automatic}},
  ListDensityPlot[l_,opt___]:=Module[{
    m0,m1,mesh,x,gr,op,{nx,ny}=Dimensions[l],
    {pr,mr,cf,df,ar,ms,mc}={PlotRange,MeshRange,ColorFunction,
      DisplayFunction,AspectRatio,Mesh,MeshColor}/.opt/.def},
    pr=CP$PlotRange[pr,l];
    mr=mr/.Automatic->Default;
    If[mr===Default,
      mesh[x_]=x-0.5,
      mr=CP$MeshRange[mr,l];
      {m0,m1}=Thread[mr];
      m1=(m1-m0)/({nx,ny}-1);
      mesh[x_]=m0+(x-1.5)*m1];
    Switch[cf,
      _String,
      cf=cf&,
      Null|None|False,
      cf=Null,
      Automatic,
      cf=CP$Color
      ];
    Switch[mc,
      _String,
      mc=mc&,
      Null|None|False,
      mc=cf,
      Automatic,
      mc=CP$ContourColor
      ];
    l1=Restrict[(l-pr[[1]])/(pr[[2]]-pr[[1]]),0,1];
    g=If[ms===True,
      Table[
        Rectangle[mesh[{i,j}],mesh[{i+1,j+1}],FillColor->cf[l1[[i,j]]],
          PlotColor->mc[l1[[i,j]]]],
        {i,nx-1},{j,ny-1}],
      Table[
        Rectangle[mesh[{i,j}],mesh[{i+1,j+1}],FillColor->cf[l1[[i,j]]],
          PlotColor->cf[l1[[i,j]]]],
        {i,nx},{j,ny}]];
    op=DeleteCases[
      Override[AspectRatio->ar,DataRange->Thread[{mesh[{1,1}],mesh[{nx,ny}+1]}],opt],
      _[PlotRange,_],1];
    g=Graphics[Flatten[g],op];
    If[df===Default,Show[g,op]];
    g]];

CP$FindContour[l_,pr_,n_,mesh_,cf_,lc_]:=Module[
  {l1,l1f,i,j,k,dl,min,max,g,ml,gp,gl,
    i1,j1,f0,f1,f2,f3},
  {nx,ny}=Dimensions[l];
  l1=Restrict[(l-pr[[1]])/(pr[[2]]-pr[[1]])*n+0.5,0.5,n+0.5];
  l1f=Floor[l1];
  With[{l1},
    q0:={i,j+If[l1[[i,j1]]<>l1[[i,j]],(k-l1[[i,j]])/(l1[[i,j1]]-l1[[i,j]]),.5]};
    q1:={i+If[l1[[i1,j1]]<>l1[[i,j1]],(k-l1[[i,j1]])/(l1[[i1,j1]]-l1[[i,j1]]),.5],j1};
    q2:={i+If[l1[[i1,j]]<>l1[[i,j]],(k-l1[[i,j]])/(l1[[i1,j]]-l1[[i,j]]),.5],j};
    q3:={i1,j+If[l1[[i1,j1]]<>l1[[i1,j]],(k-l1[[i1,j]])/(l1[[i1,j1]]-l1[[i1,j]]),.5]}];
  Clear[contl,contb];
  contl[_][_]={{}};
  contb[_][_]={{}};
  Table[
    i1=i+1;
    j1=j+1;
    {min,max}=MinMax[{f0,f1,f2,f3}={l1f[[i,j]],l1f[[i,j1]],l1f[[i1,j]],l1f[[i1,j1]]}];
    {m0,m1,m2,m3}={{i,j},{i,j1},{i1,j},{i1,j1}};
    If[cf<=>Null,
      If[i==1,
        Do[CP$AddLine[{m0,m0,m1},k,contb],{k,1,min}]];
      If[i1==nx,
        Do[CP$AddLine[{m0,m3,m2},k,contb],{k,1,min}]];
      If[j==1,
        Do[CP$AddLine[{m0,m2,m0},k,contb],{k,1,min}]];
      If[j1==ny,
        Do[CP$AddLine[{m1,m1,m3},k,contb],{k,1,min}]]];
    Do[
      If[cf<=>Null &&(i==1 || i1==nx || j==1 || j1==ny),
        CP$AddLine[#,k,contb]&/@bc[f0>=k,f1>=k,f2>=k,f3>=k]];
      CP$AddLine[#,k,contl]&/@fc[f0>=k,f1>=k,f2>=k,f3>=k],
      {k,min+1,max}],
    {i,nx-1},{j,ny-1}];
  {gp,gl}=CP$GetLine[l1,n,cf];
  g=Flatten[{
    If[cf<=>Null,
      Rectangle[mesh[{1,1}],mesh[{nx,ny}],PlotColor->cf[0],
        FillColor->cf[0]],
      Null[]],
    Polygon[Thread[mesh[Thread[#]]],PlotColor->cf[#2/n],
        FillColor->cf[#2/n]]&@@[gp,{1}],
    Line[Thread[mesh[Thread[#]]],PlotColor->lc[#2/n]]&@@[gl,{1}]
    }];
  Clear[contl,contb];
  g];

fc[1,0,0,0]:={{m0,q0,q2}};
fc[0,1,0,0]:={{m1,q1,q0}};
fc[1,1,0,0]:={{m0,q1,q2}};
fc[0,0,1,0]:={{m2,q2,q3}};
fc[1,0,1,0]:={{m2,q0,q3}};
fc[0,1,1,0]:={{m1,q1,q0},{m2,q2,q3}};
fc[1,1,1,0]:={{m2,q1,q3}};
fc[0,0,0,1]:={{m3,q3,q1}};
fc[1,0,0,1]:={{m0,q0,q2},{m3,q3,q1}};
fc[0,1,0,1]:={{m1,q3,q0}};
fc[1,1,0,1]:={{m0,q3,q2}};
fc[0,0,1,1]:={{m3,q2,q1}};
fc[1,0,1,1]:={{m3,q0,q1}};
fc[0,1,1,1]:={{m1,q2,q0}};
fc[___]={};

bc[1,0,0,0]:={If[m0[[1]]==1,{m0,m0,q0},Null[]],If[m0[[2]]==1, {m0,q2,m0},Null[]]};
bc[0,1,0,0]:={If[m1[[1]]==1,{m1,q0,m1},Null[]],If[m1[[2]]==ny,{m1,m1,q1},Null[]]};
bc[1,1,0,0]:={If[m0[[1]]==1,{m0,m0,m1},Null[]],
  If[m0[[2]]==1,{m0,q2,m0},Null[]],If[m1[[2]]==ny,{m0,m1,q1},Null[]]};
bc[0,0,1,0]:={If[m2[[1]]==nx,{m2,q3,m2},Null[]],If[m2[[2]]==1,{m2,m2,q2},Null[]]};
bc[1,0,1,0]:={If[m2[[1]]==nx,{m2,q3,m2},Null[]],
  If[m2[[2]]==1,{m2,m2,m0},Null[]],If[m0[[1]]==1,{m2,m0,q0},Null[]]};
bc[0,1,1,0]:=Join[bc[0,1,0,0],bc[0,0,1,0]];
bc[1,1,1,0]:={If[m2[[2]]==1,{m2,m2,m0},Null[]],
  If[m2[[1]]==nx,{m2,q3,m2},Null[]],If[m1[[1]]==1,{m2,m0,m1},Null[]],If[m1[[2]]==ny,{m2,m1,q1},Null[]]};
bc[0,0,0,1]:={If[m3[[1]]==nx,{m3,m3,q3},Null[]],If[m3[[2]]==ny,{m3,q1,m3},Null[]]};
bc[1,0,0,1]:=Join[bc[1,0,0,0],bc[0,0,0,1]];
bc[0,1,0,1]:={If[m1[[2]]==ny,{m1,m1,m3},Null[]],
  If[m1[[1]]==1,{m1,q0,m1},Null[]],If[m3[[1]]==nx,{m1,m3,q3},Null[]]};
bc[1,1,0,1]:={If[m0[[1]]==1,{m0,m0,m1},Null[]],If[m0[[2]]==1,{m0,q2,m0},Null[]],
  If[m3[[2]]==ny,{m0,m1,m3},Null[]],If[m3[[1]]==nx,{m0,m3,q3},Null[]]};
bc[0,0,1,1]:={If[m3[[1]]==nx,{m3,m3,m2},Null[]],
  If[m3[[2]]==ny,{m3,q1,m3},Null[]],If[m2[[2]]==1,{m3,m2,q2},Null[]]};
bc[1,0,1,1]:={If[m3[[1]]==nx,{m3,m3,m2},Null[]],If[m3[[2]]==ny,{m3,q1,m3},Null[]],
  If[m0[[1]]==1,{m3,m0,q0},Null[]],If[m0[[2]]==1,{m3,m2,m0},Null[]]};
bc[0,1,1,1]:={If[m1[[2]]==ny,{m1,m1,m3},Null[]],If[m1[[1]]==1,{m1,q0,m1},Null[]],
  If[m2[[2]]==1,{m1,m2,q2},Null[]],If[m2[[1]]==nx,{m1,m3,m2},Null[]]};
bc[___]={};

CP$AddLine[{_,x_,x_},__]:=Null;
CP$AddLine[{c_,x_,y_},k_,cont_]:=Module[{lx=First[cont[k][x]],ly=First[cont[k][y]],a},
  If[lx<=>{},
    If[ly<=>{},
      If[Last[lx]===y,
        cont[k][x]={Append[lx,x],c};
        cont[k][y]=.,
        cont[k][Last[lx]]={a=Join[Reverse[lx],ly],c};
        cont[k][Last[a]]={Reverse[a],c};
        cont[k][x]=.;
        cont[k][y]=.],
      cont[k][y]={a=Prepend[lx,y],c};
      cont[k][Last[a]]={Reverse[a],c};
      cont[k][x]=.],
    If[ly<=>{},
      cont[k][x]={a=Prepend[ly,x],c};
      cont[k][Last[a]]={Reverse[a],c};
      cont[k][y]=.,
      cont[k][x]={{x,y},c};
      cont[k][y]={{y,x},c}]]];

CP$JoinLine[{l:{x_,___,x_},c_},k_]:={k,l,c};
CP$JoinLine[{l:{x_,m___,y_},c_},k_]:=Module[{lx=First[contb[k][x]],ly=First[contb[k][y]],a},
  If[lx<=>{},
    If[ly<=>{},
      If[Last[lx]===y,
        contb[k][x]={Join[lx,Reverse[{x,m}]],c};
        contb[k][y]=.,
        contb[k][Last[lx]]={a=Join[Reverse[lx],{m},ly],c};
        contb[k][Last[a]]={Reverse[a],c};
        contb[k][x]=.;
        contb[k][y]=.],
      contb[k][Last[lx]]={a=Join[Reverse[lx],{m,y}],c};
      contb[k][y]={Reverse[a],c};
      contb[k][x]=.],
    If[ly<=>{},
      contb[k][x]={a=Join[{x,m},ly],c};
      contb[k][Last[a]]={Reverse[a],c};
      contb[k][y]=.,
      contb[k][x]={l,c};
      contb[k][y]={Reverse[l],c}]];
  Null[]];

CP$GetLine[l1_,n_,cf_]:=Module[{
  l=(Hold/@[Delete[(?contl),{{1,1},{1,-1}}],{2}])[[1]],ls,lc,ls1,k},
  Scan[If[contl[#[[1,1,0,1]]][#[[1,2,1,1]]]<=>{{}} &&
    #[[1,2,1,1]]<=>#[[1,2,1,-1]],contl[#[[1,1,0,1]]][#[[1,2,1,-1]]]=.]&,l];
  l=(Hold/@[Delete[(?contl),{{1,1},{1,-1}}],{2}])[[1]];
  ls=If[cf<=>Null,
    lc=CP$JoinLine[#[[1,2]],#[[1,1,0,1]]]&/@l;
    {ls1,lc}=Drop[#,-1]&/@[SelectCases[lc,{CP$Inside[#[[3]],#[[2]]]&,True&}],{2}];
    ls1=SwitchCases[ls1,Table[{k,_},{k,n}]];
    ls1=Sort[#,CP$InsideC[#[[2]],#2[[2]]]&]&/@ls1;
    ls=(Hold/@[Delete[(?contb),{{1,1},{1,-1}}],{2}])[[1]];
    ls=SwitchCases[{#[[1,1,0,1]],#[[1,2,1]]}&/@ls,Table[{k,_},{k,n}]];
    ls=Sort[#,CP$InsideC[#[[2]],#2[[2]]]&]&/@ls;
    ls=MapThread[Join,{ls1,ls}];
    Sort[CP$FindNest[lc,ls]],
    {}];
  {Polygon[#[[2]],#[[1]]]&/@ls,
  Line[#[[1,2,1]],#[[1,1,0,1]]]&/@l}];

CP$FindNest[lc_,ls0_]:=Module[{n=Length[lc],i,j,m,u,p,k,d1,
  ls=ls0},
  Join[
    Table[
      {k,u}=lc[[i]];
      p=Position[ls[[k]],_?(CP$InsideC[u,#[[2]]]&),1,1];
      If[p<=>{},
        p=p[[1,1]];
        l=ls[[k,p,2]];
        ls[[k]]=Delete[ls[[k]],p];
        d1=Infinity;
        Do[If[(d=Plus@@Abs[l[[1]]-u[[j]]])<d1,m=j;d1=d],{j,Length[u]}];
        u=Append[RotateLeft[Drop[u,-1],m-1],u[[m]]];
        {k,Join[Reverse[l],u]},
        Print["CP$FindNest irregular contour ",{k,u}];{k,u}],
      {i,n}],Flatten[ls,1]]];

CP$Inside[p_,l_]:=Module[{
  cp=Complex@@p,c,c1},
  c=Complex@@[l,{1}]-cp;
  c1=RotateRight[c];
  Abs[Im[Plus@@Log[c/c1]]]>Pi];

CP$InsideC[l1_,l2_]:=Module[{
  p1=Cases[l1,_?(Position[l2,#,1,1]==={}&),1,1]},
  If[p1<=>{},
    CP$Inside[p1[[1]],l2],
    True]];

CP$PlotRange[Automatic,l_]:=MinMax[l];
CP$PlotRange[{Automatic,Automatic},l_]:=MinMax[l];
CP$PlotRange[{Automatic,max_},l_]:={Min[l],max};
CP$PlotRange[{min_,Automatic},l_]:={min,Max[l]};
CP$PlotRange[x_,_]:=x;

CP$MeshRange[Default,l_]:=Thread[{{1,1},Dimensions[l]}];
CP$MeshRange[x_,_]:=x;

CP$Color[x_]:=RGBColor[Restrict[x*3-2,0,1],Restrict[x*3-1,0,1],Restrict[x*3,0,1]];
CP$ContourColor[x_]:=RGBColor[1-Restrict[x*3-2,0,1],1-Restrict[x*3-1,0,1],1-Restrict[x*3,0,1]];

CP$NullColor[x_]:=RGBColor[Restrict[x*3-2,0,1],Restrict[x*3-1,0,1],Restrict[x*3,0,1]];

End[];

EndPackage[];

SetAttributes[
  {ColumnPlot,Plot,FitPlot,HistoPlot,ListContourPlot,ListDensityPlot},Constant];
