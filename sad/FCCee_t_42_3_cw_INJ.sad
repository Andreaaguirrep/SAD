! FCCee-t, from 7_syk3ch
! Solenoid
! from FCCee_t_8_8, 9_5 15_2 15_4 16 17_5 18_2 18_10 19_5 19_11 23_1 25_6 30_8 32_5 32_17 35_5 35 35_8 35_12 35_13
! 37_8 37_16 37_20 39_1 41 41_6 41_8 41_10
! Skew sexts
! better QK?
! smaller dispersion (2) + adjust emit
! thinner SY,QK
! independent SY1/SY2
! Crab waist
! improve IR
! More sk2, factor 1/2 in kcw?
! Reverse CHI1 of ES, reverse kcw
! Width Point
! thetax = 15 mrad, bx* =0.5, MINCOUP=0.1%
! Optimize Tune
! shorter qc2;
! Adjusted rf freq/bunch length
! reduce exsy1;
! fit to two tunnels at IR, longer arc at the "R" side, geometry matching of IR.
! longer QC{12}
! Smooth qg region.
! Cross over at rf;
! Outer arc; 2440 bends.
! DXM/DPXM matching;
! Better rf section.
! bx* 1 m.
! Thicker quads for radiation.
! Local solenoid compensation.
! by* = 1 mm.
! better rf section
! 2520 bends
! shorter qd 2480 bends
!
MOMENTUM= 175 GEV;
ON ECHO;OFF EMIT COD CTIME    RAD RFSW;

 ;
 DRIFT  LRF     =(L =20 )    LXH0    =(L =91.66666666666669 )   LF03    =(L =.3 )    LI3     =(L =1.9362642881942125 )
        LI4     =(L =113.74056539211992 )  LI5     =(L =86.09944582830867 )   LXSX    =(L =.8999999999999999 )
        LL2     =(L =20.859071452058448 )  LL3     =(L =43.995797094851575 )  LL4     =(L =18.473308386948027 )
        LB6     =(L =28.151460324851385 )  LB5     =(L =156.9281377789404 )   LB4     =(L =128.25521541199777 )
        LB3     =(L =206.061780529889 )    LB2     =(L =207.7060855108669 )   LB1     =(L =119.45427344885765 )
        LY1     =(L =58.83980664869895 )   LC5     =(L =114.99906726949885 )  LC4     =(L =66.80477210619826 )
        LC2     =(L =51.89925733212388 )   LX3     =(L =.2 )    LX2     =(L =1 )     LX1     =(L =1 )
        LA1     =(L =11.70956170658229 )   LA2     =(L =30.23362445934303 )   LA3     =(L =17.329910209666117 )
        LA4     =(L =12.894643408803578 )  LA5     =(L =31.449556093605498 )  LA6     =(L =10.00622228107329 )
        LS4     =(L =2.3502682683807454 )  LS3     =(L =55.82155172382047 )   LS2     =(L =16.85879899392879 )
        LH3     =(L =32.16691753618381 )   LU5     =(L =15.625851765071543 )  LU4     =(L =74.88969018077093 )
        LU3     =(L =161.457103548496 )    LU2     =(L =2.7951520448230553 )  LXSEP   =(L =50 )
 ;
 BEND   BSEP    =(L =50   ANGLE =.00042857142857142855  E2 =1     EPS =100 )
        BI1     =(L =38.95036643623673   ANGLE =.003670763911697407    E1 =.5    E2 =.5    EPS =100 )
        BI2     =(L =27.444153575149308  ANGLE =-.002154582544398148   E1 =.5    E2 =.5    EPS =100 )
        BI3     =(L =23.11860532420444   ANGLE =.002595197083503133    E1 =.5    E2 =.5    EPS =100 )
        BI4     =(L =58.98550022897185   ANGLE =-.0017306160198007174  E1 =.5    E2 =.5    EPS =100 )
        B1      =(L =31.237096774193553  ANGLE =.0025093338595731022   E1 =.5    E2 =.5    EPS =100 )
        BL      =(L =44.47901234567902   ANGLE =.0008652687822849412   E1 =.5    E2 =.5    EPS =100 )
        BC3L    =(L =60   ANGLE =-.0016743498549839414  E1 =.5    E2 =.5    EPS =100 )
        BC1L    =(L =125.52197347083938  ANGLE =-.00105581503541793    E1 =.5    E2 =.5    EPS =100 )
        BWL     =(L =14.971920279803937  ANGLE =-.00012593475152912533 E1 =.5    E2 =.5    EPS =100 )
        BW      =(L =14.971920279803937  ANGLE =.00012593475152912533  E1 =.5    E2 =.5    EPS =100 )
        BC1     =(L =125.52197347083938  ANGLE =.00105581503541793     E1 =.5    E2 =.5    EPS =100 )
        BC3     =(L =60   ANGLE =.0016743498549839414   E1 =.5    E2 =.5    EPS =100 )
        BS      =(L =44.47901234567902   ANGLE =.0023178170790936446   E1 =.5    E2 =.5    EPS =100 )
        BG1     =(L =39.372759760416976  ANGLE =.0024624310639205986   E1 =.5    E2 =.5    EPS =100 )
        BG2     =(L =36.41499691999949   ANGLE =.001676702641276792    E1 =.5    E2 =.5    EPS =100 )
        B2      =(L =31.23910424128121   ANGLE =.0025093338595731022   E1 =.5    E2 =.5    EPS =100 )
        BWR     =(L =30   ANGLE =.0003   E1 =.5    E2 =.5    EPS =100 )
 ;
 QUAD   QRF     =(L =1.5  K1 =.015230011506814755 )
        QRDL5   =(L =1.5  K1 =-.03627528690951573 )
        QRFL5   =(L =3    K1 =.023353927286357656 )
        QRDL4   =(L =1.5  K1 =-.024590024277413622 )
        QRFL4   =(L =3    K1 =.020446750487076986 )
        QRDL3   =(L =1.5  K1 =-.02221452622591624 )
        QRFL3   =(L =3    K1 =.012566078836490866 )
        QRDL2   =(L =1.5  K1 =-3.969901684341908e-05 )
        QRFL2   =(L =3    K1 =.003902917792213035 )
        QRDL1   =(L =1.5  K1 =-.01838570115448201 )
        QRFL1   =(L =3    K1 =.016126270007340106 )
        QI1     =(L =3    K1 =-.014034390755691795 )
        QI2     =(L =3    K1 =.016828101749968467 )
        QI5     =(L =3    K1 =-.010325905597028513 )
        QI6     =(L =3    K1 =.024022266852913986 )
        QI7     =(L =3    K1 =-.025750503504121162 )
        QI8     =(L =3    K1 =.020521298364866526 )
        QD1     =(L =1.5  K1 =-.04081874831391347 )
        QF2     =(L =3    K1 =.04110227179472377 )
        QL3     =(L =3    K1 =-.04272818676205546 )
        QL4     =(L =3    K1 =.018204180692280098 )
        QL5     =(L =3    K1 =-.018034562721992123 )
        QB6     =(L =3    K1 =.010333273136485967 )
        QB5     =(L =3    K1 =-.00636308380113611 )
        QB4     =(L =3    K1 =.003507147281132471 )
        QB3     =(L =3    K1 =-.00014614667840681713 )
        QB2     =(L =3    K1 =.008351920999334073 )
        QB1     =(L =3    K1 =-.016050230511601402 )
        QY2     =(L =3    K1 =.0234692027712002 )
        QY1     =(L =3    K1 =-.022878467724118116 )
        QC7     =(L =3    K1 =-.018812501616213027 )
        QC6     =(L =3    K1 =.012763615697492011 )
        QC5     =(L =3    K1 =-.014445101612878796 )
        QC4     =(L =3    K1 =.02147841139558158 )
        QC3     =(L =3    K1 =-.016883945646757298 )
        QA1     =(L =3    K1 =-.03578395817745961 )
        QA2     =(L =3    K1 =.02654412986873266 )
        QA3     =(L =3    K1 =-.0008481022145514824 )
        QA4     =(L =3    K1 =.00375976311454476 )
        QA5     =(L =3    K1 =-.0011173007685190259 )
        QA6     =(L =3    K1 =.023608280601800237 )
        QS5     =(L =3    K1 =-.032709787890573036 )
        QS4     =(L =3    K1 =.027246041464646594 )
        QS3     =(L =3    K1 =-.03611710819573337 )
        QFG2    =(L =3    K1 =.03324136630783524 )
        QDG1    =(L =1.5  K1 =-.033054024488839456 )
        QG2     =(L =3    K1 =.03440860852293399 )
        QG3     =(L =1.5  K1 =-.02877980745711718 )
        QG4     =(L =3    K1 =.03223422409112288 )
        QG5     =(L =1.5  K1 =-.0349828105775511 )
        QG6     =(L =3    K1 =.03535434030294737 )
        QG7     =(L =1.5  K1 =-.041645900960000044 )
        QF4     =(L =3    K1 =.04109987350621502 )
        QD3     =(L =1.5  K1 =-.04081638223166731 )
        QH6     =(L =3    K1 =.04351866098302665 )
        QH5     =(L =3    K1 =-.04994130765680969 )
        QH4     =(L =3    K1 =.04137308185881238 )
        QU5     =(L =3    K1 =-.0279429726037712 )
        QU4     =(L =3    K1 =.01733331162480996 )
        QU3     =(L =3    K1 =-.04513344698153004 )
        QU2     =(L =3    K1 =.0435264906546867 )
        QRFR1   =(L =3    K1 =.01643670429452329 )
        QRDR1   =(L =1.5  K1 =-.018703930810618875 )
        QRFR2   =(L =3    K1 =.003962907938845026 )
        QRDR2   =(L =1.5  K1 =-4.0232427041243266e-05 )
        QRFR3   =(L =3    K1 =.012710662073401643 )
        QRDR3   =(L =1.5  K1 =-.022427319434047716 )
        QRFR4   =(L =3    K1 =.020603288270171567 )
        QRDR4   =(L =1.5  K1 =-.024731082916094174 )
        QRFR5   =(L =3    K1 =.023443153893261418 )
        QRDR5   =(L =1.5  K1 =-.03634451792367245 )
 ;
 MULT   SD63    =(L =.3   K2 =-.34547892199372526 )
        SF64    =(L =.3   K2 =.034601944318592884 )
        SD64    =(L =.3   K2 =-1.2636595448228043 )
        SF65    =(L =.3   K2 =.6078365666850113 )
        SD65    =(L =.3   K2 =-.5423594338432134 )
        SF66    =(L =.3   K2 =.1761423038115282 )
        SD66    =(L =.3   K2 =-.7539401889013241 )
        SF67    =(L =.3   K2 =.27577006486982125 )
        SD67    =(L =.3   K2 =-.5224234926057039 )
        SF68    =(L =.3   K2 =.8588644502246155 )
        SD68    =(L =.3   K2 =-1.5339325811259292 )
        SF69    =(L =.3   K2 =.01934418632282702 )
        SD69    =(L =.3   K2 =-1.4760482901770748 )
        SF70    =(L =.3   K2 =.5407636666053174 )
        SD70    =(L =.3   K2 =-.32941653365244494 )
        SF71    =(L =.3   K2 =.01063124942796844 )
        SD71    =(L =.3   K2 =-1.2108776288073968 )
        SF72    =(L =.3   K2 =.5010169402012946 )
        SD72    =(L =.3   K2 =.26070360991535235 )
        SF73    =(L =.3   K2 =.0245857974671531 )
        SD73    =(L =.3   K2 =-1.7670673672912844 )
        SF74    =(L =.3   K2 =.5380976135988972 )
        SD74    =(L =.3   K2 =-.9956557788618624 )
        SF75    =(L =.3   K2 =.04775209618045819 )
        SD75    =(L =.3   K2 =-.5741467627870582 )
        SF76    =(L =.3   K2 =.6467574135695603 )
        SD76    =(L =.3   K2 =-.8932483970812566 )
        SF77    =(L =.3   K2 =.16623427346978 )
        SD77    =(L =.3   K2 =-1.1777770457881567 )
        SF78    =(L =.3   K2 =.6872528809855275 )
        SD78    =(L =.3   K2 =-.028113052495173593 )
        SF79    =(L =.3   K2 =.5015785067274933 )
        SD79    =(L =.3   K2 =-1.5573675307317614 )
        SF80    =(L =.3   K2 =.24325985085326549 )
        SD80    =(L =.3   K2 =-.732653819498516 )
        SF81    =(L =.3   K2 =.3705748146264248 )
        SD81    =(L =.3   K2 =-.005841189795616273 )
        SF82    =(L =.3   K2 =.013780155909603364 )
        SD82    =(L =.3   K2 =-.2807975620391644 )
        SF83    =(L =.3   K2 =.9856482105830014 )
        SD83    =(L =.3   K2 =-.1347923596457491 )
        SF84    =(L =.3   K2 =.5780389937324483 )
        SD84    =(L =.3   K2 =-.6480639232994162 )
        SF85    =(L =.3   K2 =.762932393975145 )
        SD85    =(L =.3   K2 =-.7308719000026108 )
        SF86    =(L =.3   K2 =.8829389116430956 )
        SD86    =(L =.3   K2 =-1.1714368366371026 )
        SF87    =(L =.3   K2 =.47886349328826466 )
        SD87    =(L =.3   K2 =-1.1538298178676079 )
        SF88    =(L =.3   K2 =.6758215744338624 )
        SD88    =(L =.3   K2 =-.2541825353058541 )
        SF89    =(L =.3   K2 =.02823186582830073 )
        SD89    =(L =.3   K2 =-1.5576553848515604 )
        SF90    =(L =.3   K2 =.4895911950338308 )
        SD90    =(L =.3   K2 =-.06887474132041792 )
        SF91    =(L =.3   K2 =.9517981204265386 )
        SD91    =(L =.3   K2 =-1.5751136734317703 )
        SF92    =(L =.3   K2 =.12534125155641265 )
        SD92    =(L =.3   K2 =-.8405399858290225 )
        SF93    =(L =.3   K2 =.8675750661416713 )
        SD93    =(L =.3   K2 =-.9816354790006556 )
        SF94    =(L =.3   K2 =.14838793571273004 )
        SD94    =(L =.3   K2 =-.09413153915343692 )
        SF95    =(L =.3   K2 =.9777255779559161 )
        SD95    =(L =.3   K2 =-1.2641747350316408 )
        SF96    =(L =.3   K2 =.06303600477707698 )
        SD96    =(L =.3   K2 =-1.555969631433969 )
        SF97    =(L =.3   K2 =.6171168807592132 )
        SD97    =(L =.3   K2 =-.43101964083651667 )
        SF98    =(L =.3   K2 =.2889070906240359 )
        SD98    =(L =.3   K2 =-1.5078848278084052 )
        SF99    =(L =.3   K2 =.8103800469890524 )
        SD99    =(L =.3   K2 =-.07181800191170164 )
        SF100   =(L =.3   K2 =.6693880349491715 )
        SD100   =(L =.3   K2 =-1.3666599845474678 )
        SF101   =(L =.3   K2 =.6221596844323368 )
        SD101   =(L =.3   K2 =-.01936479761333829 )
        SF102   =(L =.3   K2 =.8683815104617094 )
        SD102   =(L =.3   K2 =-1.1397838156098974 )
        SF103   =(L =.3   K2 =.976437533061148 )
        SD103   =(L =.3   K2 =-.2013252233695114 )
        SF104   =(L =.3   K2 =.636957484712762 )
        SD104   =(L =.3   K2 =-.2668106436431434 )
        SF105   =(L =.3   K2 =.9414059571079633 )
        SD105   =(L =.3   K2 =-1.5707359217799635 )
        SF106   =(L =.3   K2 =.2409836499068548 )
        SD106   =(L =.3   K2 =-1.34869003837548 )
        SF107   =(L =.3   K2 =.9762580720830071 )
        SD107   =(L =.3   K2 =-1.5754703227756508 )
        SF108   =(L =.3   K2 =.17858903800482173 )
        SD108   =(L =.3   K2 =-1.5735728993972575 )
        SF109   =(L =.3   K2 =.9577584795535511 )
        SD109   =(L =.3   K2 =-1.1226952100058893 )
        SF110   =(L =.3   K2 =.347058568378015 )
        SD110   =(L =.3   K2 =-1.5364055859490295 )
        SF111   =(L =.3   K2 =.8491206967307316 )
        SD111   =(L =.3   K2 =-1.3204045463107281 )
        SF112   =(L =.3   K2 =.0536148993778981 )
        SD112   =(L =.3   K2 =-1.5727209111208027 )
        SF113   =(L =.3   K2 =.4805915165495494 )
        SD113   =(L =.3   K2 =-.7392608740930939 )
        SF114   =(L =.3   K2 =.07788863326629679 )
        SD114   =(L =.3   K2 =-1.5655178375876422 )
        SF115   =(L =.3   K2 =.9675116920635768 )
        SD115   =(L =.3   K2 =-.9482825472400123 )
        SF116   =(L =.3   K2 =.660943271841219 )
        SD116   =(L =.3   K2 =-1.5782061953299769 )
        SF117   =(L =.3   K2 =.21677589788509813 )
        SD117   =(L =.3   K2 =-.6579883335577337 )
        SF118   =(L =.3   K2 =.7517867469614558 )
        SD118   =(L =.3   K2 =-1.5832867219842388 )
        SF119   =(L =.3   K2 =.06047235678687936 )
        SD119   =(L =.3   K2 =-.7896698690762183 )
        SF120   =(L =.3   K2 =.7477719203304843 )
        SD120   =(L =.3   K2 =-1.5790078400225267 )
        SF121   =(L =.3   K2 =.015599654094228766 )
        SD121   =(L =.3   K2 =-.44145874553614883 )
        SF122   =(L =.3   K2 =.9172842434616457 )
        SD122   =(L =.3   K2 =-1.5782988666180575 )
        SF123   =(L =.3   K2 =-9.395912537746187e-05 )
        SD123   =(L =.3   K2 =-1.4888664010618995 )
        SF124   =(L =.3   K2 =.8788905571536554 )
        SD124   =(L =.3   K2 =-.7953066326378978 )
        SF125   =(L =.3   K2 =.04528606967193006 )
        SY2L    =(L =.15  K2 =1.164102621074663 )
        SY1L    =(L =.15  K2 =1.6734871382471401 )
        QC2L2   =(L =1.25 K1 =.12884893683173004 )
        QC2L1   =(L =1.25 K1 =.12884893683173004 )
        QC1L2   =(L =1.6  K1 =-.2643362605944555 )
        QC1L1   =(L =1.6  K1 =-.2643362605944555 )
        QC1R1   =(L =1.6  K1 =-.2643362605944555 )
        QC1R2   =(L =1.6  K1 =-.2643362605944555 )
        QC2R1   =(L =1.25 ROTATE =-2.191727982468683e-17 DEG K1 =.12884893683173004 )
        QC2R2   =(L =1.25 ROTATE =1.7486544814615628e-20 DEG K1 =.12884893683173004 )
        SY1R    =(L =.15  K2 =-1.6726315486866157 )
        SY2R    =(L =.15  K2 =-1.1632470315141386 )
        SF1     =(L =.3   K2 =.3842150074483254 )
        SD1     =(L =.3   K2 =-.12735907777398542 )
        SF2     =(L =.3   K2 =.23578705962625135 )
        SD2     =(L =.3   K2 =-.864338089517505 )
        SF3     =(L =.3   K2 =.2704212143151208 )
        SD3     =(L =.3   K2 =-.006489194822358293 )
        SF4     =(L =.3   K2 =.058631421253587224 )
        SD4     =(L =.3   K2 =-1.277231770042154 )
        SF5     =(L =.3   K2 =.31496817557042844 )
        SF6     =(L =.3   K2 =.9858236919795015 )
        SD5     =(L =.3   K2 =-1.3684389024437682 )
        SF7     =(L =.3   K2 =.627720549485982 )
        SD6     =(L =.3   K2 =-.3066907653575261 )
        SF8     =(L =.3   K2 =.9372003856497474 )
        SD7     =(L =.3   K2 =-1.3892671598121022 )
        SF9     =(L =.3   K2 =.01792864753548367 )
        SD8     =(L =.3   K2 =-1.5812856301577567 )
        SF10    =(L =.3   K2 =.7987552760638682 )
        SD9     =(L =.3   K2 =-1.5768500655662405 )
        SF11    =(L =.3   K2 =.8286541582993734 )
        SD10    =(L =.3   K2 =-1.5824508429289275 )
        SF12    =(L =.3   K2 =.47936859344526095 )
        SD11    =(L =.3   K2 =-.45041018842808583 )
        SF13    =(L =.3   K2 =.4820598457073817 )
        SD12    =(L =.3   K2 =-1.5815264799687916 )
        SF14    =(L =.3   K2 =.4966223324557033 )
        SD13    =(L =.3   K2 =-.5999414760328239 )
        SF15    =(L =.3   K2 =.9814483755152451 )
        SD14    =(L =.3   K2 =-1.5585965099170915 )
        SF16    =(L =.3   K2 =.030683837872645472 )
        SD15    =(L =.3   K2 =-.27374932376802197 )
        SF17    =(L =.3   K2 =.9771249850842071 )
        SD16    =(L =.3   K2 =-.016278515267553927 )
        SF18    =(L =.3   K2 =.9858275864559732 )
        SD17    =(L =.3   K2 =-.25972424683617534 )
        SF19    =(L =.3   K2 =.13350496127161193 )
        SD18    =(L =.3   K2 =-1.4176879746229034 )
        SF20    =(L =.3   K2 =.40216231502196137 )
        SD19    =(L =.3   K2 =-.6276239397724295 )
        SF21    =(L =.3   K2 =.9526727121948827 )
        SD20    =(L =.3   K2 =-.4861441044941361 )
        SF22    =(L =.3   K2 =.5299124604481972 )
        SD21    =(L =.3   K2 =-1.4475897464334346 )
        SF23    =(L =.3   K2 =.858744736315073 )
        SD22    =(L =.3   K2 =-.014826949866702018 )
        SF24    =(L =.3   K2 =.3129841233909171 )
        SD23    =(L =.3   K2 =-.3206983596604163 )
        SF25    =(L =.3   K2 =.7822687725460319 )
        SD24    =(L =.3   K2 =-.36590272854392264 )
        SF26    =(L =.3   K2 =.9268685884185214 )
        SD25    =(L =.3   K2 =-.01662817507071915 )
        SF27    =(L =.3   K2 =.5727012260041761 )
        SD26    =(L =.3   K2 =-.16922874181285608 )
        SF28    =(L =.3   K2 =.23301231297289968 )
        SD27    =(L =.3   K2 =-.016574959179612075 )
        SF29    =(L =.3   K2 =.4985617508171287 )
        SD28    =(L =.3   K2 =-.05066502641773259 )
        SF30    =(L =.3   K2 =.5127661157981457 )
        SD29    =(L =.3   K2 =-1.4861888229853826 )
        SF31    =(L =.3   K2 =.01883498486679921 )
        SD30    =(L =.3   K2 =-1.5358218861568853 )
        SF32    =(L =.3   K2 =.8935951190957122 )
        SD31    =(L =.3   K2 =-1.562981500224945 )
        SF33    =(L =.3   K2 =.358277498990472 )
        SD32    =(L =.3   K2 =-1.191070556719914 )
        SF34    =(L =.3   K2 =.8621815996870462 )
        SD33    =(L =.3   K2 =-.8719038991415565 )
        SF35    =(L =.3   K2 =.7220389588098425 )
        SD34    =(L =.3   K2 =-1.5526721405488082 )
        SF36    =(L =.3   K2 =.014331114207534515 )
        SD35    =(L =.3   K2 =-1.4088893205072661 )
        SF37    =(L =.3   K2 =.819642546358566 )
        SD36    =(L =.3   K2 =-1.0553013165201455 )
        SF38    =(L =.3   K2 =.45088580453048055 )
        SD37    =(L =.3   K2 =-1.5862115077068804 )
        SF39    =(L =.3   K2 =.5197439564531116 )
        SD38    =(L =.3   K2 =-1.5959916604503024 )
        SF40    =(L =.3   K2 =.1829312174261268 )
        SD39    =(L =.3   K2 =-1.588441145633347 )
        SF41    =(L =.3   K2 =.9763691246463403 )
        SD40    =(L =.3   K2 =-1.4474763023598742 )
        SF42    =(L =.3   K2 =.9737329374470834 )
        SD41    =(L =.3   K2 =-1.097928884481625 )
        SF43    =(L =.3   K2 =.02102197231057856 )
        SD42    =(L =.3   K2 =-1.5590499661777364 )
        SF44    =(L =.3   K2 =.12490600292001923 )
        SD43    =(L =.3   K2 =-1.0451550902143154 )
        SF45    =(L =.3   K2 =.16769840148491133 )
        SD44    =(L =.3   K2 =-1.5850017807857884 )
        SF46    =(L =.3   K2 =.4260816049103877 )
        SD45    =(L =.3   K2 =-1.2205041988294927 )
        SF47    =(L =.3   K2 =.6853379434008524 )
        SD46    =(L =.3   K2 =-1.5329219335801787 )
        SF48    =(L =.3   K2 =.17536137837328145 )
        SD47    =(L =.3   K2 =-.6329631373155 )
        SF49    =(L =.3   K2 =.9797992146076807 )
        SD48    =(L =.3   K2 =-1.5666330610360977 )
        SF50    =(L =.3   K2 =.9737683248201464 )
        SD49    =(L =.3   K2 =-.28972540633080973 )
        SF51    =(L =.3   K2 =.3640775627889318 )
        SD50    =(L =.3   K2 =-1.583646790927549 )
        SF52    =(L =.3   K2 =.9407243802364594 )
        SD51    =(L =.3   K2 =-.36303766868445575 )
        SF53    =(L =.3   K2 =.4071864008340985 )
        SD52    =(L =.3   K2 =-1.5958449598664208 )
        SF54    =(L =.3   K2 =.35271022267735164 )
        SD53    =(L =.3   K2 =-1.5901446095268903 )
        SF55    =(L =.3   K2 =.9485980126069445 )
        SD54    =(L =.3   K2 =-1.5700984925737396 )
        SF56    =(L =.3   K2 =.8193288117144734 )
        SD55    =(L =.3   K2 =-.9281874884782395 )
        SF57    =(L =.3   K2 =.7175189691812046 )
        SD56    =(L =.3   K2 =-1.6788123115989235 )
        SF58    =(L =.3   K2 =.4114445635130305 )
        SD57    =(L =.3   K2 =-1.1531164970637298 )
        SF59    =(L =.3   K2 =.034439347218730404 )
        SD58    =(L =.3   K2 =-1.5788986860066256 )
        SF60    =(L =.3   K2 =.29580130759744294 )
        SD59    =(L =.3   K2 =-.8509162140148756 )
        SF61    =(L =.3   K2 =.6715530463716985 )
        SD60    =(L =.3   K2 =-1.5866508061405245 )
        SF62    =(L =.3   K2 =.09043030313410878 )
        SD61    =(L =.3   K2 =-1.5537726078005396 )
        SF63    =(L =.3   K2 =.03749554348561615 )
        SD62    =(L =.3   K2 =-.36099942551288017 )
 ;
 SOL    ES3L    =(BZ =0   DX =-.03000219149072553  DY =3.394659937371677e-14     DZ =.0002250210956802542 BOUND =1
           CHI1 =.014999911932345148     CHI2 =-1.69694146889447e-14   CHI3 =-2.545603126440053e-16  F1 =.3 )
        ES2L    =(BZ =2   F1 =.1 )
        ES1L    =(BZ =-2  DPX =-.015     BOUND =1  CHI1 =-.014999999999999998    GEO =1 )
        ES1R    =(BZ =2   DPX =-.015     BOUND =1  CHI1 =.015     CHI2 =6.626431603856499e-29   CHI3 =1.0846837446788912e-30
           GEO =1 )
        ES2R    =(BZ =-2  F1 =.1 )
        ES3R    =(BZ =0   DX =.03000219149072553   DY =3.394659937371677e-14     DZ =.0002250210956802542 BOUND =1
           CHI1 =-.014999911932345148    CHI2 =-1.6971323927087742e-14 CHI3 =1.494624698070502e-21   F1 =.3 )
 ;
 CAVI   CA1     =(VOLT =2.4e+08     PHI =-.761254676853327   FREQ =4e+08 )
 ;
 MARK   FRF     =(AX =-4.2519213510480375e-14 BX =170.8108773552425    AY =-2.2163820308215056e-14   BY =19.63179032620971
           EX =-4.655357504340835e-14    EPX =1.2713107923590524e-15   EY =3.2317467817168614e-15    EPY =3.621271452448223e-16
           R1 =-1.1199751693800887e-11   R2 =4.78521093600925e-09 R3 =-2.449239739104094e-12    R4 =2.3681373516047203e-10
           DX =2.7619601001183697e-17    DPX =1.8364597161560717e-19   DY =-2.4414614826436515e-20   DPY =-7.519563522140037e-21
           DZ =-.0012958276449744066     DP =.02   SIGZ =.0023832309761653942    EMITX =1.961356238814422e-09
           EMITY =3.973336145744055e-15 )
        F0      =(AX =-2.3163858633811674     BX =110.4516605185417    PSIX =7.4795804919060425 AY =.564170901003033
           BY =22.633652149514422   PSIY =8.958359876214347  EX =.22853298920451415   EPX =.004835850035545034
           EY =-4.966006811853056e-12    EPY =3.3435612508570365e-13   R1 =-2.5713221908471363e-12   R2 =-9.054327037355845e-10
           R3 =9.002894172100484e-12     R4 =-3.5638923368047017e-10   DX =-3.1364759985604632e-09   DPX =5.3918855214774956e-11
           DY =1.5709467098843948e-09    DPY =-4.1300772893921585e-11  DZ =-2.8330359494446654e-10   DDP =.008875261168867658
           DP =.02   EMITX =1.961356238814422e-09  EMITY =3.973336145744055e-15 )
        PSDC    =(AX =.4988151318840254  BX =21.668486580121357   PSIX =8.308192105421725  AY =-2.4010200141717273
           BY =116.14745524279039   PSIY =9.643538488899718  EX =.11596940946986722   EPX =-.002326514859245839
           EY =-3.086767482094523e-11    EPY =-3.928396141394599e-13   R1 =-2.523877518528063e-10    R2 =6.823296786566453e-10
           R3 =-3.895999808502423e-12    R4 =-2.5395646635033427e-11   DX =1.0196570927045275e-07    DPX =-3.967643208447144e-09
           DY =2.8132516106394813e-09    DPY =7.761833082592727e-11    DZ =-3.9821639345489746e-10   DDP =.008859504016149836
           DP =.02   EMITX =1.961356238814422e-09  EMITY =3.973336145744055e-15 )
        PSFC    =(AX =-2.3336757169842715     BX =111.84667899261468   PSIX =12.189270340372863 AY =.5466975105373696
           BY =22.300391625975664   PSIY =13.657395187861622 EX =.2299837442153523    EPX =.004835850035547682
           EY =-1.7688872479109015e-11   EPY =5.230601209674152e-13    R1 =-2.472039972412617e-11    R2 =-2.483817880492275e-09
           R3 =3.2088711120986373e-12    R4 =-4.440279560370878e-11    DX =-3.2889032132773343e-07   DPX =-3.919555513959966e-09
           DY =-6.080272946390427e-11    DPY =-6.900412063309442e-11   DZ =-9.36996737197862e-10     DDP =.008780733015938638
           DP =.02   EMITX =1.961356238814422e-09  EMITY =3.973336145744055e-15 )
        PQY1    =(AX =-6.183942247162122e-13  BX =56.16365575813716    PSIX =500.4984218151537  AY =2.6937341246480173e-12
           BY =6.538955667959533    PSIY =502.4337621309983  EX =-.053687383915777084 EPX =.0022707410970063437
           EY =2.508301082319691e-12     EPY =-1.1627138687466765e-12  R1 =-1.7706774121752806e-11   R2 =6.855610415341938e-10
           R3 =-5.61649603640711e-15     R4 =-5.118976259332934e-10    DX =6.264769825591017e-08     DPX =8.332915965551994e-09
           DY =-8.252014189458975e-10    DPY =-2.813158626209829e-11   DZ =1.1080143533592414e-09    DDP =-.0007154853252007606
           DP =.02   OFFSET =1.5    EMITX =1.961356238814422e-09  EMITY =3.973336145744055e-15 )
        PQC2LE  =(AX =-3.068424867774289 BX =218.7750471823938    PSIX =503.84852062717056 AY =3.0440128816260668
           BY =4291.71928878199     PSIY =507.1457225453296  EX =-1.8295937579455083e-06   EPX =-4.366314508420442e-08
           EY =-1.0797142105134307e-13   EPY =7.279426365395662e-17    R1 =-2.482600126201809e-09    R2 =1.6561418467716184e-07
           R3 =1.6242335423854239e-12    R4 =-1.1200515837572355e-10   DX =1.1445616942881001e-07    DPX =-2.445332886945702e-09
           DY =-4.706964823893689e-09    DPY =8.251759962982366e-12    DZ =6.128703010771758e-10     DDP =-.0007197487391000101
           DP =.02   EMITX =1.961356238814422e-09  EMITY =3.973336145744055e-15 )
        IP      =(AX =3.925959266885149e-13   BX =1.0000000000001972   PSIX =505.21081079553863 AY =6.979373130255706e-13
           BY =.0010000000000005907 PSIY =508.71694743817574 EX =-2.1907092722582773e-14   EPX =1.1414480471271906e-15
           EY =1.1863821051167992e-17    EPY =9.583892789885168e-17    R1 =3.5835954747410117e-17    R2 =1.6410171871647093e-12
           R3 =-5.524571298140218e-09    R4 =8.875146718611702e-15     DX =6.041227227812067e-08     DPX =-4.960276991233803e-09
           DY =3.420372405157305e-11     DPY =-2.2406980684912906e-09  DZ =6.115578858029922e-10     DDP =-.0007228003274091207
           DP =.02   SIGZ =.001218123355690918     EMITX =1.961356238814422e-09  EMITY =3.973336145744055e-15 )
        PQC2RE  =(AX =-3.068424867774553 BX =218.7750471824647    PSIX =506.5731009639059  AY =3.044012881626145
           BY =4291.719288781969    PSIY =510.2881723310205  EX =1.8295936095007816e-06    EPX =4.3663145802350935e-08
           EY =-1.0837892545739672e-13   EPY =6.949095546828198e-17    R1 =2.482600965611119e-09     R2 =-1.656140711539678e-07
           R3 =-1.6242416412087464e-12   R4 =1.1200558426552907e-10    DX =2.5546953856684013e-07    DPX =-3.5617045567439563e-10
           DY =4.777618055899796e-09     DPY =-8.35466641691128e-12    DZ =6.102135684188619e-10     DDP =-.0007258519346222202
           DP =.02   EMITX =1.961356238814422e-09  EMITY =3.973336145744055e-15 )
        FG      =(AX =-2.334870763477241 BX =138.19480302355163   PSIX =515.9946035759011  AY =.5355905866873634
           BY =27.33143245898544    PSIY =521.5456544945552  EX =.27850376870576776   EPX =.004739266293910823
           EY =5.835760005972811e-12     EPY =-3.3035350411720355e-13  R1 =-1.0554082667566028e-12   R2 =1.2934498447979669e-09
           R3 =-7.304038809137036e-12    R4 =3.5958296851275243e-10    DX =-2.4035685361418103e-07   DPX =-2.5897590237413314e-09
           DY =1.7427869537036948e-09    DPY =-3.6775191223353555e-11  DZ =1.4022452336697564e-09    DDP =-.0007518039490979344
           DP =.02   EMITX =1.961356238814422e-09  EMITY =3.973336145744055e-15 )
        PSFGC   =(AX =-2.3558790040437705     BX =140.30564041893606   PSIX =515.997835267051   AY =.5144030482985259
           BY =26.858935323241788   PSIY =521.5622640071706  EX =.28063643853802445   EPX =.004739266293910762
           EY =5.687100909700403e-12     EPY =-3.303535041171991e-13   R1 =-4.342225707829181e-12    R2 =1.4572161822058682e-09
           R3 =-7.304038501949702e-12    R4 =3.628697859538251e-10     DX =-2.4152312240160633e-07   DPX =-2.5897646405620688e-09
           DY =1.7262256607712388e-09    DPY =-3.677527171026199e-11   DZ =1.4022423443326976e-09    DDP =-.0007518039490979344
           DP =.02   OFFSET =1.5    EMITX =1.961356238814422e-09  EMITY =3.973336145744055e-15 )
        PSDGC   =(AX =.47574791646649434 BX =26.268322388158126   PSIX =519.8918259722817  AY =-2.410565728620488
           BY =144.6558574091486    PSIY =525.5558840614168  EX =.13935771761442126   EPX =-.0022768339857280437
           EY =3.207797880638819e-11     EPY =5.809243849406049e-13    R1 =3.4158425613148506e-10    R2 =6.825315917053102e-09
           R3 =6.829277736409267e-12     R4 =1.6300481533173898e-10    DX =-7.222878382534575e-08    DPX =-9.7396361996618e-09
           DY =-2.4622955507286463e-09   DPY =-1.9111863366571663e-11  DZ =-8.65160549114011e-10     DDP =-.0008097255611338184
           DP =.02   OFFSET =1.5    EMITX =1.961356238814422e-09  EMITY =3.973336145744055e-15 )
        F1      =(AX =-2.3163914870345765     BX =110.45850418121054   PSIX =555.2294740000427  AY =.5641621877222509
           BY =22.634807396246728   PSIY =560.7803782772896  EX =.22854662896863714   EPX =.00483584810173262
           EY =1.7698455123957533e-11    EPY =-5.129042070969263e-13   R1 =1.9518291040091848e-11    R2 =2.7390233253308997e-09
           R3 =-3.0421754329188254e-12   R4 =3.767294762436841e-11     DX =6.345734498479092e-07     DPX =1.4770786670495993e-08
           DY =-1.0105826079804769e-11   DPY =-6.978542811031565e-11   DZ =1.2437045693987713e-09    DDP =-.0012958278352756456
           DP =.02   SIGZ =.0028684794437027037    EMITX =1.961356238814422e-09  EMITY =3.973336145744055e-15 )
 ;
    LINE FQCELL =(F0 LF03 PSFC SF1 LF03
       QF2 LXSX B1 LXSX
       QD1 LXSX B1 LXSX
       QF2 LXSX B1 LXSX
       QD1 LXSX B1 LF03 PSFC SF1 LF03
       QF2 LXSX B1 LF03 PSDC SD1 LF03
       QD1 LXSX B1 LXSX
       QF2 LXSX B1 LXSX
       QD1 LXSX B1 LXSX
       QF2 LXSX B1 LF03 PSDC SD1 LF03
       QD1 LXSX B1 )
     FQCELL2 =(F1 LF03 PSFGC SF1 LF03
       QF4 LXSX B2 LXSX
       QD3 LXSX B2 LXSX
       QF4 LXSX B2 LXSX
       QD3 LXSX B2 LF03 PSFGC SF1 LF03
       QF4 LXSX B2 LF03 PSDGC SD1 LF03
       QD3 LXSX B2 LXSX
       QF4 LXSX B2 LXSX
       QD3 LXSX B2 LXSX
       QF4 LXSX B2 LF03 PSDGC SD1 LF03
       QD3 LXSX B2 )
     FQCELLG =(FG LF03 PSFGC SF1 LF03
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LXSX
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LF03 PSFGC SF1 LF03
       QFG2 LXSX BG1 LF03 PSDGC SD1 LF03
       QDG1 LXSX BG1 LXSX
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LXSX
       QFG2 LXSX BG1 LF03 PSDGC SD1 LF03
       QDG1 LXSX BG1 )
     FQCELLG1 =(FG LF03 PSFGC SF1 LF03
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LXSX
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LF03 PSFGC SF1 LF03
       QG2 LXSX BG2 LF03 LXSX 
       QG3 LXSX BG2 LXSX
       QG4 LXSX BG2 LXSX
       QG5 LXSX BG2 LXSX
       QG6 LXSX BG2 LF03 LXSX 
       QG7 LXSX BG2 F1)
     RFCELL = (FRF QRF LRF CA1 LRF FRD QRD LRF CA1 LRF QRF)
     DSUPP = (F1 LF03 QH6 LH3 QH5 LF03 B2 LF03 QH4 LF03 BWR LU5 QU5 LU4 QU4 LU3 QU3 LU2 QU2 LXH0 LXSEP)
     DSUPP1 = (F0 LF03 QI8 LF03 BI4 LF03  QI7 LF03 BI3 LF03  QI6 LI5  QI5 LI4 BI2 LI3  QI2 LF03 BI1 LF03 QI1  LXH0 BSEP)
     DSUPPC = (
       LS2 QS3 LS3 QS4 LS4 LF03 BS LF03 QS5 LF03 BS)
     DSUPPL = (
       LL2 QL3 LL3 QL4 LL4 LF03 BL LF03 QL5 LF03 BL)
     ARCG=(-FQCELLG1 -FQCELLG -FQCELLG -FQCELLG -FQCELLG DSUPPC)
     COL = (IP ES1R LX1 ES2R LX2 ES3R LX3 QC1R1 QC1R2 LF03 QC2R1 QC2R2 PQC2RE
       LC2   QC3  LF03 BW LF03 QC4 LF03 BC1 LF03  QC5 LC4  QC6  LC5  QC7 LF03 SY1R SY1R
       LY1 QY2 LF03 BC3 LF03 PQY1 QY1 LF03 BC3 LF03 QY2 LY1 SY2R SY2R
       LF03 QA1 LA1 
       QA2 LA2 QA3 LA3 QA4 LA4 QA5 LA5 QA6 LA6 -ARCG)
     COLL = (IP ES1L LX1 ES2L LX2 ES3L LX3 -QC1L1 -QC1L2 LF03 -QC2L1 -QC2L2 PQC2LE
       LC2   QC3  LF03 BWL LF03  QC4 LF03 BC1L LF03  QC5 LC4  QC6  LC5  QC7 LF03 SY1L SY1L
       LY1 QY2 LF03 BC3L LF03 PQY1 QY1 LF03 BC3L LF03 QY2 LY1 SY2L SY2L
       LF03 QB1 LB1 QB2 LB2 QB3 LB3 QB4 LB4 QB5 LB5 QB6 LB6 -DSUPPL 2*FQCELL)
     IR=(-F0 -FQCELL -FQCELL -COLL COL)
     TTH = ( LT3 QT3 LT4 QT4 LT5 QT5 LT6 QT6 )
     RFSECTION=(DSUPP  QRF RFCELL QRF  -DSUPP1)
;
 ;

! Beam-beam w/o beamstrahlung, Demin
 BEAMBEAM    BMBM  =(NP=2.6D11 BETAX=1 BETAY=0.001 EX=0.D0
             EY=0.D0 EMIX=2.D-9 EMIY=2.D-12 DP=1.29D-3 
             ALPHAX=0.D0 ALPHAY=0.D0 SIGZ=2.42D-3 DX=0.E-6 DZ=0.0
             SLICE=20.D0  XANGLE=15.D-3 STURN=100)
;
;

FFS USE=FQCELL;

wdir=Catch[If[DirectoryQ[#],Throw[#]]&/@{
  "/users/dmzhou/FCCee",
  "/Users/oide/FCCee",
  "/Volumes/oide-p73/FCCee",
  "/users/oide/FCCee",
  "/Users/oide/Documents/SuperTRISTAN"}];

Get[wdir//"/Optimize.n"];

sk2s="SY1*|S{FD}{1234}|S{FD}12{0123}|SD119";
ol=OptimizeLifetime[
  dir->wdir,
  DARange->25,turns->100,wz->15.5,nz->9,
  wpoint->40,wpoint1->60,wth->-20,
  damp->True,
  fname->Fetch,
  elm->{
!    {"$$$","NX"},{"$$$","NY"},
    {"S{FD}*|SY1*","K2"}
! , {sk2s,"SK2"},
!    {"SY*","K3"}
!  (*  ,{"QC{12}","K3"} *) 
      }
  ];
  dr:=FFS["draw bx by & ex ey q*;"];
  elm0=ol@elm;

!  gl=GeoLibrary[olx->ol];

Get["stlib.sad"];

NPARA=1;
ring;rfsw;cod;noradcod;
CONVERGENCE=1e-22;
MINCOUP=1e-3;
!PBUNCH=1e15;; ! Fake
PBUNCH=2.6e11; ! Demin
Brho=MOMENTUM/SpeedOfLight;
bqmax=0.8;
bsmax=0.6;
adp=0.02;

{bx0,by0}={1,0.001};

QL[a_,sige_,td_]:=td*(sige/a)^2*Exp[(a/sige)^2/2];

Circ=100e3;
lstr=11000;
nsp=4;
nbsp=4;
nbend=2480+4;
ncell=(nbend-4)/10;
lcell=(Circ-lstr)/ncell;
babwr=0.0003;
ba=(2*Pi-babwr*4-0.0488)/nbend;
rffreq=400e6;
{nxc,nyc}={0.25,0.25}
ca1Vc=240e6;

s* dx 0;
dsep=0.8;

lb1=lcell/10-2.25-2.4;
B1 L lb1;
B1 ANGLE ba;
save ;
rho=LINE["L","B1"]/LINE["ANGLE","B1"];
Element["L","LXSX"]=Element["L","LF03"]*2+Element["L","SF1"];
emit0=2e-9;
alpha0=8e-6;
bmax=170;
fit nx 1.25 ny 1.25;

cell; free q*
go;
save all;
t f0;
unitcell=ExtractBeamLine[];

use FQCELL2;
cell 
b2 l lb1+dsep*ba;
b2 angle ba;
fit nx 1.25 ny 1.25;
free q*;go;
save all;
t f1;

unitcell1=ExtractBeamLine[];

hse0=150e3/0.1/MOMENTUM;
lse0=50;
lh0=0.05/hse0/lse0-lse0/2;

dsupp=ExtractBeamLine[DSUPP];
dsupp1=ExtractBeamLine[DSUPP1];

nrfc=10;
u0=3335e6;
ddprfin=-0.01003;
ddprfout=ddprfin+u0/MOMENTUM;
ddpcav=u0/MOMENTUM/nrfc/2;

nrfq=5;
Do[
  SetElement["QRFR"//i,"QUAD",{"L"->3}];
  SetElement["QRDR"//i,"QUAD",{"L"->1.5}];
  SetElement["QRFL"//i,"QUAD",{"L"->3}];
  SetElement["QRDL"//i,"QUAD",{"L"->1.5}],{i,nrfq}];

rfr=BeamLine@@Flatten[Table[{"QRFR"//i,LRF,CA1,LRF,"QRDR"//i,LRF,CA1,LRF},{i,nrfq}]];
rfl=BeamLine@@Flatten[Table[{"QRFL"//i,LRF,CA1,LRF,"QRDL"//i,LRF,CA1,LRF},{i,nrfq}]];
rfcs=BeamLine[rfr,QRF,FRF,QRF,-rfl]

With[{e=Join[
  Table[With[{i},"K1"["QRFL"//i]:>"K1"["QRFR"//i]/(1+ddprfout-ddpcav*2*(i-1))*(1+ddprfin+ddpcav*2*(i-1))],
    {i,nrfq}],
  Table[With[{i},"K1"["QRDL"//i]:>"K1"["QRDR"//i]/(1+ddprfout-ddpcav*(2*(i-1)+1))*(1+ddprfin+ddpcav*(2*(i-1)+1))],
    {i,nrfq}]]},
  rfev:=(ElementValues=e)]

rfsect=BeamLine[dsupp,rfcs,-dsupp1];

bxmrf=280;
bymrf=280;
bxmds=550;
bymds=550;
exmds=0.3;

USE rfsect;
LINE["L","BSEP"]=lse0;
LINE["ANGLE","BSEP"]=hse0*lse0;
LINE["L","LXH0"]=lh0;
rfev;
evl=EVList;
FFS$NumericalDerivative=True;
ucr=1400e3;
lthetar:=3/2/ucr *MOMENTUM^3/MASS^2*ElectronRadius/FineStructureConstant;
VariableRange[x_?(StringMatchQ[#,"BI*"]&),"ANGLE",_]:=Abs[Element["L",x]/lthetar]*{-1,1};

(*
qrrage=0.3;
VariableRange[_?(StringMatchQ[#,"QRFR*"]&),"K1",_]:=(1+{-qrrange,qrrange})*Element["K1","QRF"];
VariableRange[_?(StringMatchQ[#,"QRDR*"]&),"K1",_]:=(-1+{-qrrange,qrrange})*Element["K1","QRF"];
*)

ins;
org frf;
fc:=FFS["\
fit bwr+1 ex 0 epx 0;\
fit frf ax 0 ay 0;\
fit frf qrfl1 bxm bxmrf bym bymrf;\
fit qu5 qu2 bxm bxmds bym bymds;\
fit qi2 qi8 bxm bxmds bym bymds exm exmds;\
fit f0 gx 800 gy dsep chi1 1 ax @- ay @- bx @ by @ ex @ epx @-;"];
fc;
qrf* min 0 max 0.04;qrd* max 0 min -0.04;
q{iu}{1357} max 0 min -0.05;q{iu}{2468} min 0 max 0.05;
qh* minmax 0.05;

FitValue["F0","GX",_,_,_]:=-LINE["GX","F1"];
FitValue["F0","GY",_,_,_]:=LINE["GY","F1"]+dsep;
FitValue["F0","CHI1",_,_,_]:=-LINE["GCHI1","F1"];
free qu* qi* qr* qh*;
cal;

!end !Demin

save all;
ElementValues=.;
Clear[FitValue];

rfs=ExtractBeamLine[];
p=Position[rfs,FRF,1,1];
p=Position[rfs,FRF,1,1][[-1,1]];
rfsr=Take[rfs,p];
rfsl=Drop[rfs,p-1];

dsuppc=ExtractBeamLine[DSUPPC];
dsupp1=ExtractBeamLine[DSUPP1];

  nysdr=2.68;
  nysdl=2.68;
  exsy1=0.15;
  bxsy1=22;
  bysy1=7000;
  bymqc=4000;
  bxmqc=1500;
  bxmqb6=600;
  bymql5=600;
  exmqs=0.33;
  bymqg=210;

  fcc:=FFS["\
    fit qk3r chi2 0;\
    fit qk7r+1 r1 0 r2 0 r3 0 r4 0 ey 0 epy 0;"];
  fcg:=FFS["fit fit $$$ gx 3257 gy 109 chi1 6.6385;"];
  fca:=FFS["fit qfg2.1 qfg2.3 nx 0.5 ny 0.5;\
    fit qfg2 qfg2.2 ax 1 ay 1 bx 1 by 1 ex 1 epx 1;"];
  fclc:=FFS["fit ip ex 0 epx 0"];
  fcl:=FFS["  fit ip ax 0 ay 0 bx bx0 by by0 ;\
  fit F0 chi1 chi1ent/Degree;\
  fit qb6 ex 0 epx 0;\
  fit PSFC.8 PQC2LE nx 1.5;\
  fit PSDC.8 ip ny nysdl;\
  fit qb6 bxm bxmqb6;\
  fit qb4 qb2 bxm bxmqb6*1.3;\
  fit ql5 bym bymql5;\
  fit qb5 qb3 bym bymql5*1.3;\
  "];
    fcr:=FFS["\
  fit F1 ax @; bx @; ay @ ;by @;ex @ epx @;\
  fit PQC2RE PSFGC nx 1.5;\
  fit ip psdgc ny nysdr;\
  fit qa3 bym 1500;\
  fit qa4 bxm 400;\
  fit qs4 exm exmqs;\
  fit qg2 qg7 bym bymqg;\
  "];
   fcz:=FFS["\
  fit IP SY1R.2 ny 0.75 nx 0.5;\
  fit sy1r.2 sy2r.2 nx 0.5 ny 0.5 ;\
  fit pqy1 ax 0 ay 0;\
  fit qy2.1 bxm 600;\
  fit sy1r.2 bx bxsy1 by bysy1 ex exsy1;\
  fit sy2r.1 ex 0 epx 0;\
  fit qc3 bym bymqc;\
  fit qc4 bxm bxmqc;\
  fit qc5 bym bymqc;\
  fit qc6 bxm bxmqc;\
  "];
  fc:=(fclc;fcg;fca;fcl;fcr;fcz);

 InitEnt[]:=(eyi=0; epyi=0; r1i=0; r2i=0; r3i=0; r4i=0; dxi=0; dpxi=0; dyi=0; dpyi=0);


USE COL
  ins;
  s* dx 0;
  bxi=bx0;
  byi=by0;
  axi=0;ayi=0;exi=0;epxi=0;
  InitEnt[];
  save ip;
  ins cal

(*
 qc1* l 1.6;
 qc2* l 1.25;
  fit qc1r2 pex 0 pepx Twiss["PEPX","QC1R1"];;
!  fit qc1r2 dx dxqc1r1+LINE["L","QC1R1"]*dpxqc1r1; dpx dpxqc1r1;
  free qc1r1 dx ;free qc1r1 chi1;
go
  rej total;fix *;
  qc1r2 chi1 LINE["CHI1","QC1R1"];
  fit qc1r2+1 pex 0;
  free qc1r2 dx;
go
  rej total;fix *;
  qc2r* chi1 LINE["CHI1","QC1R1"];
  fit qc2r2+1 pex 0 pepx Twiss["PEPX","QC1R1"];
  free qc2* dx;
go
end
  rej total;fix *;
  save all;
  fit lc2 r2 0;free qc2* rotate go
  save all;
  rej total ;fix *;
  fit bv2r+1 chi2 0;
  free bv* go;
  save all;
  rej total;fix *;
  VariableRange[_,"DY",_]:={-0.001,0.001};
*)
  uc=100e3;
  ltheta:=3/2/uc *MOMENTUM^3/MASS^2*ElectronRadius/FineStructureConstant;

  setev:=(ElementValues={
    "L"["BW"]:>ltheta*"ANGLE"["BW"],
    "L"["BC1"]:>ltheta*"ANGLE"["BC1"]
    });
  setev;
  coup qc1r2 qc1r1 1;
  coup qc2r2 qc2r1 1;

  fcr;fcz;fca;
  FFS["\
  LC* min 3 max 120;\
  lc2 min 24;\
  L{^CFXMSG}* min 6 max 60;\
  LY* min 20;\
  LA* min 10 max 40;\
  Q{ABXY}{1357} min -0.07 max 0;\
  Q{ABXY}{2468} min 0 max 0.07;\
  QC{357}  min -0.07 max 0;\
  QC{468} min 0 max 0.05;\
  BC{12} min 0 max 0.017;\
  BC3 min 0 max 0.017;\
  BC4 minmax 0.017;"]; !"


 free qy* ly* bc* bw qc* lc* qa* la* qs* ls* bs* qg* q{df}g* bg* bg* l;

 nxtol=0.0002;
 nxtols=0.0008;
 nytol=2e-6;
 bytol=0.2;
 FitValue["PQC2RE","PSFGC","NX",_,g_,v1_,v2_]:=If[Abs[(v2-v1)-g]<nxtols*2*Pi,Null,v1];
 FitValue["SY1R.2","BY",_,g_,v_]:=If[Abs[v-g]>bytol*g,g,Null,Null];
 FitValue["SY1R.2","EX",_,g_,v_]:=If[v<g,g,Null,Null];

 drr:=FFS["draw IP SY1R.1 bx by & ex & ey & r1 r4 & r2 & r3 qk*;",6];
 rc:=FFS["fix *;free qc* lc* go;free bv* go;free bc* bw qy* ly* go;free qa* la* qs* ls* bs* go;\
          free qg* q{fd}g* go;",6];
 rr:=FFS["fix *;free bv* go;free qk* qc2* rotate go;free qc* lc* go;free bc* bw qy* ly* go;free qa* la* qs* ls* bs* go;",6];

 go;
!end ! Demin

save all;
ElementValues=.;
Clear[FitValue];
!*) ! Demin

USE IR
  s* dx 0;
  InitEnt[];
  org ip 0 0 0 0.015/Degree 0 0;
  ins cal
  uc=100e3;
  ltheta:=3/2/uc *MOMENTUM^3/MASS^2*ElectronRadius/FineStructureConstant;
  chi1ent=((ncell/nsp-4)*10+1)*ba+babwr-Pi/2;

  coup qc1r2 qc1r1 1;
  coup qc2r2 qc2r1 1;

  setev:=(ElementValues={
    "L"["BW"]:>ltheta*"ANGLE"["BW"],
    "L"["BC1"]:>ltheta*"ANGLE"["BC1"],
    "ANGLE"["BWL"]:>-"ANGLE"["BW"],
    "ANGLE"["BC1L"]:>-"ANGLE"["BC1"],
    "ANGLE"["BC3L"]:>-"ANGLE"["BC3"],
    "L"["BWL"]:>"L"["BW"],
    "L"["BC1L"]:>"L"["BC1"],
    "L"["BC3L"]:>"L"["BC3"],
    Null@@(With[{n=#},"K1"[StringReplace[n,"R"->"L"]]:>"K1"[n]]&/@{"QC1R1","QC1R2","QC2R1","QC2R2"})
    });
  setev;

  FFS["\
  LC* min 3 max 120;\
  lc2 min 24;\
  L{^CFXMSGBL}* min 6 max 60;\
  LY* min 20;\
  LA* min 10 max 40;\
  Q{ABXY}{1357} min -0.07 max 0;\
  Q{ABXY}{2468} min 0 max 0.07;\
  QC{357}  min -0.07 max 0;\
  QC{468} min 0 max 0.05;\
  BC{12} min 0 max 0.017;\
  BC3 min 0 max 0.017;\
  BC4 minmax 0.017;\
  "];
  fc;

  vrl:=FFS[" free q{fd}G* bg* bg* l qg* qs* ls* bs* qa* la* ql* ll* bl* qb* lb*"];
  vz:=FFS["free qy* ly* bc* bw qc* lc*"];
  vrl;vz;

 nxtol=0.0002;
 nxtols=0.0008;
 nytol=2e-6;
 bytol=0.2;
 FitValue["PQC2RE","PSFGC","NX",_,g_,v1_,v2_]:=If[Abs[(v2-v1)-g]<nxtols*2*Pi,Null,v1];
 FitValue["SY1R.2","BY",_,g_,v_]:=If[Abs[v-g]>bytol*g,g,Null,Null];
 FitValue["SY1R.2","EX",_,g_,v_]:=If[v<g,g,Null,Null];
 FitValue["$$$","GX",_,_,_]:=-LINE["GX","^^^"]-dsep*Sin[chi1ent];
 FitValue["$$$","CHI1",_,_,_]:=-LINE["GEO","^^^"][[2,1]];
 FitValue["$$$","GY",_,_,_]:=LINE["GY","^^^"]-dsep*Cos[chi1ent];

 drr:=FFS["draw IP SY1R.1 bx by & ex & ey & r1 r4 & r2 & r3 qk*;",6];
 rc:=FFS["fix *;free qc* lc* go;free qk* qc2* rotate  go;free bv* go;free bc* bw qy* ly* go;free qa* la* qs* ls* bs* go;",6];
 rr:=FFS["fix *;free bv* go;free qk* qc2* rotate go;free qc* lc* go;free bc* bw qy* ly* go;free qa* la* qs* ls* bs* go;",6];
 rs:=FFS["rej total;fix *;vrl;fcl go;fclc go;fca fcg go;fcr go;fc go;",6];

 FFS$NumericalDerivative=1;
 rs;
 
!end ! Demin

save all;
FFS$NumericalDerivative=0;
ElementValues=.;
Clear[FitValue];
ir=ExtractBeamLine[];

bxmt=bymt=300;

nqr=nsp/4;
QRINGR=BeamLine[ (ncell/nsp-4)*unitcell1, rfsr];
QRINGL=BeamLine[ (ncell/nsp-4)*unitcell, -rfsl];

FRINGA=BeamLine[-QRINGL, ir, QRINGR];

USE FRINGA;

  org ip 0 0 0 0.015/Degree 0 0;
ca1 freq 400e6 phi 0; 
ca1 ca1Vc;
cell cal emit;
!sigz0=2.4e-3;
!ca1 #ca1*(SIGZ/sigz0)^2;
save ca1;

dprs[dp_]:=Do[DP=k*0.001;If[ol@RelaxStab[,True],,DP=DP-0.001;FFS["calc",6];Break[]],{k,1,Round[dp/0.001]}];
dprs1[dp_]:=Do[DP=k*0.001;If[ol@RelaxStab[,False],,Break[]],{k,1,Round[dp/0.001]}];
dprs[dp0_,dp_]:=Do[DP=k*0.001;If[ol@RelaxStab[,True],,DP=DP-0.001;FFS["calc",6];Break[]],{k,Round[dp0/0.001],Round[dp/0.001]}];
dprs1[dp0_,dp_]:=Do[DP=k*0.001;If[ol@RelaxStab[,False],,Break[]],{k,Round[dp0/0.001],Round[dp/0.001]}];
CONVERGENCE=1e-20;
rfev;

ol@AdjustTune[nx_,ny_]:=Module[{},
  FFS["reset qu* qi* qr*;reject total;FIT $$$ nx "//nx//" NY "//ny//";\
       fit ip ax 0 ay 0 bx bx0 by by0 ex 0 epx 0;\
       fit frf qrfl1 bxm bxmrf bym bymrf;\
       fit qu5 qu2 bxm bxmds bym bymds;\
       fit qi1 qi8 bxm bxmds bym bymds;\
       fit frf ax 0 ay 0 ex 0 epx 0;\
       fix *; free qr*;\
       go;",6]];

!{nx0,ny0}=Twiss[{"NX","NY"},"$$$"]/2/Pi;
{nx0,ny0}=Floor[Twiss[{"NX","NY"},"$$$"]/2/Pi] +{.52,.570}
 ol@AdjustTune[nx0,ny0];

! gl@PlotIRGeo[]; ! Demin

!end ! Demin

save all;;
ElementValues=.;

fringa=ExtractBeamLine[];

With[{s=#},Module[{},
  sp=LINE["POSITION",s//"*"];
  ns=Length[sp]/2;
  Do[SetElement[s//i,"MULT",{"L"->LINE["L","SF1"]}],{i,ns}];
  sl=Table[Symbol[s//i],{i,ns}];
  sl=Flatten[Thread[{sl,sl}]];
  sl=RotateRight[sl,62*2];
  pt=Range[ns*2];
  MapThread[(fringa[[sp[[#]]]]=#2)&,{pt,sl}];
!  (fring[[sp[[#]]]]=LXS)&/@pdt;
  ]]&/@{"SF","SD"};


 wfmin=0.1;
 wdp=1;
 fw[x_]:=(1-4(1-wfmin)*x*(1-x));
! FitWeight[_,"DX"|"DY"|"DPX"|"DPY",{_,dp_},w_]:=With[{r=(dp/DP)^2*wdp},w*fw[r]*worb];
! FitWeight["$$$","NX"|"NY",_,w_]:=w*10;
 FitWeight[_,_,{_,dp_},w_]:=With[{r=(dp/DP)^2*wdp},w*fw[r]];
 da:=DynamicApertureSurvey[{{0,10},{0,0.1},Range[-10,10,1]},100,Output->6];

use fringa;

! Demin, insert beam-beam element

! add beam-beam
! Oide's idea
p=Position[fringa,IP,1,1];
b=Insert[fringa, BMBM, p[[1,1]] + 1 ];

! D.Z.
!p=Position[fringa,IP][[1,1]];
!b=Join[Take[fringa,{p,-1}],Take[fringa,{1,p-1}]];
!b=Prepend[Drop[b,1],BeamLine[IP,BMBM]];

USE b;
Print[Length[b]];

sxshift[]:=(
  Do[LINE["K2","SF"//i]=LINE["K2","SF"//i-4],{i,125,66,-1}];
  Do[LINE["K2","SF"//i]=0,{i,62,65}];
  Do[LINE["SK2","SF"//i]=LINE["SK2","SF"//i-4],{i,125,66,-1}];
  Do[LINE["K2","SD"//i]=LINE["K2","SD"//i-4],{i,124,65,-1}];
  Do[LINE["K2","SD"//i]=0,{i,61,64}];
  Do[LINE["SK2","SD"//i]=LINE["SK2","SD"//i-4],{i,124,65,-1}]);

cell cal;

thetax=Abs[LINE["CHI1","ES1L"]];
kcw=-1/(2 thetax Twiss["BY","IP"] Twiss["BY","SY2R.2"])* Sqrt[Twiss["BX","IP"]/Twiss["BX","SY2R.2"]]
ol@fcw=1;

rej total;fix *;
setev:=(ElementValues={
  "K2"["SY2R"]:>"K2"["SY1R"]-kcw*ol@fcw/2,
  "K2"["SY2L"]:>"K2"["SY1L"]+kcw*ol@fcw/2,
  "SK2"["SY2R"]:>"SK2"["SY1R"],
  "SK2"["SY2L"]:>"SK2"["SY1L"]});
setev;

dxmr=0*Sqrt[EMITX*Twiss["BX","$$$"]]/5;
dpxmr=0*Sqrt[EMITX/Twiss["BX","$$$"]]/5;
dymr=0*Sqrt[EMITX*MINCOUP*Twiss["BY","$$$"]];
dpymr=0*Sqrt[EMITX*MINCOUP/Twiss["BY","$$$"]];
fc:=FFS["fit $$$ nx nx0 24 ny ny0 24;\
  fit frf  bx @ 24 by @ 24 ax 0 24 ay 0 24;"];
fc;
fci:=FFS["fit ip bx bx0 24 ax 0 24 dx 0 24 dpx 0 24;"];
fcd:=FFS["fit frf dx dxmr 24 dpx dpxmr 24;"]; 
fcs:=FFS["FIT frf.11 r1 0 24 r2 0 24 r3 0 24 r4 0 24 dy dymr 24 dpy dpymr 24;"];
vs:=FFS["FREE "//sk2s//" sk2;"];
vfs:=FFS["FIX "//sk2s//" sk2;"];
xweight=1/3;
yweight=1/10;
rweight=1/30;
dxweight=1/10;
dyweight=1/20;
FitWeight[_,"AX"|"BX",_,w_]:=w*xweight;
FitWeight[_,"AY"|"BY",_,w_]:=w*yweight;
FitWeight[_,"R1"|"R2"|"R3"|"R4",_,w_]:=w*rweight;
FitWeight[_,"DX"|"DPX",{_,dp_},w_]:=w*(dp/DP)^2;
FitWeight[_,"DX"|"DPX",{_,dp_},w_]:=w*(dp/DP)^2*dxweight;
FitWeight[_,"DY"|"DPY",{_,dp_},w_]:=w*(dp/DP)^2*dyweight;
s* minmax 2.5;
sd* max 0 min -2;sf* min 0 max 1.5;
fitp 24;
vary k2 s{fdxy}*;
DP=0.002;free s{fd}*|sy1*;free sy* sk2;fix sy* sk2;
intra ol@emit=Emittance[Output->6];

!! Demin's main script start here

! Plot DA
!ol@PlotLifetime[];

! Tracking simulation

!!! Set flags and commands
! flags
STAT;
! commands
!CALC;EMIOUT;EMIT;

!!! Obtain optics and beam parameters
   e=Emittance[OneTurnInformation->True];
   benv=EquilibriumBeamMatrix/.e;
   emits=Emittances/.e;
   twiss=ExtendedTwissParameters/.e;
   Mnp=NormalCoordinates/.e;
   Mpn=SymplecticInverse[Mnp];
   dmpr=-DampingRate/.e;
   M0=OneTurnTransferMatrix/.e;
   Print[emits];
   Print[dmpr];

   pzbh=BucketHeight/.e;
   bx=Twiss["BX","$$$"];
   ax=Twiss["AX","$$$"];
   gx=(1+ax^2)/bx;
   by=Twiss["BY","$$$"];
   ay=Twiss["AY","$$$"];
   gy=(1+ay^2)/by;

   sigmaz0=BunchLength/.e;
   sigmapz0=MomentumSpread/.e;

   P0=175.0e9;
   gamma=P0/MASS;
    Print[benv];
!   Print[Element["DX","BMBM"]];

!!! Set parameters needed for simulations
    start=1;
    emits[[1]]=2.e-9;
    emits[[2]]=2.e-12;
    emits[[3]]=3.17e-6;
    np=1;
    nturn=1000;
    imon=50;
    GCUT=3.;

   Element["NP","BMBM"]=2.6e11;
   PBUNCH=2.6e11;
! Number of xorb is obtained from output of EMIT command
! xorb={x,px,y,py,z,dp}
! Note that z might be -z, check the luminosity and decide
! which one should be used
! dy0=0;=>
!   xorb={0., 0., 0., 0., 0., 0.};
!   xorb=Twiss[{"DX","DPX","DY","DPY","DZ","DDP"},"^^^"];
!   Print[xorb];

   bex=Sqrt[2.0*emits*dmpr];
   Print[bex];

!!! Reset flags for particle tracking
   STAT;
! RAD and FLUC
   RADCOD;CODPLOT;RADTAPER;NOINTRA;
   ca1 phi -ArcSin[EnergyLossU0/RfVoltageVc]/.ol@emit;
   EMIT;
   RAD;FLUC;
! No RAD and FLUC
!   NORAD;NOINTRA;NOFLUC;
!   WSPAC;        ! Space charge
   STAT;
   xorb=Twiss[{"DX","DPX","DY","DPY","DZ","DDP"},"^^^"];
   Print[xorb];

!!! Initialize gaussian beam distribution
!    ixy=Table[0,{i,256},{j,128}];

    destination=LINE['POSITION','***'];
!  { x, px/p0, y, py/p0, z, dp/p0, 1(alive)/0(lost) }
!    xphys={0.0003,0,0.00003,0,0,0,1}; 
!    x= Sqrt[benv[[1,1]]]*GaussRandom[np] + xorb[[1]];
!    px=Sqrt[benv[[2,2]]]*GaussRandom[np] + xorb[[2]];
!    y= Sqrt[benv[[3,3]]]*GaussRandom[np] + xorb[[3]];
!    py=Sqrt[benv[[4,4]]]*GaussRandom[np] + xorb[[4]];
!    z= Sqrt[benv[[5,5]]]*GaussRandom[np] + xorb[[5]];
!    pz=Sqrt[benv[[6,6]]]*GaussRandom[np] + xorb[[6]];
    x= Sqrt[emits[[1]]*bx]*GaussRandom[np] + xorb[[1]];
    px=Sqrt[emits[[1]]/bx]*GaussRandom[np] + xorb[[2]];
    y= Sqrt[emits[[2]]*by]*GaussRandom[np] + xorb[[3]];
    py=Sqrt[emits[[2]]/by]*GaussRandom[np] + xorb[[4]];
    z= sigmaz0*GaussRandom[np] + xorb[[5]];
    pz=sigmapz0*GaussRandom[np] + xorb[[6]];

    pflag=Table[1,{i,np}];
    pbeam0={x,px,y,py,z,pz,pflag};

    pbeam={x,px,y,py,z,pz,pflag};
    beam={start,pbeam};

!    Print[beam];
    xavet=Table[0,{i,7}];
    x2avet=Table[0,{i,7}]; 
    Lumave=0.;
    LumTab={};
!    LuminosityMonitor[lum_]:=Print[lum];
    LuminosityMonitor[lum_]:= (LumTab={LumTab,lum});

!!! Do tracking with beam-beam
!  Beam tail statistics
   datDir="/users/dmzhou/FCCee/FCCee_t_42_3_cw/INJ_FLUC/ele-by-ele/"
   filename="BeamTail.dat";
   fn=OpenWrite[datDir//filename];
   fs=OpenWrite[datDir//"BeamSize.dat"];
   fpc=OpenWrite[datDir//"Particle_Coordinates_Last_Turn.dat"];
   itaccum=500;
   axm=10.;
   aym=40.;
   ngridx=200;
   ngridy=800;
   dx1=axm/ngridx;
   dy1=aym/ngridy;
   ixy=Table[0,{i,ngridx},{j,ngridy}];
   Nele=Length[b];
   Print[Nele];

(*
! Do element-by-element tracking
   Do[
     Print[beam];
     beam=TrackParticles[beam,i];
    ,{i,2}];
*)

TrackOrbit[z0_,begin_,end_]:=Module[{z,pb=LINE["POSITION",begin],pe=LINE["POSITION",end]},
  z=TrackParticles[z0,pb];
  {Table[LINE["S",k],{k,pb,pe}],
    Table[TrackParticles[z,k],{k,pb,pe}]}
    ];
aa=TrackOrbit[beam,2,Nele];
Print[aa];
end


! Do turn-by-turn tracking
   Do[
     beam=TrackParticles[beam,1,i];
     pbeam=beam[[2]];
     pflag=pbeam[[7]];
     x6=Drop[pbeam,-1];
     x6=x6-xorb;
     xn=Mnp.x6;
     If[i > itaccum,
       axn=Sqrt[(xn[[1]]*xn[[1]]+xn[[2]]*xn[[2]])*0.5/emits[[1]]];
       ayn=Sqrt[(xn[[3]]*xn[[3]]+xn[[4]]*xn[[4]])*0.5/emits[[2]]];
       Do[
         ix=Floor[axn[[j]]/dx1]+1;
         iy=Floor[ayn[[j]]/dy1]+1;
         If[ix > ngridx, ix=ngridx];
         If[iy > ngridy, iy=ngridy];
         ixy[[ix,iy]]=ixy[[ix,iy]]+1;
         ,{j,np}];
       ];
! Artificial damping and excitation
!     xn[[1]]=xn[[1]]*(1.-dmpr[[1]])+bex[[1]]*GaussRandom[np];
!     xn[[2]]=xn[[2]]*(1.-dmpr[[1]])+bex[[1]]*GaussRandom[np];
!     xn[[3]]=xn[[3]]*(1.-dmpr[[2]])+bex[[2]]*GaussRandom[np];
!     xn[[4]]=xn[[4]]*(1.-dmpr[[2]])+bex[[2]]*GaussRandom[np];
!     xn[[5]]=xn[[5]]*(1.-dmpr[[3]])+bex[[3]]*GaussRandom[np];
!     xn[[6]]=xn[[6]]*(1.-dmpr[[3]])+bex[[3]]*GaussRandom[np];
! Artificial excitation
!     xn[[1]]=xn[[1]]+bex[[1]]*GaussRandom[np];
!     xn[[2]]=xn[[2]]+bex[[1]]*GaussRandom[np];
!     xn[[3]]=xn[[3]]+bex[[2]]*GaussRandom[np];
!     xn[[4]]=xn[[4]]+bex[[2]]*GaussRandom[np];
!     xn[[5]]=xn[[5]]+bex[[3]]*GaussRandom[np];
!     xn[[6]]=xn[[6]]+bex[[3]]*GaussRandom[np];
     x6=Mpn.xn;
     x6=x6+xorb;
     beam={beam[[1]],Append[x6,pflag]};

     If[i==1, Print['Tracking Start'];];
     If[Mod[i,imon]==0, 
      xavet=xavet/imon;
      x2avet=x2avet/imon;
      Lumave=Plus@@Flatten[LumTab]/imon;
      Print[xavet[[1]],"  ",xavet[[3]],"  ",xavet[[5]],"  ",
            Sqrt[x2avet[[1]]],"  ",Sqrt[x2avet[[3]]],"  ",Sqrt[x2avet[[5]]],"  ",
           Lumave];
!      Print[LumTab];
!      Print[xavet];
!Print[Lumave];
!      WriteString[6,#," "] &/@Flatten[{i,xavet,x2avet,Lumave}];
!      WriteString[6,"\n"];
!      Write[fn,i,"  ",Lumave,"\n"];
!      WriteString[fn,#," "] &/@Flatten[{i,xavet,x2avet,Lumave}];
!      WriteString[fn,"\n"];

      x2avet=0; 
      xavet=0;
      LumTab={}; ];

      xave=Plus@@[pbeam,{1}]/np;
      x2ave=Plus@@[(pbeam-xave)^2,{1}]/np;
      WriteString[fs,i,"  ",xave[[1]],"  ",xave[[2]],"  ",xave[[3]],"  ",
                     xave[[4]],"  ",xave[[5]],"  ",xave[[6]],"  ",
                     x2ave[[1]],"  ",x2ave[[2]],"  ",x2ave[[3]],"  ",
                     x2ave[[4]],"  ",x2ave[[5]],"  ",x2ave[[6]],"  ",
                     Plus@@Flatten[pflag],"\n"];
      xavet=xavet+xave;
      x2avet=x2avet+x2ave;
    ,{i,nturn}];
    Print['Tracking End'];

    pbeam0[[7]]=pbeam[[7]];
! Print particle coordinates
    Do[
      WriteString[fpc,#," "] &/@Flatten[{pbeam[[1,i]],pbeam[[2,i]],
      pbeam[[3,i]],pbeam[[4,i]],pbeam[[5,i]],pbeam[[6,i]]}];
      WriteString[fpc,"\n"]
    ,{i,np}];
!    fn=OpenWrite[fname];
!    f8=OpenWrite[fname8];
!    Write[f8,pbeam0];
    Do[
      Do[
        xc=(j-0.5)*dx1;
        yc=(i-0.5)*dy1;
        WriteString[fn,xc,"  ",yc,"  ",ixy[[j,i]],"\n"];
!        If[ixy[[j,i]]>=1,Print["ok"]];
        ,{j,ngridx}];
      ,{i,ngridy}];
    Close[fn];
    Close[fs];
    Close[fpc];

abort;

dprs[0.002];
ol@SetupChroma["S*",{0,0}];
reset;

DP=0.02;

end

ol@damp=0;
nointra;
ca1 phi -ArcSin[EnergyLossU0/RfVoltageVc]/.ol@emit;
b* EPS 100;
rad;radcod;nofluc;radtaper;codplot;em=Emittance[Output->6];
z0={1,Table[{0},{7}]};
z0[[2,7,1]]=1;
z=z0;
z[[2,6,1]]=5*SIGE;

TrackOrbit[z0_,begin_,end_]:=Module[{z,pb=LINE["POSITION",begin],pe=LINE["POSITION",end]},
  z=TrackParticles[z0,pb];z[[2,1,1]]=z[[2,2,1]]=0;
  {Table[LINE["S",k],{k,pb+1,pe}],
    Table[TrackParticles[z,k],{k,pb+1,pe}]}];

PlotOrbIP[z0_,n_,fr_:"IP-200",to_:"IP+200"]:=Module[{z=z0,zt},
  Table[z=TrackParticles[z,1],{n}];
  zt=TrackOrbit[z,fr,to];
  ListPlot[Thread[{zt[[1]],zt[[2,,2,3,1]]}],FrameLabel->{"s (m)","`fD`ny (m)"}];
  Update[];
  zt];

(*
UntaperRFQ[]:=Module[{},
  Do[
    Element["K1","QRFR"//i]=Element["K1","QRFR"//i]/(ddprfin+2*(i-1)*ddpcav);
    Element["K1","QRDR"//i]=Element["K1","QRDR"//i]/(ddprfin+(2*i-1)*ddpcav);
    Element["K1","QRFL"//i]=Element["K1","QRFL"//i]/(ddprfout-2*(i-1)*ddpcav);
    Element["K1","QRDL"//i]=Element["K1","QRDL"//i]/(ddprfout-(2*i-1)*ddpcav),
    {i,nrfq}];
  ];
*)

end


so@Optimize[MaxIterations->10]

end

!
!nointra radcod codplot emit;
!rad nofluc;
!
!end

e=Emittance[Output->6];
{alpha,sige,bh,damp}={MomentumCompaction,MomentumSpread,BucketHeight,DampingRate}/.e;

nus=Sqrt[Vc/MOMENTUM*2*Pi*rffreq*Circ/SpeedOfLight*alpha]/2/Pi
sigz=sige*alpha*Circ/2/Pi/nus

 Turns =100 Maximum number of particles =266
 Range    Xmin:   0.000 Xmax:  25.000
         (Ymin:   0.000 Ymax:   0.791)
          Zmin: -15.500 Zmax:  15.500
 Display:    10 turns/character
      NZ     0----|----1----|----2----|----3----|----4----|----5
   -15.50 21 **************AAAAAAA11       .         .         .
   -15.26 21 **************AAAAAAA311      .         .         .
   -14.57 24 *****************AAAAAAA11    .         .         .
   -13.42 27 ********************AAAAAAA111.         .         .
   -11.87 29 **********************AAAAAAA1111       .         .
    -9.96 21 **************AAAAAAA211111111111111    .         .
    -7.75 21 **************AAAAAAA4311121  .   11    .         .
    -5.30 25 ******************AAAAAAA33211.         .         .
    -2.69 27 ********************AAAAAAA4333343      .         .
     0.00 31 ************************AAAAAAA41     3 .         .
     2.69 27 ********************AAAAAAA1111121      .         .
     5.30 15 ********AAAAAAA7211111A1111111111       .         .
     7.75 12 *****AAAAAAA41111A1 .         .         .         .
     9.96 10 ***AAAAAAA321111114A411       .         .         .
    11.87 10 ***AAAAAAA22111     .         .         .         .
    13.42  7 AAAAAAA3A211111     .         .         .         .
    14.57  7 AAAAAAA311.   12    .         .         .         .
    15.26  7 AAAAAAA1  .    1    .         .         .         .
    15.50  6 AAAAAA111 .   1     .         .         .         .
      NZ     0----|----1----|----2----|----3----|----4----|----5
    Score:   348
 Turns =100 Maximum number of particles =266
 Range    Xmin:   0.000 Xmax:  25.000
         (Ymin:   0.000 Ymax:   0.791)
          Zmin: -15.500 Zmax:  15.500
 Display:    10 turns/character
      NZ     0----|----1----|----2----|----3----|----4----|----5
   -15.50  4 AAAA1     .         .         .         .         .
   -15.26  4 AAAA11  1 .         .         .         .         .
   -14.57  4 AAAA3111  .         .         .         .         .
   -13.42  7 AAAAAAA111. 1       .         .         .         .
   -11.87  7 AAAAAAA22A1111      .         .         .         .
    -9.96 12 *****AAAAAAA11111111111       .         .         .
    -7.75 13 ******AAAAAAA221 1  .         .         .         .
    -5.30 15 ********AAAAAAA211  .         .         .         .
    -2.69 19 ************AAAAAAA11         .         .         .
     0.00 26 *******************AAAAAAA22  .         .         .
     2.69 21 **************AAAAAAA221 11   .         .         .
     5.30 19 ************AAAAAAA2221       .         .         .
     7.75 17 **********AAAAAAA11 .   1     .         .         .
     9.96 13 ******AAAAAAA211    .         .         .         .
    11.87 10 ***AAAAAAA1         .         .         .         .
    13.42  8 *AAAAAAA1 1         .         .         .         .
    14.57  6 AAAAAA21  .         .         .         .         .
    15.26  6 AAAAAA    .         .         .         .         .
    15.50  6 AAAAAA    .         .         .         .         .
      NZ     0----|----1----|----2----|----3----|----4----|----5
    Score:   217
 Turns =100 Maximum number of particles =266
 Range    Xmin:   0.000 Xmax:  25.000
         (Ymin:   0.000 Ymax:   0.791)
          Zmin: -15.500 Zmax:  15.500
 Display:    10 turns/character
      NZ     0----|----1----|----2----|----3----|----4----|----5
   -15.50  7 AAAAAAA1  .         .         .         .         .
   -15.26  7 AAAAAAA111.         .         .         .         .
   -14.57  9 **AAAAAAA11111      .         .         .         .
   -13.42 13 ******AAAAAAA11111111  1111   .         .         .
   -11.87 18 ***********AAAAAAA3111        .         .         .
    -9.96 20 *************AAAAAAA332211    .         .         .
    -7.75 18 ***********AAAAAAA11111131111111        .         .
    -5.30 22 ***************AAAAAAA2211332 .         .         .
    -2.69 26 *******************AAAAAAA534332123     .         .
     0.00 29 **********************AAAAAAA65A43431   .    1    .
     2.69 21 **************AAAAAAA71111151 .    1    .         .
     5.30 15 ********AAAAAAA111111111      .         .         .
     7.75 14 *******AAAAAAA222A1111        .         .         .
     9.96 11 ****AAAAAAA41       .         .         .         .
    11.87  9 **AAAAAAA2A1A       .         .         .         .
    13.42  8 *AAAAAAA52.         .         .         .         .
    14.57  8 *AAAAAAA1 .         .         .         .         .
    15.26  7 AAAAAAA2 1.         .         .         .         .
    15.50  7 AAAAAAA5  .         .         .         .         .
      NZ     0----|----1----|----2----|----3----|----4----|----5
    Score:   269
 Turns =100 Maximum number of particles =266
 Range    Xmin:   0.000 Xmax:  25.000
         (Ymin:   0.000 Ymax:   0.791)
          Zmin: -15.500 Zmax:  15.500
 Display:    10 turns/character
      NZ     0----|----1----|----2----|----3----|----4----|----5
   -15.50  5 AAAAA1    .         .         .         .         .
   -15.26  5 AAAAA13   .         .         .         .         .
   -14.57  6 AAAAAA12  .         .         .         .         .
   -13.42  6 AAAAAA21  .         .         .         .         .
   -11.87  7 AAAAAAA222. 1       .         .         .         .
    -9.96  9 **AAAAAAA3111       .         .         .         .
    -7.75 12 *****AAAAAAA441     .         .         .         .
    -5.30 15 ********AAAAAAA21   .         .         .         .
    -2.69 20 *************AAAAAAA1         .         .         .
     0.00 25 ******************AAAAAAA211  . 1       .         .
     2.69 18 ***********AAAAAAA6222A11  1  .         .         .
     5.30 16 *********AAAAAAA42111         .         .         .
     7.75 18 ***********AAAAAAA2A.         .         .         .
     9.96 15 ********AAAAAAA1    .         .         .         .
    11.87 13 ******AAAAAAA111 1  .         .         .         .
    13.42 11 ****AAAAAAA1111 1   .         .         .         .
    14.57  9 **AAAAAAA41111      .         .         .         .
    15.26  9 **AAAAAAA111        .         .         .         .
    15.50  9 **AAAAAAA111        .         .         .         .
      NZ     0----|----1----|----2----|----3----|----4----|----5
    Score:   228
Lifetime:   438.5003 ( 1299.2552 points)  Stop
