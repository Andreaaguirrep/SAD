! FCCee-t, from 7_syk3ch
! Solenoid
! from FCCee_t_8_8, 9_5 15_2 15_4 16 17_5 18_2 18_10 19_5 19_11 23_1 25_6 30_8 32_5 32_17 35_5 35 35_8 35_12 35_13
! Skew sexts
! better QK?
! smaller dispersion (2) + adjust emit
! thinner SY,QK
! independent SY1/SY2
! Crab waist
! improve IR
! More sk2, factor 1/2 in kcw?
! Reverse CHI1 of ES, reverse kcw
! Width Point
! thetax = 15 mrad, bx* =0.5, MINCOUP=0.1%
! Optimize Tune
! shorter qc2;
! Adjusted rf freq/bunch length
! reduce exsy1;
! fit to two tunnels at IR, longer arc at the "R" side, geometry matching of IR.
! longer QC{12}
! Smooth qg region.
! Cross over at rf;
! Outer arc; 2440 bends.
! DXM/DPXM matching;
! Better rf section.
! bx* 1 m.
!
MOMENTUM= 175 GEV;
ON ECHO;OFF EMIT COD CTIME    RAD RFSW;

 ;
 DRIFT  LRF     =(L =20 )    LT3     =(L =34.245001533641826 )  LT4     =(L =13.667515333425282 )  LT5     =(L =80.82049851894872 )
        LT6     =(L =5.091156380310007 )   LH0     =(L =91.66666666666669 )   LF03    =(L =.3 )    LI2     =(L =6.881372745263303 )
        LI3     =(L =63.616339427372004 )  LXSX    =(L =.8999999999999999 )   LL2     =(L =26.196135535102318 )
        LL3     =(L =70.927045012809 )     LL4     =(L =10.334550873463948 )  LB6     =(L =35.47676443210026 )
        LB5     =(L =161.50073126723098 )  LB4     =(L =160.90631051468696 )  LB3     =(L =211.23393063454972 )
        LB2     =(L =212.4327684770858 )   LB1     =(L =118.62213165498676 )  LY1     =(L =59.99410267291718 )
        LC4     =(L =119.99707259833015 )  LC3     =(L =81.30580940118604 )   LC2     =(L =55.74412324130758 )   LX4     =(L =1 )
        LX3     =(L =.2 )    LX2     =(L =1 )     LX1     =(L =1 )     LA1     =(L =18.151452541356647 )
        LA2     =(L =30.673984402266715 )  LA3     =(L =27.028295438728236 )  LA4     =(L =23.4168839009008 )
        LA5     =(L =19.75733155160691 )   LA6     =(L =12.058550363055573 )  LS4     =(L =.5430840590874877 )
        LS3     =(L =33.70821634811543 )   LS2     =(L =26.09655310181778 )   LH3     =(L =47.18192236807725 )
        LH2     =(L =67.41213616553243 )   LH1     =(L =5.467293479795593 )
 ;
 BEND   BI0     =(L =50   ANGLE =.00042857142857142855  E2 =1 )
        BI1     =(L =87.41848288342364   ANGLE =.0018878586628106458   E1 =.5    E2 =.5 )
        BI2     =(L =15.415984540333945  ANGLE =.00030709136676419996  E1 =.5    E2 =.5 )
        BI3     =(L =32   ANGLE =-.002623521458146274   E1 =.5    E2 =.5 )
        B1      =(L =34.075409836065575  ANGLE =.002555075945565404    E1 =.5    E2 =.5 )
        BL      =(L =44.47901234567902   ANGLE =.0007671752985352148   E1 =.5    E2 =.5 )
        BC3L    =(L =60   ANGLE =-.001567163405966039   E1 =.5    E2 =.5 )
        BC1L    =(L =132.94942560957327  ANGLE =-.0011182902772109067  E1 =.5    E2 =.5 )
        BWL     =(L =9.700409093306805   ANGLE =-8.159398300726577e-05 E1 =.5    E2 =.5 )
        BV2     =(L =10   ANGLE =3.855954616984787e-05  E1 =.5    E2 =.5    ROTATE =90 DEG )
        BW      =(L =9.700409093306805   ANGLE =8.159398300726577e-05  E1 =.5    E2 =.5 )
        BC1     =(L =132.94942560957327  ANGLE =.0011182902772109067   E1 =.5    E2 =.5 )
        BC3     =(L =60   ANGLE =.001567163405966039    E1 =.5    E2 =.5 )
        BS      =(L =44.47901234567902   ANGLE =.0020546896337556007   E1 =.5    E2 =.5 )
        BG1     =(L =43.78877503320427   ANGLE =.0024857695682832643   E1 =.5    E2 =.5 )
        BG2     =(L =38.09901660421995   ANGLE =.0019309078255951458   E1 =.5    E2 =.5 )
        B2      =(L =34.07745389682203   ANGLE =.002555075945565404    E1 =.5    E2 =.5 )
        BH3     =(L =27.14297761728094   ANGLE =.0002721682766917117   E1 =.5    E2 =.5 )
        BH2     =(L =34.81593496531462   ANGLE =.002752715079341234    E1 =.5    E2 =.5 )
        BH1     =(L =23.01191499251948   ANGLE =-.002596311927461517   E1 =.5    E2 =.5 )
        BH0     =(L =50   ANGLE =-.00042857142857142855 E1 =1 )
 ;
 QUAD   QRF     =(L =.3   K1 =.01218651742578887 )
        QRD     =(L =.6   K1 =-.020857434473156834 )
        QT3     =(L =.6   K1 =-.024033353193354756 )
        QT4     =(L =.6   K1 =.0234870527379838 )
        QT5     =(L =.6   K1 =-.045388340411725125 )
        QT6     =(L =.6   K1 =.044640061930708144 )
        QI2     =(L =.6   K1 =.03162784690605246 )
        QI3     =(L =.6   K1 =-.03937165678275019 )
        QI4     =(L =.6   K1 =.025565611640518307 )
        QI5     =(L =.6   K1 =-.02927451442385722 )
        QI6     =(L =.6   K1 =.016013238576394296 )
        QD1     =(L =.6   K1 =-.03898595059506528 )
        QF2     =(L =.6   K1 =.038986165188633654 )
        QL3     =(L =.6   K1 =-.040060766423995475 )
        QL4     =(L =.6   K1 =.015828836076069178 )
        QL5     =(L =.6   K1 =-.01629112772443639 )
        QB6     =(L =.6   K1 =.00862486418521506 )
        QB5     =(L =.6   K1 =-.005593657403067507 )
        QB4     =(L =.6   K1 =.003078536313017993 )
        QB3     =(L =.6   K1 =-2.252418007208943e-06 )
        QB2     =(L =.6   K1 =.0084144846241381 )
        QB1     =(L =.6   K1 =-.016257111496909834 )
        QY2     =(L =.6   K1 =.023401574293683624 )
        QY1     =(L =.6   K1 =-.023255973749263806 )
        QC7     =(L =.6   K1 =-.019433085967334368 )
        QK7L    =(L =.15  K1 =-.00028680920244022925    ROTATE =-45 DEG )
        QC6     =(L =.6   K1 =.012245396298569211 )
        QK6L    =(L =.15  K1 =.00048446418272681056     ROTATE =-45 DEG )
        QC5     =(L =.6   K1 =-.013257804647973371 )
        QK5L    =(L =.15  K1 =-.0004997662560326327     ROTATE =-45 DEG )
        QC4     =(L =.6   K1 =.016127955363386837 )
        QK4L    =(L =.15  K1 =.0004992378288348487 ROTATE =-45 DEG )
        QC3     =(L =.6   K1 =-.006550975488370566 )
        QK3L    =(L =.15  K1 =-6.153310939575242e-05    ROTATE =-45 DEG )
        QK2L    =(L =.15  K1 =7.389793310423953e-05     ROTATE =-45 DEG )
        QK1L    =(L =.15  K1 =-.0004941243091041632     ROTATE =-45 DEG )
        QK1R    =(L =.15  K1 =-.0004941243091041632     ROTATE =45 DEG )
        QK2R    =(L =.15  K1 =7.389793310423953e-05     ROTATE =45 DEG )
        QK3R    =(L =.15  K1 =-6.153310939575242e-05    ROTATE =45 DEG )
        QK4R    =(L =.15  K1 =.0004992378288348487 ROTATE =45 DEG )
        QK5R    =(L =.15  K1 =-.0004997662560326327     ROTATE =45 DEG )
        QK6R    =(L =.15  K1 =.00048446418272681056     ROTATE =45 DEG )
        QK7R    =(L =.15  K1 =-.00028680920244022925    ROTATE =45 DEG )
        QA1     =(L =.6   K1 =-.03488610490111049 )
        QA2     =(L =.6   K1 =.03543938749409681 )
        QA3     =(L =.6   K1 =-.005470584419570081 )
        QA4     =(L =.6   K1 =.00039202927613808317 )
        QA5     =(L =.6   K1 =-.00289107511995871 )
        QA6     =(L =.6   K1 =.025742707358572453 )
        QS5     =(L =.6   K1 =-.037031322516731434 )
        QS4     =(L =.6   K1 =.0315244692841084 )
        QS3     =(L =.6   K1 =-.04113940573563617 )
        QFG2    =(L =.6   K1 =.03075162233330516 )
        QDG1    =(L =.6   K1 =-.03075146292846037 )
        QG2     =(L =.6   K1 =.03348010450917778 )
        QG3     =(L =.6   K1 =-.03634175770981752 )
        QG4     =(L =.6   K1 =.03431664851073936 )
        QG5     =(L =.6   K1 =-.03926852204949233 )
        QG6     =(L =.6   K1 =.03525876407457582 )
        QG7     =(L =.6   K1 =-.03754945782694567 )
        QF4     =(L =.6   K1 =.038983968425327704 )
        QD3     =(L =.6   K1 =-.038983753844146235 )
        QH6     =(L =.6   K1 =.04833085942519506 )
        QH5     =(L =.6   K1 =-.03288496847509344 )
        QH4     =(L =.6   K1 =.032561793698721524 )
        QH3     =(L =.6   K1 =-.013864666654870166 )
        QH2     =(L =.6   K1 =.036649216411707375 )
        QH1     =(L =.6   K1 =-.0368148514400098 )
 ;
 MULT   SD62    =(L =.3   K2 =-.48076267443164633 )
        SF63    =(L =.3   K2 =1.4280064327481334 )
        SD63    =(L =.3   K2 =-.2333672188176788 )
        SF64    =(L =.3   K2 =.1786080920140811 )
        SD64    =(L =.3   K2 =-1.8166074476736185 )
        SF65    =(L =.3   K2 =.8825625716818715 )
        SD65    =(L =.3   K2 =-.9777667583507711 )
        SF66    =(L =.3   K2 =.18358718388050313 )
        SD66    =(L =.3   K2 =-2.77507408732973 )
        SF67    =(L =.3   K2 =-.003928501649280929 )
        SD67    =(L =.3   K2 =-1.8523921725536914 )
        SF68    =(L =.3   K2 =.20346365449116627 )
        SD68    =(L =.3   K2 =-2.165162670950364 )
        SF69    =(L =.3   K2 =.8614008224100921 )
        SD69    =(L =.3   K2 =-.04115989901643662 )
        SF70    =(L =.3   K2 =1.7559622142228597 )
        SD70    =(L =.3   K2 =-.1162723197654011 )
        SF71    =(L =.3   K2 =.3367886030109756 )
        SD71    =(L =.3   K2 =-1.763700466500098 )
        SF72    =(L =.3   K2 =.2029070961413867 )
        SD72    =(L =.3   K2 =-.28741665059946797 )
        SF73    =(L =.3   K2 =1.4305223906061877 )
        SD73    =(L =.3   K2 =-2.3653579790787247 )
        SF74    =(L =.3   K2 =.38372566955215626 )
        SD74    =(L =.3   K2 =-1.3800618413286951 )
        SF75    =(L =.3   K2 =.4586898384810804 )
        SD75    =(L =.3   K2 =-.6122709739331875 )
        SF76    =(L =.3   K2 =.3704174298848194 )
        SD76    =(L =.3   K2 =-.9759035180404129 )
        SF77    =(L =.3   K2 =.18636904220645725 )
        SD77    =(L =.3   K2 =-1.4343528920007989 )
        SF78    =(L =.3   K2 =.7935002616059988 )
        SD78    =(L =.3   K2 =-.2817580604055931 )
        SF79    =(L =.3   K2 =1.2470640751329618 )
        SD79    =(L =.3   K2 =-2.437148852871658 )
        SF80    =(L =.3   K2 =1.5371043643235012 )
        SD80    =(L =.3   K2 =-.4587287591755459 )
        SF81    =(L =.3   K2 =.3259798482507734 )
        SD81    =(L =.3   K2 =-.2943676208175231 )
        SF82    =(L =.3   K2 =.2843973200543567 )
        SD82    =(L =.3   K2 =-1.0178682599546507 )
        SF83    =(L =.3   K2 =.3443967148428013 )
        SD83    =(L =.3   K2 =-1.1805992394454314 )
        SF84    =(L =.3   K2 =.11245191284070016 )
        SD84    =(L =.3   K2 =-.33385189624935063 )
        SF85    =(L =.3   K2 =.17434973955194935 )
        SD85    =(L =.3   K2 =-.24829601415571637 )
        SF86    =(L =.3   K2 =.22985638462286923 )
        SD86    =(L =.3   K2 =-.23039216872028395 )
        SF87    =(L =.3   K2 =.1548426366127182 )
        SD87    =(L =.3   K2 =-.5295038741943227 )
        SF88    =(L =.3   K2 =.21017204946277687 )
        SD88    =(L =.3   K2 =-.6233190715884583 )
        SF89    =(L =.3   K2 =.41733450455995813 )
        SD89    =(L =.3   K2 =-.45096239124093696 )
        SF90    =(L =.3   K2 =.2943650635489867 )
        SD90    =(L =.3   K2 =-1.389319256110239 )
        SF91    =(L =.3   K2 =2.179116258013084 )
        SD91    =(L =.3   K2 =-.6867258423514099 )
        SF92    =(L =.3   K2 =.742755929919112 )
        SD92    =(L =.3   K2 =-.4473515559966842 )
        SF93    =(L =.3   K2 =.6870922828056197 )
        SD93    =(L =.3   K2 =-2.4137980129815326 )
        SF94    =(L =.3   K2 =.17882897623524033 )
        SD94    =(L =.3   K2 =-1.8989844515550631 )
        SF95    =(L =.3   K2 =1.1438260284552502 )
        SD95    =(L =.3   K2 =-1.002900959088487 )
        SF96    =(L =.3   K2 =.19072801324216349 )
        SD96    =(L =.3   K2 =-.9883298351050668 )
        SF97    =(L =.3   K2 =.310438347884734 )
        SD97    =(L =.3   K2 =-.5168155754237161 )
        SF98    =(L =.3   K2 =.22917020545405623 )
        SD98    =(L =.3   K2 =-.5021725307186821 )
        SF99    =(L =.3   K2 =.2903907141140981 )
        SD99    =(L =.3   K2 =-.06344913221058482 )
        SF100   =(L =.3   K2 =.784120518345811 )
        SD100   =(L =.3   K2 =-.4889212843760511 )
        SF101   =(L =.3   K2 =.111802749656923 )
        SD101   =(L =.3   K2 =-.1620161089559888 )
        SF102   =(L =.3   K2 =.4004364778369659 )
        SD102   =(L =.3   K2 =-.42921897818395466 )
        SF103   =(L =.3   K2 =.2906458640547209 )
        SD103   =(L =.3   K2 =-.20075971825256128 )
        SF104   =(L =.3   K2 =.2679593207832406 )
        SD104   =(L =.3   K2 =-.5727333785466434 )
        SF105   =(L =.3   K2 =.22947944694436676 )
        SD105   =(L =.3   K2 =-.7882576603700809 )
        SF106   =(L =.3   K2 =.08440750957333534 )
        SD106   =(L =.3   K2 =-1.2250906668711874 )
        SF107   =(L =.3   K2 =.30667383111531976 )
        SD107   =(L =.3   K2 =-.0177343727750008 )
        SF108   =(L =.3   K2 =.5101124588614144 )
        SD108   =(L =.3   K2 =-1.5636661930283626 )
        SF109   =(L =.3   K2 =.3997196579742167 )
        SD109   =(L =.3   K2 =-.3231527703281537 )
        SF110   =(L =.3   K2 =.4039837774783366 )
        SD110   =(L =.3   K2 =-1.6719458966343494 )
        SF111   =(L =.3   K2 =.30055194303621 )
        SD111   =(L =.3   K2 =-1.8428154579426128 )
        SF112   =(L =.3   K2 =.1932488855671496 )
        SD112   =(L =.3   K2 =-.8329711842935419 )
        SF113   =(L =.3   K2 =.23521694493118034 )
        SD113   =(L =.3   K2 =-1.917062964554451 )
        SF114   =(L =.3   K2 =.4970190301333156 )
        SD114   =(L =.3   K2 =-.451595622029059 )
        SF115   =(L =.3   K2 =1.5819897257725335 )
        SD115   =(L =.3   K2 =-.02903371851617657 )
        SF116   =(L =.3   K2 =.8357544073203642 )
        SD116   =(L =.3   K2 =-.17921743070605806 )
        SF117   =(L =.3   K2 =.891611659324843 )
        SD117   =(L =.3   K2 =-1.3629760912604723 )
        SF118   =(L =.3   K2 =.5109503696420066 )
        SD118   =(L =.3   K2 =-.1152227783015555 )
        SF119   =(L =.3   K2 =.857023419577314 )
        SD119   =(L =.3   K2 =-1.2303841818376795  SK2 =-.2646689080248751 )
        SF120   =(L =.3   K2 =.07545401627713665   SK2 =-.01393898043791417 )
        SD120   =(L =.3   K2 =-.21157817351363137  SK2 =.21777983596222256 )
        SF121   =(L =.3   K2 =.3319914800276369    SK2 =-.040095078539261336 )
        SD121   =(L =.3   K2 =-1.4229578330422248  SK2 =.39085719992925794 )
        SF122   =(L =.3   K2 =.8740817170365329    SK2 =-.057082507275769856 )
        SD122   =(L =.3   K2 =-.09871907226405716  SK2 =-.12191455156887493 )
        SF123   =(L =.3   K2 =-.002552311587514925 SK2 =-.012845625886268343 )
        SY2L    =(L =.15  K2 =1.4305683499826936   SK2 =-.0028391097268078364 )
        SY1L    =(L =.15  K2 =2.360781656945443    SK2 =-.0028391097268078364 )
        QC2L2   =(L =1.25 DX =-.11062845441510048  DY =-.00017    CHI1 =.015010701319148993     ROTATE =-.014503010258113336 DEG
           K1 =.12990787977259693 )
        QC2L1   =(L =1.25 DX =-.09188758499107687  DY =-.00017    CHI1 =.015010701319148993     ROTATE =-.014503010258113336 DEG
           K1 =.12990787977259693 )
        QC1L2   =(L =1.6  DX =-.06600398011368168  DY =-.00011    CHI1 =.015010701319148993     K1 =-.27746117758411787 )
        QC1L1   =(L =1.6  DX =-.04200493550181795  DY =-.00011    CHI1 =.015010701319148993     K1 =-.27746117758411787 )
        QC1R1   =(L =1.6  DX =.04200493550181795   DY =-.00011    CHI1 =.015010701319148993     K1 =-.27746117758411787 )
        QC1R2   =(L =1.6  DX =.06600398011368168   DY =-.00011    CHI1 =.015010701319148993     K1 =-.27746117758411787 )
        QC2R1   =(L =1.25 DX =.09188758499107687   DY =-.00017    CHI1 =.015010701319148993     ROTATE =.014503010258113336 DEG
           K1 =.12990787977259693 )
        QC2R2   =(L =1.25 DX =.11062845441510048   DY =-.00017    CHI1 =.015010701319148993     ROTATE =.014503010258113336 DEG
           K1 =.12990787977259693 )
        SY1R    =(L =.15  K2 =-2.4861343126513926  SK2 =.00040614404706898477 )
        SY2R    =(L =.15  K2 =-1.555921005688643   SK2 =.00040614404706898477 )
        SF1     =(L =.3   K2 =-.0018378920752986161     SK2 =-.003778489584463251 )
        SD1     =(L =.3   K2 =-1.3309106132428754  SK2 =.011581924736584658 )
        SF2     =(L =.3   K2 =.7225544044124963    SK2 =-.012524023729466191 )
        SD2     =(L =.3   K2 =-.8925574063747068   SK2 =.01818732989816369 )
        SF3     =(L =.3   K2 =.3311536659611635    SK2 =-.0032248572609732355 )
        SD3     =(L =.3   K2 =-2.495123342807774   SK2 =.008905674058843679 )
        SF4     =(L =.3   K2 =.3295793389826938    SK2 =.004821595080628668 )
        SD4     =(L =.3   K2 =-.013195038862246425 SK2 =-.0069964418159970815 )
        SF5     =(L =.3   K2 =.3094859275010519 )
        SF6     =(L =.3   K2 =.1363591698921174 )
        SD5     =(L =.3   K2 =-.612613173109864 )
        SF7     =(L =.3   K2 =.07888455273129016 )
        SD6     =(L =.3   K2 =-2.5544155263455037 )
        SF8     =(L =.3   K2 =.26454178455061067 )
        SD7     =(L =.3   K2 =-2.4889625367760035 )
        SF9     =(L =.3   K2 =1.431658395097991 )
        SD8     =(L =.3   K2 =-.6151277677809518 )
        SF10    =(L =.3   K2 =1.1905300549991875 )
        SD9     =(L =.3   K2 =-.608442593325543 )
        SF11    =(L =.3   K2 =1.0082038988032298 )
        SD10    =(L =.3   K2 =-.5686413676605925 )
        SF12    =(L =.3   K2 =.23832436580217425 )
        SD11    =(L =.3   K2 =-.04784161034984496 )
        SF13    =(L =.3   K2 =.3136340026747212 )
        SD12    =(L =.3   K2 =-2.4879163097411396 )
        SF14    =(L =.3   K2 =.48424945972745526 )
        SD13    =(L =.3   K2 =-.7647687275529765 )
        SF15    =(L =.3   K2 =.002518698749602 )
        SD14    =(L =.3   K2 =-2.4307402218682945 )
        SF16    =(L =.3   K2 =.35510513860129855 )
        SD15    =(L =.3   K2 =-.6248767248745793 )
        SF17    =(L =.3   K2 =.006974886431253856 )
        SD16    =(L =.3   K2 =-2.5123028212050453 )
        SF18    =(L =.3   K2 =.7725352471545383 )
        SD17    =(L =.3   K2 =-.7288011122818383 )
        SF19    =(L =.3   K2 =.7377736848355319 )
        SD18    =(L =.3   K2 =-2.414622301353649 )
        SF20    =(L =.3   K2 =.007458380046689358 )
        SD19    =(L =.3   K2 =-.6023167134124973 )
        SF21    =(L =.3   K2 =.0498469297884829 )
        SD20    =(L =.3   K2 =-2.513067206829992 )
        SF22    =(L =.3   K2 =.008797525382107485 )
        SD21    =(L =.3   K2 =-.9624340692706442 )
        SF23    =(L =.3   K2 =-.008904927537938655 )
        SD22    =(L =.3   K2 =-2.4139867781818296 )
        SF24    =(L =.3   K2 =.7090236505684648 )
        SD23    =(L =.3   K2 =-.5382389473834926 )
        SF25    =(L =.3   K2 =.011582429764451844 )
        SD24    =(L =.3   K2 =-2.7192002370616377 )
        SF26    =(L =.3   K2 =.05403756051934819 )
        SD25    =(L =.3   K2 =-.7923579452286073 )
        SF27    =(L =.3   K2 =.00040589800155594246 )
        SD26    =(L =.3   K2 =-1.4130823681758942 )
        SF28    =(L =.3   K2 =.2500459743603647 )
        SD27    =(L =.3   K2 =-.6064340910295676 )
        SF29    =(L =.3   K2 =.0008887035328678805 )
        SD28    =(L =.3   K2 =-2.4907722250023534 )
        SF30    =(L =.3   K2 =.014042176350705364 )
        SD29    =(L =.3   K2 =-2.2507152286705523 )
        SF31    =(L =.3   K2 =-.006784323627947953 )
        SD30    =(L =.3   K2 =-.4154145026022379 )
        SF32    =(L =.3   K2 =1.1543668462161312 )
        SD31    =(L =.3   K2 =-.5225213410515582 )
        SF33    =(L =.3   K2 =.010077539558941745 )
        SD32    =(L =.3   K2 =-1.375124283837684 )
        SF34    =(L =.3   K2 =.8945289874184555 )
        SD33    =(L =.3   K2 =-.002845918328106817 )
        SF35    =(L =.3   K2 =.48094397172523184 )
        SD34    =(L =.3   K2 =-2.490681515230095 )
        SF36    =(L =.3   K2 =.002524129282976616 )
        SD35    =(L =.3   K2 =-.5211940964213199 )
        SF37    =(L =.3   K2 =.6518120226265296 )
        SD36    =(L =.3   K2 =-2.4979125740072714 )
        SF38    =(L =.3   K2 =.008522408334850663 )
        SD37    =(L =.3   K2 =-.8032711862448089 )
        SF39    =(L =.3   K2 =.3291073325029764 )
        SD38    =(L =.3   K2 =-2.4603212574452424 )
        SF40    =(L =.3   K2 =.08186325642587486 )
        SD39    =(L =.3   K2 =-.5351253862556548 )
        SF41    =(L =.3   K2 =.3191891711675733 )
        SD40    =(L =.3   K2 =-2.4655623196492487 )
        SF42    =(L =.3   K2 =.3153096610690947 )
        SD41    =(L =.3   K2 =-.11192700502159118 )
        SF43    =(L =.3   K2 =.18579716595110848 )
        SD42    =(L =.3   K2 =-2.011265721536599 )
        SF44    =(L =.3   K2 =.49564332413222945 )
        SD43    =(L =.3   K2 =-.4792086142961443 )
        SF45    =(L =.3   K2 =.19242977200088204 )
        SD44    =(L =.3   K2 =-2.3147938898418756 )
        SF46    =(L =.3   K2 =.42890602203929207 )
        SD45    =(L =.3   K2 =-.15819504071450396 )
        SF47    =(L =.3   K2 =1.1575878476353298 )
        SD46    =(L =.3   K2 =-.17308671762527736 )
        SF48    =(L =.3   K2 =.13143095890467663 )
        SD47    =(L =.3   K2 =-1.2766961686450404 )
        SF49    =(L =.3   K2 =.5104083414334588 )
        SD48    =(L =.3   K2 =-.43316065042491453 )
        SF50    =(L =.3   K2 =.4002988832275381 )
        SD49    =(L =.3   K2 =-2.4854192994047786 )
        SF51    =(L =.3   K2 =.13556959783552122 )
        SD50    =(L =.3   K2 =-2.2931091718379673 )
        SF52    =(L =.3   K2 =1.2192337233700297 )
        SD51    =(L =.3   K2 =-1.0142640020927953 )
        SF53    =(L =.3   K2 =.10948865441352726 )
        SD52    =(L =.3   K2 =-2.5207746621544485 )
        SF54    =(L =.3   K2 =.4267908418815647 )
        SD53    =(L =.3   K2 =-.807687530930095 )
        SF55    =(L =.3   K2 =.12231234995624524 )
        SD54    =(L =.3   K2 =-2.399785253497103 )
        SF56    =(L =.3   K2 =.8942449404700975 )
        SD55    =(L =.3   K2 =-.5715796703539946 )
        SF57    =(L =.3   K2 =.4629359983684235 )
        SD56    =(L =.3   K2 =-1.9129295289841963 )
        SF58    =(L =.3   K2 =.1819734855733319 )
        SD57    =(L =.3   K2 =-1.255616441318745 )
        SF59    =(L =.3   K2 =.5786726732698813 )
        SD58    =(L =.3   K2 =-2.500317906297674 )
        SF60    =(L =.3   K2 =.37546379509739514 )
        SD59    =(L =.3   K2 =-.9867743365388718 )
        SF61    =(L =.3   K2 =1.424059970633325 )
        SD60    =(L =.3   K2 =-2.2794871175670206 )
        SF62    =(L =.3   K2 =.6301195106150862 )
        SD61    =(L =.3   K2 =-.5704271420213883 )
 ;
 SOL    ES5L    =(BZ =0   BOUND =1  CHI1 =-1.7552808543847543e-30 CHI2 =1.565316886525947e-18   CHI3 =-5.739718505607433e-42
           F1 =.1 )
        ES4L    =(BZ =2   BOUND =1  GEO =1    F1 =.1 )
        ES3L    =(BZ =0   DX =-.12300930898036751  DY =-.0002538769268126098     DZ =.0009225918399370322 BOUND =1
           CHI1 =.014999860486229361     CHI2 =3.855520838293599e-05   CHI3 =5.783661239212453e-07   F1 =.3 )
        ES2L    =(BZ =0   F1 =.1 )
        ES1L    =(BZ =-2  DPX =-.015     BOUND =1  CHI1 =-.014999999999999998    GEO =1 )
        ES1R    =(BZ =2   DPX =-.015     BOUND =1  CHI1 =.015000000000000003     CHI2 =6.7739766319572634e-21
           CHI3 =9.316218938183237e-23   GEO =1 )
        ES2R    =(BZ =0   F1 =.1 )
        ES3R    =(BZ =0   DX =.12300930898036751   DY =-.0002538769268126098     DZ =.0009225918399370322 BOUND =1
           CHI1 =-.01499986047507985     CHI2 =3.855954616984789e-05   CHI3 =-8.456021480328656e-24  F1 =.3 )
        ES4R    =(BZ =-2  BOUND =1  CHI1 =-3.469446951953474e-18  CHI2 =-1.5585406229479126e-18 CHI3 =-1.0587911840678754e-22
           GEO =1    F1 =.1 )
        ES5R    =(BZ =0   BOUND =1  CHI1 =-3.469446951953474e-18  CHI2 =-1.5585406229479126e-18 CHI3 =-1.0587911840678754e-22
           F1 =.1 )
 ;
 CAVI   CA1     =(VOLT =2.3e+08     FREQ =4e+08 )
 ;
 MARK   FRF     =(AX =-6.497526077493925e-11  BX =128.50282110912633   AY =1.3407807532480336e-12    BY =68.62426528390851
           EX =-2.325162375713576e-13    EPX =-4.066291417517785e-15   EY =-6.655860397244659e-14    EPY =-1.957849418821538e-15
           R1 =1.9489054973698927e-14    R2 =8.358061307367112e-12     R3 =1.3801079170694214e-16    R4 =4.8126021557656385e-14
           DX =-2.3597715368888125e-15   DPX =-6.067521246947665e-18   DY =-4.959574132869295e-15    DPY =-1.6592184315980154e-16
           DZ =-2.160737548591084e-18    DP =.002  SIGZ =.002421164689919274     EMITX =2.001328571535183e-09
           EMITY =1.911365335952142e-16 )
        FRD     =(AX =.4872838195757661  BX =46.14858179005177    PSIX =.5496291912461447  AY =-1.8358866166204117
           BY =176.02075154775167   PSIY =.376152451687394   EX =-2.833009966252787e-13    EPX =-1.2270172272889039e-15
           EY =-1.690490723737885e-13    EPY =-2.7727009993119138e-15  R1 =2.098337840287773e-13     R2 =5.963033168255981e-12
           R3 =2.2036933049004922e-15    R4 =6.159696519436724e-14     DX =-1.4499406208535435e-15   DPX =2.2683444199407662e-17
           DY =-1.4086530091801884e-14   DPY =-2.2670200793503214e-16  DZ =-2.1607375485921283e-18   DP =.002
           EMITX =2.001328571535183e-09  EMITY =1.911365335952142e-16 )
        F0      =(AX =-2.3613829281567265     BX =119.2726196639105    PSIX =9.390936085261233  AY =.4826301786515801
           BY =22.361907650221106   PSIY =8.245612857436031  EX =.24701996626126604   EPX =.004910913175087478
           EY =-1.3644329162487004e-13   EPY =2.3858263590166883e-15   R1 =6.370519193125802e-16     R2 =-7.257366509700971e-14
           R3 =-4.942377074111186e-15    R4 =2.2474723845763867e-13    DX =2.2458995368333993e-15    DPX =3.756812424283565e-17
           DY =-4.92700814599871e-15     DPY =-1.2162604564655423e-16  DZ =-4.046560025968695e-19    DP =.002
           EMITX =2.001328571535183e-09  EMITY =1.911365335952142e-16 )
        PSDC    =(AX =.466087110947075   BX =22.077283101219226   PSIX =10.208006522571822 AY =-2.377913986535102
           BY =120.6946025748505    PSIY =8.98333607789377   EX =.12250462479833896   EPX =-.0023558358394815855
           EY =-2.066109381543861e-13    EPY =-6.2089801608459935e-15  R1 =1.0245033086814669e-13    R2 =-1.7174950084682442e-12
           R3 =1.2993893732693044e-15    R4 =-1.9612047269336092e-14   DX =9.164436201659248e-16     DPX =1.5895609175006732e-18
           DY =-5.047152542800879e-16    DPY =-1.4634496818624144e-16  DZ =-4.502910953296336e-18    DP =.002
           EMITX =2.001328571535183e-09  EMITY =1.911365335952142e-16 )
        PSFC    =(AX =-2.3779235122263143     BX =120.69441159062242   PSIX =14.100824675657531 AY =.4660895698815381
           BY =22.07729172592003    PSIY =12.944499557276488 EX =.24849324021307892   EPX =.004910913175075953
           EY =2.3743631096503807e-14    EPY =6.748297043727797e-15    R1 =1.5904708730326165e-14    R2 =1.346077292070179e-12
           R3 =-7.279184968103946e-15    R4 =-3.4618961371738855e-14   DX =-8.400931834322001e-16    DPX =-3.5379715190101165e-17
           DY =-4.998607388044079e-15    DPY =3.3035278138566665e-16   DZ =2.5409103331459457e-18    DP =.002
           EMITX =2.001328571535183e-09  EMITY =1.911365335952142e-16 )
        PQY1    =(AX =-1.4270806758531762e-11 BX =62.45050410671894    PSIX =494.5496747325151  AY =-2.0518475807307368e-11
           BY =10.803897636121913   PSIY =493.9195780859876  EX =-.04803831157975577  EPX =.002122374485446103
           EY =2.0837694495035715e-12    EPY =7.517391135842025e-15    R1 =3.9574107033946844e-14    R2 =9.055537748168102e-10
           R3 =1.1648281736946184e-15    R4 =-1.3620191402095524e-15   DX =1.0786986208749878e-15    DPX =2.2863134388904425e-17
           DY =4.392448599756193e-15     DPY =-2.0676040084445872e-16  DZ =1.883497833750616e-18     DP =.002  OFFSET =1.5
           EMITX =2.001328571535183e-09  EMITY =1.911365335952142e-16 )
        IP      =(AX =6.338787927879912e-11   BX =.9999999999477834    PSIX =499.2621125552088  AY =-1.7188862049646185e-11
           BY =.0009999999999739469 PSIY =500.20276339319116 EX =2.976450602676524e-15     EPX =-3.6724095985879814e-14
           EY =-9.5215312534821e-15 EPY =7.661456034320754e-13    R1 =-7.162085382238075e-13    R2 =-3.3156319425926516e-15
           R3 =-1.717248251658304e-14    R4 =-9.592368505452298e-13    DX =2.4222956936821597e-16    DPX =-1.5439038936193583e-16
           DY =4.8368969420009486e-17    DPY =-2.14869507286486e-14    DZ =-1.814399843422904e-18    DP =.002
           SIGZ =.001218123355690918     EMITX =2.001328571535183e-09  EMITY =1.911365335952142e-16 )
        FG      =(AX =-2.3725353594286727     BX =152.4255821019044    PSIX =510.0399745147293  AY =.46818435770220806
           BY =28.034186599080442   PSIY =513.0758731454988  EX =.305687697597934     EPX =.004773596490557341
           EY =-3.1653113869577075e-12   EPY =8.578599218626817e-14    R1 =-2.373146302681927e-14    R2 =-9.804344611886106e-13
           R3 =8.691161133978564e-16     R4 =4.4710911396140545e-14    DX =-2.5354029202983125e-15   DPX =-2.8783829455518734e-18
           DY =9.827918968111872e-15     DPY =-1.405301199391534e-16   DZ =9.298289600811113e-18     DP =.002
           EMITX =2.001328571535183e-09  EMITY =1.911365335952142e-16 )
        PSFGC   =(AX =-2.3921056689078775     BX =154.56967056465587   PSIX =510.0429062318561  AY =.4486140211483136
           BY =27.621627328597707   PSIY =513.0920451120237  EX =.30783581601867865   EPX =.0047735964905572395
           EY =-3.1266444519198525e-12   EPY =8.57859921862664e-14     R1 =-2.3340052125369087e-14   R2 =-9.498114118600235e-13
           R3 =8.732314523467237e-16     R4 =4.431950049469032e-14     DX =-2.5366981926238104e-15   DPX =-2.878382945551867e-18
           DY =9.764680414139253e-15     DPY =-1.405301199391533e-16   DZ =9.29828960081111e-18 DP =.002  OFFSET =1.5
           EMITX =2.001328571535183e-09  EMITY =1.911365335952142e-16 )
        PSDGC   =(AX =.44861172418183837 BX =27.621618152199453   PSIX =513.9472329608398  AY =-2.3920968101711018
           BY =154.5699068972531    PSIY =517.0417000164693  EX =.15005282268321832   EPX =-.0022878256423082667
           EY =3.3899094165194516e-12    EPY =7.519238837294728e-15    R1 =-2.123157542161525e-14    R2 =7.510503315113297e-13
           R3 =-1.0518454562700414e-14   R4 =-1.3104900274098363e-14   DX =-8.708199140274753e-16    DPX =-7.52436307705876e-17
           DY =-1.681243286300016e-14    DPY =-1.5742290229992587e-16  DZ =-1.5297697882150574e-17   DP =.002  OFFSET =1.5
           EMITX =2.001328571535183e-09  EMITY =1.911365335952142e-16 )
        F1      =(AX =-2.3613859026829234     BX =119.2795956977634    PSIX =549.3750470908324  AY =.4826263252674588
           BY =22.363100318417477   PSIY =552.8935105441293  EX =.24703410599438416   EPX =.004910912047891061
           EY =1.4907165483559898e-12    EPY =4.253318173496615e-14    R1 =1.066400138465804e-13     R2 =-5.129864502454964e-12
           R3 =-9.377982387760441e-17    R4 =2.5490310230760185e-15    DX =5.139089641100614e-15     DPX =1.1774435593192578e-16
           DY =-4.0665333191691666e-15   DPY =-2.610892263725206e-16   DZ =1.768429102410319e-18     DP =.002
           SIGZ =.021340386968833242     EMITX =2.001328571535183e-09  EMITY =1.911365335952142e-16 )
 ;
    LINE FQCELL =(F0 LF03 PSFC SF1 LF03
       QF2 LXSX B1 LXSX
       QD1 LXSX B1 LXSX
       QF2 LXSX B1 LXSX
       QD1 LXSX B1 LF03 PSFC SF1 LF03
       QF2 LXSX B1 LF03 PSDC SD1 LF03
       QD1 LXSX B1 LXSX
       QF2 LXSX B1 LXSX
       QD1 LXSX B1 LXSX
       QF2 LXSX B1 LF03 PSDC SD1 LF03
       QD1 LXSX B1 )
     FQCELL2 =(F1 LF03 PSFGC SF1 LF03
       QF4 LXSX B2 LXSX
       QD3 LXSX B2 LXSX
       QF4 LXSX B2 LXSX
       QD3 LXSX B2 LF03 PSFGC SF1 LF03
       QF4 LXSX B2 LF03 PSDGC SD1 LF03
       QD3 LXSX B2 LXSX
       QF4 LXSX B2 LXSX
       QD3 LXSX B2 LXSX
       QF4 LXSX B2 LF03 PSDGC SD1 LF03
       QD3 LXSX B2 )
     FQCELLG =(FG LF03 PSFGC SF1 LF03
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LXSX
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LF03 PSFGC SF1 LF03
       QFG2 LXSX BG1 LF03 PSDGC SD1 LF03
       QDG1 LXSX BG1 LXSX
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LXSX
       QFG2 LXSX BG1 LF03 PSDGC SD1 LF03
       QDG1 LXSX BG1 )
     FQCELLG1 =(FG LF03 PSFGC SF1 LF03
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LXSX
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LF03 PSFGC SF1 LF03
       QG2 LXSX BG2 LF03 LXSX LF03
       QG3 LXSX BG2 LXSX
       QG4 LXSX BG2 LXSX
       QG5 LXSX BG2 LXSX
       QG6 LXSX BG2 LF03 LXSX LF03
       QG7 LXSX BG2 F1)
     RFCELL = (FRF QRF LRF CA1 LRF FRD QRD LRF CA1 LRF QRF)
     DSUPP = (F1 LF03 QH6 LH3 QH5 LF03 BH3 LF03 QH4 LF03 BH2 QH3 LH2 QH2 LH1 QH1 LF03 BH1 LH0 BH0)
     DSUPP1 = (F0 LF03 QI6 LF03 BI3 LF03 QI5 LF03 BI2 LF03 QI4 LI3 QI3 LI2 QI2 LF03  BI1 LH0 BI0)
     DSUPPC = (
       LS2 QS3 LS3 QS4 LS4 LF03 BS LF03 QS5 LF03 BS)
     DSUPPL = (
       LL2 QL3 LL3 QL4 LL4 LF03 BL LF03 QL5 LF03 BL)
     ARCG=(-FQCELLG1 -FQCELLG -FQCELLG -FQCELLG -FQCELLG DSUPPC)
     COL = (IP ES1R LX1 ES2R LX2 QC1R1 QC1R2 LF03 QC2R1 QC2R2 LX3 ES3R ES4R LX4 ES5R
       QK1R 
       LC2 QK2R LF03 BV2 LF03 QK3R LF03 QC3 LF03 BW LF03 QK4R LF03  QC4 LF03 BC1 
         LF03 QK5R LF03  QC5 LC3 QK6R LF03 QC6  LC4 QK7R LF03 QC7 LF03 SY1R SY1R
       LY1 QY2 LF03 BC3 LF03 PQY1 QY1 LF03 BC3 LF03 QY2 LY1 SY2R SY2R
       LF03 QA1 LA1 
       QA2 LA2 QA3 LA3 QA4 LA4 QA5 LA5 QA6 LA6 -ARCG)
     COLL = (IP ES1L LX1 ES2L LX2 -QC1L1 -QC1L2 LF03 -QC2L1 -QC2L2 LX3 ES3L ES4L LX4 ES5L
       QK1L 
       LC2 QK2L LF03 BV2 LF03 QK3L LF03 QC3 LF03 BWL LF03 QK4L LF03  QC4  LF03 BC1L 
         LF03 QK5L LF03  QC5 LC3 QK6L LF03 QC6 LC4 QK7L LF03 QC7 LF03 SY1L SY1L
       LY1 QY2 LF03 BC3L LF03 PQY1 QY1 LF03 BC3L LF03 QY2 LY1 SY2L SY2L
       LF03 QB1 LB1 QB2 LB2 QB3 LB3 QB4 LB4 QB5 LB5 QB6 LB6 -DSUPPL 2*FQCELL)
     IR=(-F0 -FQCELL -FQCELL -COLL COL)
     TTH = ( LT3 QT3 LT4 QT4 LT5 QT5 LT6 QT6 )
     RFSECTION=(DSUPP  -TTH QRF RFCELL QRF TTH -DSUPP1)
;
 ;
FFS USE=FQCELL;

wdir=Catch[If[DirectoryQ[#],Throw[#]]&/@{
  "/Users/oide/FCCee",
  "/Volumes/oide-p73/FCCee",
  "/users/oide/FCCee",
  "/Users/oide/Documents/SuperTRISTAN"}];

Get[wdir//"/Optimize.n"];

sk2s="SY1*|S{FD}{1234}|S{FD}12{0123}|SD119";
ol=OptimizeLifetime[
  dir->wdir,
  DARange->50,turns->100,wz->15,nz->9,
  wpoint->40,wpoint1->60,wth->-20,
  damp->True,
  fname->Fetch,
  elm->{
!    {"$$$","NX"},{"$$$","NY"},
    {"S{FD}*|SY1*","K2"} , {sk2s,"SK2"},
    {"SY*","K3"}
  (*  ,{"QC{12}","K3"} *) 
      }
  ];
  dr:=FFS["draw bx by & ex ey q*;"];
  elm0=ol@elm;

Get["stlib.sad"];

NPARA=12;
ring;rfsw;cod;noradcod;
CONVERGENCE=1e-22;
MINCOUP=1e-3;
PBUNCH=1e15;;
Brho=MOMENTUM/SpeedOfLight;
bqmax=0.8;
bsmax=0.6;
adp=0.02;

{bx0,by0}={1,0.001};

QL[a_,sige_,td_]:=td*(sige/a)^2*Exp[(a/sige)^2/2];

Circ=100e3;
lstr=11000;
nsp=4;
nbsp=4;
nbend=2440;
ncell=nbend/10;
lcell=(Circ-lstr)/ncell;
ba=(2*Pi-0.0488)/nbend;
rffreq=400e6;
{nxc,nyc}={0.25,0.25}
ca1Vc=230e6;

s* dx 0;
dsep=0.8;

lb1=lcell/10-0.6-1.8;
B1 L lb1;
B1 ANGLE ba;
save ;
rho=LINE["L","B1"]/LINE["ANGLE","B1"];
Element["L","LXSX"]=Element["L","LF03"]*2+Element["L","SF1"];
emit0=2e-9;
alpha0=8e-6;
bmax=170;
fit nx 1.25 ny 1.25;

cell; free q*
go;
save all;
t f0;
unitcell=ExtractBeamLine[];

use FQCELL2;
cell 
b2 l lb1+dsep*ba;
b2 angle ba;
fit nx 1.25 ny 1.25;
free q*;go;
save all;
t f1;

unitcell1=ExtractBeamLine[];

USE RFCELL;

cell fit nx 0.15 ny 0.15;
free q* cal;
!end
save all ;

lrfc=LINE["S","$$$"];
rfcell=ExtractBeamLine[];

hse0=150e3/0.1/MOMENTUM;
lse0=50;
lh0=0.05/hse0/lse0-lse0/2;

dsupp=ExtractBeamLine[DSUPP];
dsupp1=ExtractBeamLine[DSUPP1];

bxmqt=420;
bymqt=420;

USE RFSECTION;
LINE["L","BH0"]=lse0;
LINE["ANGLE","BH0"]=-hse0*lse0;
LINE["L","BI0"]=lse0;
LINE["ANGLE","BI0"]=hse0*lse0;
LINE["L","LH0"]=lh0;

ins;
fcrsr:=FFS["\
fit frf ax 0 bx @ ay 0 by @ ex 0 epx 0 chi1 0;\
fit f1 f0  bxm bxmqt*0.95 bym bymqt*0.95;"];xs
fcrsl:=FFS["\
fit f0 ax @- bx @ ay @- by @ ex @ epx @- gy dsep chi1 0;\
fit f1 f0  bxm bxmqt*0.95 bym bymqt*0.95;\
fit qrd leng 550;"];
fcrsr;fcrsl;
free q{hit}* l{hit}{^0}* b{hi}{123} b{hi}{123} l ;
fix bi{13} l;
bi3 minmax 0.0027;
q{hitu}{2468} min 0 max 0.05;
q{hitu}{1357} min -0.05 max 0;
l{htu}* min 5;
li{^1} min 5;
li1 min 0.3;

dleng=0;
dltol=0.0001
FitValue["QRD","LENG",_,_,v_]:=(LINE["S","F0"]+dleng)/2-0.3;

cal;
!end

save all;
Clear[FitValue];

nrfc=Ceiling[11e9/2/8e6/lrfc]+1;
rfs=ExtractBeamLine[];
p=Position[rfs,FRF,1,1];
rfs=Insert[rfs,(nrfc-1)*rfcell,p[[1,1]]];
pfrf=nrfc/2+1;
p=Position[rfs,FRF,1,pfrf][[-1,1]];
rfsr=Take[rfs,p];
rfsl=Drop[rfs,p-1];

dsuppc=ExtractBeamLine[DSUPPC];
dsupp1=ExtractBeamLine[DSUPP1];

  nysdr=2.68;
  nysdl=2.68;
  exsy1=0.15;
  bxsy1=20;
  bysy1=5000;
  bymqc=1700;
  bxmqc=1400;
  bxmqb6=600;
  bymql5=600;
  exmqs=0.3;
  bymqg=160;

  fcc:=FFS["\
    fit qk3r chi2 0;\
    fit qk7r+1 r1 0 r2 0 r3 0 r4 0 ey 0 epy 0;"];
  fcg:=FFS["fit fit $$$ gx 3257 gy 109 chi1 6.6385;"];
  fca:=FFS["fit qfg2.1 qfg2.3 nx 0.5 ny 0.5;\
    fit qfg2 qfg2.2 ax 1 ay 1 bx 1 by 1 ex 1 epx 1;"];
  fclc:=FFS["fit ip ex 0 epx 0 ey 0 epy 0 r1 0 r2 0 r3 0 r4 0"];
  fcl:=FFS["  fit ip ax 0 ay 0 bx bx0 by by0 ;\
  fit F0 chi1 chi1ent/Degree;\
  fit qb6 ex 0 epx 0;\
  fit PSFC.8 qk1l+1 nx 1.5;\
  fit PSDC.8 ip ny nysdl;\
  fit qb6 bxm bxmqb6;\
  fit qb4 qb2 bxm bxmqb6*1.3;\
  fit ql5 bym bymql5;\
  fit qb5 qb3 bym bymql5*1.3;\
  "];
    fcr:=FFS["\
  fit F1 ax @; bx @; ay @ ;by @;ex @ epx @;\
  fit QK1R PSFGC nx 1.5;\
  fit ip psdgc ny nysdr;\
  fit qa3 bym 1500;\
  fit qa4 bxm 400;\
  fit qs4 exm exmqs;\
  fit qg2 qg7 bym bymqg;\
  "];
   fcz:=FFS["\
  fit IP SY1R.2 ny 0.75 nx 0.5;\
  fit sy1r.2 sy2r.2 nx 0.5 ny 0.5 ;\
  fit pqy1 ax 0 ay 0;\
  fit qy2.1 bxm 600;\
  fit sy1r.2 bx bxsy1 by bysy1 ex exsy1;\
  fit sy2r.1 ex 0 epx 0;\
  fit qc3 bym bymqc;\
  fit qc4 bxm bxmqc;\
  fit qc5 bym bymqc;\
  fit qc6 bxm bxmqc;\
  "];
  fc:=(fcc;fclc;fcg;fca;fcl;fcr;fcz);

 InitEnt[]:=(eyi=0; epyi=0; r1i=0; r2i=0; r3i=0; r4i=0; dxi=0; dpxi=0; dyi=0; dpyi=0);


USE COL
  ins;
  s* dx 0;
  bxi=bx0;
  byi=by0;
  InitEnt[];
  save ip;
  ins cal

(*
 qc1* l 1.6;
 qc2* l 1.25;
  fit qc1r2 pex 0 pepx Twiss["PEPX","QC1R1"];;
!  fit qc1r2 dx dxqc1r1+LINE["L","QC1R1"]*dpxqc1r1; dpx dpxqc1r1;
  free qc1r1 dx ;free qc1r1 chi1;
go
  rej total;fix *;
  qc1r2 chi1 LINE["CHI1","QC1R1"];
  fit qc1r2+1 pex 0;
  free qc1r2 dx;
go
  rej total;fix *;
  qc2r* chi1 LINE["CHI1","QC1R1"];
  fit qc2r2+1 pex 0 pepx Twiss["PEPX","QC1R1"];
  free qc2* dx;
go
end
  rej total;fix *;
  save all;
  fit lc2 r2 0;free qc2* rotate go
  save all;
  rej total ;fix *;
  fit bv2r+1 chi2 0;
  free bv* go;
  save all;
  rej total;fix *;
  VariableRange[_,"DY",_]:={-0.001,0.001};
*)
  uc=100e3;
  ltheta:=3/2/uc *MOMENTUM^3/MASS^2*ElectronRadius/FineStructureConstant;

  setev:=(ElementValues={
    "L"["BW"]:>ltheta*"ANGLE"["BW"],
    "L"["BC1"]:>ltheta*"ANGLE"["BC1"],
    "DY"["QC2R2"]:>"DY"["QC2R1"],
    "DY"["QC1R2"]:>"DY"["QC1R1"],
    "ROTATE"["QC2R2"]:>"ROTATE"["QC2R1"],
    "ROTATE"["QC1R2"]:>"ROTATE"["QC1R1"]
    });
  setev;
  coup qc1r2 qc1r1 1;
  coup qc2r2 qc2r1 1;

  fcc;fcr;fcz;fca;
  FFS["\
  LC* min 3 max 120;\
  lc2 min 24;\
  L{^CFXMSG}* min 6 max 60;\
  LY* min 20;\
  LA* min 10 max 40;\
  QK* minmax 5e-4;\
  Q{ABXY}{1357} min -0.07 max 0;\
  Q{ABXY}{2468} min 0 max 0.07;\
  QC{357}  min -0.07 max 0;\
  QC{468} min 0 max 0.05;\
  BV* minmax 2e-4;\
  BC{12} min 0 max 0.017;\
  BC3 min 0 max 0.017;\
  BC4 minmax 0.017;"]; !"


 free qy* ly* bc* bw qc* qc2* rotate lc* qa* la* qk* bv* qs* ls* bs* qg* q{df}g*;

 nxtol=0.0002;
 nxtols=0.0008;
 nytol=2e-6;
 bytol=0.2;
 FitValue["QC1.2","SY1R.2","NY",_,g_,v1_,v2_]:=If[Abs[(v2-v1)-g]<nytol*2*Pi,Null,v1];
 FitValue["IP","SY1R.2","NX",_,g_,v1_,v2_]:=If[Abs[(v2-v1)-g]<nxtol*2*Pi,Null,v1];
 FitValue["QC2.2","PSFGC","NX",_,g_,v1_,v2_]:=If[Abs[(v2-v1)-g]<nxtols*2*Pi,Null,v1];
 FitValue["SY1R.2","BY",_,g_,v_]:=If[Abs[v-g]>bytol*g,g,Null,Null];
 FitValue["SY1R.2","EX",_,g_,v_]:=If[v<g,g,Null,Null];

 drr:=FFS["draw IP SY1R.1 bx by & ex & ey & r1 r4 & r2 & r3 qk*;",6];
 rc:=FFS["fix *;free qc* lc* go;free qk* qc2* rotate  go;free bv* go;free bc* bw qy* ly* go;free qa* la* qs* ls* bs* go;",6];
 rr:=FFS["fix *;free bv* go;free qk* qc2* rotate go;free qc* lc* go;free bc* bw qy* ly* go;free qa* la* qs* ls* bs* go;",6];

 go;
!end

save all;
ElementValues=.;
Clear[FitValue];
*)

USE IR
  s* dx 0;
  InitEnt[];
  org ip 0 0 0 0.015/Degree 0 0;
  ins cal
  uc=100e3;
  ltheta:=3/2/uc *MOMENTUM^3/MASS^2*ElectronRadius/FineStructureConstant;
  chi1ent=(ncell/nsp-4)*10*ba-Pi/2;

  coup qc1r2 qc1r1 1;
  coup qc2r2 qc2r1 1;

  setev:=(ElementValues={
    "L"["BW"]:>ltheta*"ANGLE"["BW"],
    "L"["BC1"]:>ltheta*"ANGLE"["BC1"],
    "DY"["QC2R2"]:>"DY"["QC2R1"],
    "DY"["QC1R2"]:>"DY"["QC1R1"],
    "ROTATE"["QC2R2"]:>"ROTATE"["QC2R1"],
    "ROTATE"["QC1R2"]:>"ROTATE"["QC1R1"],
    "ANGLE"["BWL"]:>-"ANGLE"["BW"],
    "ANGLE"["BC1L"]:>-"ANGLE"["BC1"],
    "ANGLE"["BC3L"]:>-"ANGLE"["BC3"],
    "L"["BWL"]:>"L"["BW"],
    "L"["BC1L"]:>"L"["BC1"],
    "L"["BC3L"]:>"L"["BC3"],
    Null@@(With[{n=#},"K1"[n//"L"]:>"K1"[n//"R"]]&/@Table["QK"//i,{i,1,7}]),
    Null@@(With[{n=#},"ROTATE"[n//"L"]:>-"ROTATE"[n//"R"]]&/@Table["QK"//i,{i,1,7}]),
    Null@@(With[{n=#},"K1"[StringReplace[n,"R"->"L"]]:>"K1"[n]]&/@{"QC1R1","QC1R2","QC2R1","QC2R2"}),
    Null@@(With[{n=#},"DX"[StringReplace[n,"R"->"L"]]:>-"DX"[n]]&/@{"QC1R1","QC1R2","QC2R1","QC2R2"}),
    Null@@(With[{n=#},"DY"[StringReplace[n,"R"->"L"]]:>"DY"[n]]&/@{"QC1R1","QC1R2","QC2R1","QC2R2"}),
    Null@@(With[{n=#},"CHI1"[StringReplace[n,"R"->"L"]]:>"CHI1"[n]]&/@{"QC1R1","QC1R2","QC2R1","QC2R2"}),
    Null@@(With[{n=#},"ROTATE"[StringReplace[n,"R"->"L"]]:>-"ROTATE"[n]]&/@{"QC1R1","QC1R2","QC2R1","QC2R2"})
    });
  setev;

  FFS["\
  LC* min 3 max 120;\
  lc2 min 24;\
  L{^CFXMSGBL}* min 6 max 60;\
  LY* min 20;\
  LA* min 10 max 40;\
  QK* minmax 5e-4;\
  Q{ABXY}{1357} min -0.07 max 0;\
  Q{ABXY}{2468} min 0 max 0.07;\
  QC{357}  min -0.07 max 0;\
  QC{468} min 0 max 0.05;\
  BV* minmax 2e-4;\
  BC{12} min 0 max 0.017;\
  BC3 min 0 max 0.017;\
  BC4 minmax 0.017;\
  "];
  fc;

  vrl:=FFS[" free q{fd}G* bg* bg* l qg* qs* ls* bs* qa* la* ql* ll* bl* qb* lb*"];
  vz:=FFS["free qy* ly* bc* bw qc* qc2* rotate lc* qk* bv*"];
  vrl;vz;

 nxtol=0.0002;
 nxtols=0.0008;
 nytol=2e-6;
 bytol=0.2;
 FitValue["QC1R.2","SY1R.2","NY",_,g_,v1_,v2_]:=If[Abs[(v2-v1)-g]<nytol*2*Pi,Null,v1];
 FitValue["IP","SY1R.2","NX",_,g_,v1_,v2_]:=If[Abs[(v2-v1)-g]<nxtol*2*Pi,Null,v1];
 FitValue["QK1R","PSFGC","NX",_,g_,v1_,v2_]:=If[Abs[(v2-v1)-g]<nxtols*2*Pi,Null,v1];
 FitValue["SY1R.2","BY",_,g_,v_]:=If[Abs[v-g]>bytol*g,g,Null,Null];
 FitValue["SY1R.2","EX",_,g_,v_]:=If[v<g,g,Null,Null];
 FitValue["$$$","GX",_,_,_]:=-LINE["GX","^^^"]-dsep*Sin[chi1ent];
 FitValue["$$$","CHI1",_,_,_]:=-LINE["GEO","^^^"][[2,1]];
 FitValue["$$$","GY",_,_,_]:=LINE["GY","^^^"]-dsep*Cos[chi1ent];

 drr:=FFS["draw IP SY1R.1 bx by & ex & ey & r1 r4 & r2 & r3 qk*;",6];
 rc:=FFS["fix *;free qc* lc* go;free qk* qc2* rotate  go;free bv* go;free bc* bw qy* ly* go;free qa* la* qs* ls* bs* go;",6];
 rr:=FFS["fix *;free bv* go;free qk* qc2* rotate go;free qc* lc* go;free bc* bw qy* ly* go;free qa* la* qs* ls* bs* go;",6];
 rs:=FFS["rej total;fix *;vrl;fcl go;fclc go;fca fcg go;fcr go;fc go;",6];

 FFS$NumericalDerivative=1;
 rs;
 
!end

save all;
FFS$NumericalDerivative=0;
ElementValues=.;
Clear[FitValue];
ir=ExtractBeamLine[];

bxmt=bymt=300;

nqr=nsp/4;
QRINGR=BeamLine[ (ncell/nsp-4)*unitcell1, rfsr];
QRINGL=BeamLine[ (ncell/nsp-4)*unitcell, -rfsl];

FRINGA=BeamLine[-QRINGL, ir, QRINGR];

USE FRINGA;

ca1 freq 400e6 ;
ca1 ca1Vc;
cell cal emit;
!sigz0=2.4e-3;
!ca1 #ca1*(SIGZ/sigz0)^2;
save ca1;

dprs[dp_]:=Do[DP=k*0.001;If[ol@RelaxStab[,True],,DP=DP-0.001;FFS["calc",6];Break[]],{k,1,Round[dp/0.001]}];
dprs1[dp_]:=Do[DP=k*0.001;If[ol@RelaxStab[,False],,Break[]],{k,1,Round[dp/0.001]}];
dprs[dp0_,dp_]:=Do[DP=k*0.001;If[ol@RelaxStab[,True],,DP=DP-0.001;FFS["calc",6];Break[]],{k,Round[dp0/0.001],Round[dp/0.001]}];
dprs1[dp0_,dp_]:=Do[DP=k*0.001;If[ol@RelaxStab[,False],,Break[]],{k,Round[dp0/0.001],Round[dp/0.001]}];
CONVERGENCE=1e-20;

ol@AdjustTune[nx_,ny_]:=Module[{},
  FFS["reset qt* qr{fd};reject total;FIT $$$ nx "//nx//" NY "//ny//";\
       fit ip ax 0 ay 0 bx bx0 by by0;\
       fit qt3 qt6 bxm bxmqt bym bymqt;\
       fit frf frf.2 bx 1 by 1;\
       fix *; free qt* qr{fd};\
       go;",6]];

!{nx0,ny0}=Twiss[{"NX","NY"},"$$$"]/2/Pi;
{nx0,ny0}=Floor[Twiss[{"NX","NY"},"$$$"]/2/Pi] +{.53,.570}
 ol@AdjustTune[nx0,ny0];
!end

save all;;
ElementValues=.;

fringa=ExtractBeamLine[];

With[{s=#},Module[{},
  sp=LINE["POSITION",s//"*"];
  ns=Length[sp]/2;
  Do[SetElement[s//i,"MULT",{"L"->LINE["L","SF1"]}],{i,ns}];
  sl=Table[Symbol[s//i],{i,ns}];
  sl=Flatten[Thread[{sl,sl}]];
  sl=RotateRight[sl,61*2];
  pt=Range[ns*2];
  MapThread[(fringa[[sp[[#]]]]=#2)&,{pt,sl}];
!  (fring[[sp[[#]]]]=LXS)&/@pdt;
  ]]&/@{"SF","SD"};


 wfmin=0.1;
 wdp=1;
 fw[x_]:=(1-4(1-wfmin)*x*(1-x));
! FitWeight[_,"DX"|"DY"|"DPX"|"DPY",{_,dp_},w_]:=With[{r=(dp/DP)^2*wdp},w*fw[r]*worb];
! FitWeight["$$$","NX"|"NY",_,w_]:=w*10;
 FitWeight[_,_,{_,dp_},w_]:=With[{r=(dp/DP)^2*wdp},w*fw[r]];
 da:=DynamicApertureSurvey[{{0,10},{0,0.1},Range[-10,10,1]},100,Output->6];

use fringa;

sxshift[]:=(
  Do[LINE["K2","SF"//i]=LINE["K2","SF"//i-4],{i,125,66,-1}];
  Do[LINE["K2","SF"//i]=0,{i,62,65}];
  Do[LINE["SK2","SF"//i]=LINE["SK2","SF"//i-4],{i,125,66,-1}];
  Do[LINE["K2","SD"//i]=LINE["K2","SD"//i-4],{i,124,65,-1}];
  Do[LINE["K2","SD"//i]=0,{i,61,64}];
  Do[LINE["SK2","SD"//i]=LINE["SK2","SD"//i-4],{i,124,65,-1}]);

cell cal;

thetax=Abs[LINE["CHI1","ES1L"]];
kcw=-1/(2 thetax Twiss["BY","IP"] Twiss["BY","SY2R.2"])* Sqrt[Twiss["BX","IP"]/Twiss["BX","SY2R.2"]]
ol@fcw=1;

rej total;fix *;
setev:=(ElementValues={
  "K2"["SY2R"]:>"K2"["SY1R"]-kcw*ol@fcw/2,
  "K2"["SY2L"]:>"K2"["SY1L"]+kcw*ol@fcw/2,
  "SK2"["SY2R"]:>"SK2"["SY1R"],
  "SK2"["SY2L"]:>"SK2"["SY1L"]});
setev;

dxmr=0*Sqrt[EMITX*Twiss["BX","$$$"]]/5;
dpxmr=0*Sqrt[EMITX/Twiss["BX","$$$"]]/5;
dymr=0*Sqrt[EMITX*MINCOUP*Twiss["BY","$$$"]];
dpymr=0*Sqrt[EMITX*MINCOUP/Twiss["BY","$$$"]];
fc:=FFS["fit $$$ nx nx0 24 ny ny0 24;\
  fit frf.11  bx @ 24 by @ 24 ax 0 24 ay 0 24;"];
fci:=FFS["fit ip bx bx0 24 ax 0 24 dx 0 24 dpx 0 24;"];
fcd:=FFS["fit frf.11 dx dxmr 24 dpx dpxmr 24;"]; 
fcs:=FFS["FIT frf.11 r1 0 24 r2 0 24 r3 0 24 r4 0 24 dy dymr 24 dpy dpymr 24;"];
vs:=FFS["FREE "//sk2s//" sk2;"];
vfs:=FFS["FIX "//sk2s//" sk2;"];
xweight=1/3;
yweight=1/10;
rweight=1/30;
dxweight=1/10;
dyweight=1/20;
FitWeight[_,"AX"|"BX",_,w_]:=w*xweight;
FitWeight[_,"AY"|"BY",_,w_]:=w*yweight;
FitWeight[_,"R1"|"R2"|"R3"|"R4",_,w_]:=w*rweight;
FitWeight[_,"DX"|"DPX",{_,dp_},w_]:=w*(dp/DP)^2;
FitWeight[_,"DX"|"DPX",{_,dp_},w_]:=w*(dp/DP)^2*dxweight;
FitWeight[_,"DY"|"DPY",{_,dp_},w_]:=w*(dp/DP)^2*dyweight;
s* minmax 2.5;
sd* max 0;sf* min 0;
fitp 24;
vary k2 s{fdxy}*;
DP=0.002;free s{fd}*|sy1*;free sy* sk2;fix sy* sk2;
intra ol@emit=Emittance[Output->6];

!dprs[0.002];
!ol@SetupChroma["S*",{0,0}];
reset;

Get["~/SAD/oldsad/Packages/rational.n"];

DP=0.02;

so=SynchroOptics[olx->ol];


end


!
!nointra radcod codplot emit;
!rad nofluc;
!
!end

e=Emittance[Output->6];
{alpha,sige,bh,damp}={MomentumCompaction,MomentumSpread,BucketHeight,DampingRate}/.e;

nus=Sqrt[Vc/MOMENTUM*2*Pi*rffreq*Circ/SpeedOfLight*alpha]/2/Pi
sigz=sige*alpha*Circ/2/Pi/nus
tau=QL[bh,sige,Circ/SpeedOfLight/damp[[3]]]

 Turns =100 Maximum number of particles =266
 Range    Xmin:   0.000 Xmax:  50.000
         (Ymin:   0.000 Ymax:   1.581)
          Zmin: -15.000 Zmax:  15.000
 Display:    10 turns/character
      NZ     0----|----1----|----2----|----3----|----4----|----5
   -15.00  2 AA        .         .         .         .         .
   -14.77  3 AAA       .         .         .         .         .
   -14.10  7 AAAAAAA   .         .         .         .         .
   -12.99  9 **AAAAAAA .         .         .         .         .
   -11.49  9 **AAAAAAA1.         .         .         .         .
    -9.64  9 **AAAAAAA21         .         .         .         .
    -7.50 10 ***AAAAAAA1         .         .         .         .
    -5.13 12 *****AAAAAAA1       .         .         .         .
    -2.60 19 ************AAAAAAA .         .         .         .
     0.00 41 **********************************AAAAAAA211A     .
     2.60 11 ****AAAAAAA1111     .         .         .         .
     5.13  8 *AAAAAAA11111       .         .         .         .
     7.50  7 AAAAAAA111.         .         .         .         .
     9.64  6 AAAAAA11  1         .         .         .         .
    11.49  6 AAAAAA11 2.         .         .         .         .
    12.99  6 AAAAAA12  .         .         .         .         .
    14.10  5 AAAAA11   .         .         .         .         .
    14.77  4 AAAA1     .         .         .         .         .
    15.00  4 AAAA1     .         .         .         .         .
      NZ     0----|----1----|----2----|----3----|----4----|----5
    Score:   178
 Turns =100 Maximum number of particles =266
 Range    Xmin:   0.000 Xmax:  50.000
         (Ymin:   0.000 Ymax:   1.581)
          Zmin: -15.000 Zmax:  15.000
 Display:    10 turns/character
      NZ     0----|----1----|----2----|----3----|----4----|----5
   -15.00  4 AAAA2     .         .         .         .         .
   -14.77  5 AAAAA     .         .         .         .         .
   -14.10  5 AAAAA     .         .         .         .         .
   -12.99  5 AAAAA     .         .         .         .         .
   -11.49  6 AAAAAA 1  .         .         .         .         .
    -9.64  6 AAAAAA11  .         .         .         .         .
    -7.50  7 AAAAAAA21 .         .         .         .         .
    -5.13  8 *AAAAAAA1111        .         .         .         .
    -2.60 11 ****AAAAAAA11       .         .         .         .
     0.00 39 ********************************AAAAAAA92AAA121   .
     2.60 16 *********AAAAAAA11  .         .         .         .
     5.13 10 ***AAAAAAA1 1       .         .         .         .
     7.50  8 *AAAAAAA  .         .         .         .         .
     9.64  7 AAAAAAA   .         .         .         .         .
    11.49  7 AAAAAAA   .         .         .         .         .
    12.99  5 AAAAA1    .         .         .         .         .
    14.10  5 AAAAA1    .         .         .         .         .
    14.77  3 AAA 1A    .         .         .         .         .
    15.00  3 AAA 1A    .         .         .         .         .
      NZ     0----|----1----|----2----|----3----|----4----|----5
    Score:   160
Lifetime:   420.2725 (  652.2903 points)  Stop
 {a1,b1,a2,b2}: {   15.0542,   10.3799,   13.2818,    7.2700} {   13.2818,    7.2700,   13.9512,    8.3016}
