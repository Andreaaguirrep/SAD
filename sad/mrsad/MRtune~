MRtune[nx0_,ny0_]:=(

  ireturn=0;
  tx0=nx0;
  ty0=ny0;

!  FFS["VISIT RNG;"];
!  FFS["RING; CELL;"];

  ax001=Twiss["AX","MRK00102"];
  bx001=Twiss["BX","MRK00102"];
  ay001=Twiss["AY","MRK00102"];
  by001=Twiss["BY","MRK00102"];
  Print["bx001 ",bx001,"  by001 ",by001];

!  read "MR061117i.couple";
  FFS["COUPLE QFS00101A QFS00101A 1;"];
  FFS["COUPLE QFS01502A QFS00101A 1;"];
  FFS["COUPLE QFS07303A QFS00101A 1;"];
  FFS["COUPLE QFS08704A QFS00101A 1;"];
  FFS["COUPLE QFS14505A QFS00101A 1;"];
  FFS["COUPLE QFS15906A QFS00101A 1;"];

  FFS["COUPLE QDS00201A QDS00201A 1;"];
  FFS["COUPLE QDS01402A QDS00201A 1;"];
  FFS["COUPLE QDS07403A QDS00201A 1;"];
  FFS["COUPLE QDS08604A QDS00201A 1;"];
  FFS["COUPLE QDS14605A QDS00201A 1;"];
  FFS["COUPLE QDS15806A QDS00201A 1;"];

  FFS["COUPLE QFT00301A QFT00301A 1;"];
  FFS["COUPLE QFT01302A QFT00301A 1;"];
  FFS["COUPLE QFT07503A QFT00301A 1;"];
  FFS["COUPLE QFT08504A QFT00301A 1;"];
  FFS["COUPLE QFT14705A QFT00301A 1;"];
  FFS["COUPLE QFT15706A QFT00301A 1;"];

  FFS["COUPLE QFP00401A QFP00401A 1;"];
  FFS["COUPLE QFP01202A QFP00401A 1;"];
  FFS["COUPLE QFP07603A QFP00401A 1;"];
  FFS["COUPLE QFP08404A QFP00401A 1;"];
  FFS["COUPLE QFP14805A QFP00401A 1;"];
  FFS["COUPLE QFP15606A QFP00401A 1;"];

  FFS["COUPLE QDT00501A QDT00501A 1;"];
  FFS["COUPLE QDT01102A QDT00501A 1;"];
  FFS["COUPLE QDT07703A QDT00501A 1;"];
  FFS["COUPLE QDT08304A QDT00501A 1;"];
  FFS["COUPLE QDT14905A QDT00501A 1;"];
  FFS["COUPLE QDT15506A QDT00501A 1;"];

  FFS["COUPLE QFR00601A QFR00601A 1;"];
  FFS["COUPLE QFR00802A QFR00601A 1;"];
  FFS["COUPLE QFR01003A QFR00601A 1;"];
  FFS["COUPLE QFR07804A QFR00601A 1;"];
  FFS["COUPLE QFR08005A QFR00601A 1;"];
  FFS["COUPLE QFR08206A QFR00601A 1;"];
  FFS["COUPLE QFR15007A QFR00601A 1;"];
  FFS["COUPLE QFR15208A QFR00601A 1;"];
  FFS["COUPLE QFR15409A QFR00601A 1;"];

  FFS["COUPLE QDR00701A QDR00701A 1;"];
  FFS["COUPLE QDR00902A QDR00701A 1;"];
  FFS["COUPLE QDR07903A QDR00701A 1;"];
  FFS["COUPLE QDR08104A QDR00701A 1;"];
  FFS["COUPLE QDR15105A QDR00701A 1;"];
  FFS["COUPLE QDR15306A QDR00701A 1;"];
!  FFS["COUPLE QFS2 QFS1 1;"];
!  FFS["COUPLE QDS2 QDS1 1;"];
!  FFS["COUPLE QFT2 QFT1 1;"];
!  FFS["COUPLE QFP2 QFP1 1;"];
!  FFS["COUPLE QDT2 QDT1 1;"];
!  FFS["COUPLE QFR2 QFR1 1;"];
!  FFS["COUPLE QDR2 QDR1 1;"];

!  FFS["FITP 1;"];
!  FFS["FREE QFS00101A QDS00201A QFT00301A QFP00401A QDT00501A QFR00601A QDR00701A;"];
  FFS["FREE QFS00101A QDS00201A QFP00401A QDT00501A QFR00601A;"];
!  BR=170.*40./50.;
  BR=136.;
  BP1=18.05;
  BP2=16.30;
  BP3=16.90;
  BP4=14.70;
  FFS["QFS00101A MINMAX 1.26*BP1/BR;"];
  FFS["QDS00201A MINMAX 1.66*BP3/BR;"];
  FFS["QFT00301A MINMAX 1.46*BP2/BR;"];
  FFS["QFP00401A MINMAX 0.86*BP2/BR;"];
  FFS["QDT00501A MINMAX 1.86*BP4/BR;"];
  FFS["QFR00601A MINMAX 1.76*BP3/BR;"];
  FFS["QDR00701A MINMAX 1.86*BP1/BR;"];

  FFS["FIT NX tx0 1 NY ty0 1;"];

!  FFS["FIT MRK00102 $$$ BXM 55 BYM 36;"];
!  FFS["FIT MRK00102 $$$ BXM 75 BYM 65;"];
  FFS["FIT MRK00102 $$$ BXM 49 BYM 49;"];
  FFS["FIT MRK00102 LSA00101 BXM 13;"];

  FFS["FIT MRK00102 AX ax001 BX bx001 AY ay001 BY by001;"];
  FFS["FIT MRK01702 AX ax001 BX bx001 AY ay001 BY by001;"];
  FFS["FIT MRK07302 AX ax001 BX bx001 AY ay001 BY by001;"];
  FFS["FIT MRK08902 AX ax001 BX bx001 AY ay001 BY by001;"];
  FFS["FIT MRK14502 AX ax001 BX bx001 AY ay001 BY by001;"];
  FFS["FIT MRK16102 AX ax001 BX bx001 AY ay001 BY by001;"];

!  FFS["FIT MRK01702 MRK00102 AX BX AY BY;"];
!  FFS["FIT MRK07302 MRK00102 AX BX AY BY;"];
!  FFS["FIT MRK08902 MRK00102 AX BX AY BY;"];
!  FFS["FIT MRK14502 MRK00102 AX BX AY BY;"];
!  FFS["FIT MRK16102 MRK00102 AX BX AY BY;"];

  FFS["FIT MKQCTR.5   MKQCTR.9   BY 1;"];
  FFS["FIT MKQCTR.6   MKQCTR.8   BX 1;"];
  FFS["FIT MKQCTR.7   MKQCTR.9   BY 1;"];
  FFS["FIT MKQCTR.77  MKQCTR.81  BY 1;"];
  FFS["FIT MKQCTR.78  MKQCTR.80  BX 1;"];
  FFS["FIT MKQCTR.79  MKQCTR.81  BY 1;"];
  FFS["FIT MKQCTR.149 MKQCTR.153 BY 1;"];
  FFS["FIT MKQCTR.150 MKQCTR.152 BX 1;"];
  FFS["FIT MKQCTR.151 MKQCTR.153 BY 1;"];

!  FFS["FIT PLSF AX 0.; "];
!  FFS["FIT PLSF AXM 0.0000000001;"];

!   CONVERGENCE=1.0E-4;
   CONVERGENCE=1.0E-3;
   FFS["GO;"];
   If[~?CONV,
      Print["!!!MRtune DOES NOT CONVERGED  !!!",MatchingResidual];
      CONVERGENCE=1.0E-2;
      FFS["GO;"];
      If[~?CONV,
         Print["!!!MRtune DOES NOT CONVERGED  !!!",MatchingResidual];
         CONVERGENCE=1.0E-1;
         FFS["GO;"];
         If[~?CONV,
            Print["!!!MRtune DOES NOT CONVERGED  !!!",MatchingResidual];
!            ireturn=1;
            FFS["STOP;"];
!            FFS["STOP;"];
           ];
        ];
     ];
  Print["MatchingResidual  ",MatchingResidual];
  FFS["SAVE;"];

  FFS["VAR;"];

  nx1=Twiss["NX","$$$"]/2/Pi;
  ny1=Twiss["NY","$$$"]/2/Pi;
  Print["tunex ",nx1,"  tuney ",ny1];

  bx1=Twiss["BX","REF"];
  by1=Twiss["BY","REF"];
  Print["betax ",bx1,"  betay ",by1];

!! output file for twiss parameters
! drout:=FFS["OUT 'lat-rng0.out' DISP;"];
! drout;

!  drins:=FFS["OUT 21 DRAW MRK00102 MRK07301 BX BY & EX EY {Q}*; TERM OUT;"];
!!  drins:=FFS["OUT 21 DRAW BX BY & EX EY {Q}*; TERM OUT;"];
!  drins;

!Write[datafile,Twiss["BX","MRK00102"],Twiss["BY","MRK00102"],
!LINE["K1","QFS00101A"],LINE["K1","QDS00201A"],
!LINE["K1","QFT00301A"],LINE["K1","QFP00401A"],LINE["K1","QDT00501A"],
!LINE["K1","QFR00601A"],LINE["K1","QDR00701A"],LINE["K1","QDX01601A"],
!LINE["K1","QFN01701A"],LINE["K1","QDN01801A"],LINE["K1","QFX01901A"]];

! FFS["STOP;"];
);
