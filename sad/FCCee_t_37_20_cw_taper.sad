! FCCee-t, from 7_syk3ch
! Solenoid
! from FCCee_t_8_8, 9_5 15_2 15_4 16 17_5 18_2 18_10 19_5 19_11 23_1 25_6 30_8 32_5 32_17 35_5 35 35_8 35_12 35_13
! 37_8 37_16
! Skew sexts
! better QK?
! smaller dispersion (2) + adjust emit
! thinner SY,QK
! independent SY1/SY2
! Crab waist
! improve IR
! More sk2, factor 1/2 in kcw?
! Reverse CHI1 of ES, reverse kcw
! Width Point
! thetax = 15 mrad, bx* =0.5, MINCOUP=0.1%
! Optimize Tune
! shorter qc2;
! Adjusted rf freq/bunch length
! reduce exsy1;
! fit to two tunnels at IR, longer arc at the "R" side, geometry matching of IR.
! longer QC{12}
! Smooth qg region.
! Cross over at rf;
! Outer arc; 2440 bends.
! DXM/DPXM matching;
! Better rf section.
! bx* 1 m.
!
MOMENTUM= 175 GEV;
ON ECHO;OFF EMIT COD CTIME    RAD RFSW;

 ;
 DRIFT  LRF     =(L =20 )    LT3     =(L =34.245001533641826 )  LT4     =(L =13.667515333425282 )  LT5     =(L =80.82049851894872 )
        LT6     =(L =5.091156380310007 )   LH0     =(L =91.66666666666669 )   LF03    =(L =.3 )    LI2     =(L =6.881372745263303 )
        LI3     =(L =63.616339427372004 )  LXSX    =(L =.8999999999999999 )   LL2     =(L =26.18918199639792 )
        LL3     =(L =74.62574997642392 )   LL4     =(L =8.149497715513842 )   LB6     =(L =32.547236648676076 )
        LB5     =(L =161.30372147480904 )  LB4     =(L =161.31416066631203 )  LB3     =(L =211.74936519726782 )
        LB2     =(L =212.94819315945335 )  LB1     =(L =118.45126889760184 )  LY1     =(L =59.99986283097376 )
        LC4     =(L =119.99378661251333 )  LC3     =(L =89.26454429364281 )   LC2     =(L =49.694283034710004 )  LX4     =(L =1 )
        LX3     =(L =.2 )    LX2     =(L =1 )     LX1     =(L =1 )     LA1     =(L =17.30225105418406 )
        LA2     =(L =31.646183765177028 )  LA3     =(L =28.367862336067283 )  LA4     =(L =24.75359070495412 )
        LA5     =(L =21.013943432930986 )  LA6     =(L =12.338532117320426 )  LS4     =(L =2.5360590659229163 )
        LS3     =(L =33.09127542865146 )   LS2     =(L =23.99760033616375 )   LH3     =(L =47.18192236807725 )
        LH2     =(L =67.41213616553243 )   LH1     =(L =5.467293479795593 )
 ;
 BEND   BI0     =(L =50   ANGLE =.00042857142857142855  E2 =1 )
        BI1     =(L =87.41848288342364   ANGLE =.0018878586628106458   E1 =.5    E2 =.5 )
        BI2     =(L =15.415984540333945  ANGLE =.00030709136676419996  E1 =.5    E2 =.5 )
        BI3     =(L =32   ANGLE =-.002623521458146274   E1 =.5    E2 =.5 )
        B1      =(L =34.075409836065575  ANGLE =.002555075945565404    E1 =.5    E2 =.5 )
        BL      =(L =44.47901234567902   ANGLE =.0007493832741157113   E1 =.5    E2 =.5 )
        BC3L    =(L =60   ANGLE =-.001566850601956659   E1 =.5    E2 =.5 )
        BC1L    =(L =126.83817775828987  ANGLE =-.001066886150999893   E1 =.5    E2 =.5 )
        BWL     =(L =11.654355458904886  ANGLE =-9.802939980445261e-05 E1 =.5    E2 =.5 )
        BV2     =(L =10   ANGLE =3.86112788342472e-05   E1 =.5    E2 =.5    ROTATE =90 DEG )
        BW      =(L =11.654355458904886  ANGLE =9.802939980445261e-05  E1 =.5    E2 =.5 )
        BC1     =(L =126.83817775828987  ANGLE =.001066886150999893    E1 =.5    E2 =.5 )
        BC3     =(L =60   ANGLE =.001566850601956659    E1 =.5    E2 =.5 )
        BS      =(L =44.47901234567902   ANGLE =.002101418992008105    E1 =.5    E2 =.5 )
        BG1     =(L =43.69369545801966   ANGLE =.002487417829958154    E1 =.5    E2 =.5 )
        BG2     =(L =38.13652930356856   ANGLE =.001909174795368296    E1 =.5    E2 =.5 )
        B2      =(L =34.07745389682203   ANGLE =.002555075945565404    E1 =.5    E2 =.5 )
        BH3     =(L =27.14297761728094   ANGLE =.0002721682766917117   E1 =.5    E2 =.5 )
        BH2     =(L =34.81593496531462   ANGLE =.002752715079341234    E1 =.5    E2 =.5 )
        BH1     =(L =23.01191499251948   ANGLE =-.002596311927461517   E1 =.5    E2 =.5 )
        BH0     =(L =50   ANGLE =-.00042857142857142855 E1 =1 )
 ;
 QUAD   QRF     =(L =.3   K1 =.012188743161293366 )
        QRD     =(L =.6   K1 =-.020849276273206995 )
        QT3     =(L =.6   K1 =-.02404289159555405 )
        QT4     =(L =.6   K1 =.023505201843786124 )
        QT5     =(L =.6   K1 =-.04538948352719411 )
        QT6     =(L =.6   K1 =.04464493745812601 )
        QI2     =(L =.6   K1 =.03162784690605246 )
        QI3     =(L =.6   K1 =-.03937165678275019 )
        QI4     =(L =.6   K1 =.025565611640518307 )
        QI5     =(L =.6   K1 =-.02927451442385722 )
        QI6     =(L =.6   K1 =.016013238576394296 )
        QD1     =(L =.6   K1 =-.03898595059506528 )
        QF2     =(L =.6   K1 =.038986165188633654 )
        QL3     =(L =.6   K1 =-.039517892644298815 )
        QL4     =(L =.6   K1 =.015788923726475942 )
        QL5     =(L =.6   K1 =-.017157470617975547 )
        QB6     =(L =.6   K1 =.008681756766425726 )
        QB5     =(L =.6   K1 =-.005216033309103769 )
        QB4     =(L =.6   K1 =.0030785278895953797 )
        QB3     =(L =.6   K1 =-2.708281083875213e-06 )
        QB2     =(L =.6   K1 =.00836380881171341 )
        QB1     =(L =.6   K1 =-.016225134170491776 )
        QY2     =(L =.6   K1 =.023399895624468193 )
        QY1     =(L =.6   K1 =-.02325542225200264 )
        QC7     =(L =.6   K1 =-.019473817631028456 )
        QK7L    =(L =.15  K1 =-.000354420826629613 ROTATE =-45 DEG )
        QC6     =(L =.6   K1 =.01174272005637359 )
        QK6L    =(L =.15  K1 =.0005819584617840069 ROTATE =-45 DEG )
        QC5     =(L =.6   K1 =-.01297465577661572 )
        QK5L    =(L =.15  K1 =-.0006286975104546833     ROTATE =-45 DEG )
        QC4     =(L =.6   K1 =.018914100709864334 )
        QK4L    =(L =.15  K1 =.0006999338723686658 ROTATE =-45 DEG )
        QC3     =(L =.6   K1 =-.010659985251164511 )
        QK3L    =(L =.15  K1 =.0004884837137778308 ROTATE =-45 DEG )
        QK2L    =(L =.15  K1 =-.0006901214146348106     ROTATE =-45 DEG )
        QK1L    =(L =.15  K1 =-.0006976485557098469     ROTATE =-45 DEG )
        QK1R    =(L =.15  K1 =-.0006976485557098469     ROTATE =45 DEG )
        QK2R    =(L =.15  K1 =-.0006901214146348106     ROTATE =45 DEG )
        QK3R    =(L =.15  K1 =.0004884837137778308 ROTATE =45 DEG )
        QK4R    =(L =.15  K1 =.0006999338723686658 ROTATE =45 DEG )
        QK5R    =(L =.15  K1 =-.0006286975104546833     ROTATE =45 DEG )
        QK6R    =(L =.15  K1 =.0005819584617840069 ROTATE =45 DEG )
        QK7R    =(L =.15  K1 =-.000354420826629613 ROTATE =45 DEG )
        QA1     =(L =.6   K1 =-.035083539811733566 )
        QA2     =(L =.6   K1 =.035177530208922884 )
        QA3     =(L =.6   K1 =-.005488638866495291 )
        QA4     =(L =.6   K1 =.00039916153775238525 )
        QA5     =(L =.6   K1 =-.002890773121634007 )
        QA6     =(L =.6   K1 =.025664972051867817 )
        QS5     =(L =.6   K1 =-.03771377569825854 )
        QS4     =(L =.6   K1 =.031171590287400394 )
        QS3     =(L =.6   K1 =-.04093491220500871 )
        QFG2    =(L =.6   K1 =.03081533298340093 )
        QDG1    =(L =.6   K1 =-.030815173030315234 )
        QG2     =(L =.6   K1 =.03352205448449619 )
        QG3     =(L =.6   K1 =-.036352622465933244 )
        QG4     =(L =.6   K1 =.0342286767431635 )
        QG5     =(L =.6   K1 =-.039283078910700125 )
        QG6     =(L =.6   K1 =.035172538981923185 )
        QG7     =(L =.6   K1 =-.037551534893176544 )
        QF4     =(L =.6   K1 =.038983968425327704 )
        QD3     =(L =.6   K1 =-.038983753844146235 )
        QH6     =(L =.6   K1 =.04833085942519506 )
        QH5     =(L =.6   K1 =-.03288496847509344 )
        QH4     =(L =.6   K1 =.032561793698721524 )
        QH3     =(L =.6   K1 =-.013864666654870166 )
        QH2     =(L =.6   K1 =.036649216411707375 )
        QH1     =(L =.6   K1 =-.0368148514400098 )
 ;
 MULT   SD62    =(L =.3   K2 =-1.1288908265671513 )
        SF63    =(L =.3   K2 =1.6537859266674027 )
        SD63    =(L =.3   K2 =-.4614849274445732 )
        SF64    =(L =.3   K2 =.35196333133712737 )
        SD64    =(L =.3   K2 =-1.6411017331207316 )
        SF65    =(L =.3   K2 =.17060379462013156 )
        SD65    =(L =.3   K2 =-1.5164867863309683 )
        SF66    =(L =.3   K2 =.12671516649671208 )
        SD66    =(L =.3   K2 =-2.385764715507117 )
        SF67    =(L =.3   K2 =.005260646297162537 )
        SD67    =(L =.3   K2 =-2.0195976723478495 )
        SF68    =(L =.3   K2 =.4018785099664812 )
        SD68    =(L =.3   K2 =-2.2244955846741274 )
        SF69    =(L =.3   K2 =1.0008157530051782 )
        SD69    =(L =.3   K2 =-.22705589665375858 )
        SF70    =(L =.3   K2 =1.9804193678366246 )
        SD70    =(L =.3   K2 =.039524337432174296 )
        SF71    =(L =.3   K2 =.03500626032812489 )
        SD71    =(L =.3   K2 =-1.1104016478526284 )
        SF72    =(L =.3   K2 =.11123488502348668 )
        SD72    =(L =.3   K2 =-.8517478873408814 )
        SF73    =(L =.3   K2 =1.663259885386925 )
        SD73    =(L =.3   K2 =-2.294166868778274 )
        SF74    =(L =.3   K2 =.15893684210410255 )
        SD74    =(L =.3   K2 =-.6297869112675526 )
        SF75    =(L =.3   K2 =.3970353501391772 )
        SD75    =(L =.3   K2 =-.7279771282485564 )
        SF76    =(L =.3   K2 =.37667867207284544 )
        SD76    =(L =.3   K2 =-.8311673773713246 )
        SF77    =(L =.3   K2 =.08665881403781733 )
        SD77    =(L =.3   K2 =-1.6447475798066304 )
        SF78    =(L =.3   K2 =.19511009709069896 )
        SD78    =(L =.3   K2 =-.22135696685638803 )
        SF79    =(L =.3   K2 =1.2618776356276151 )
        SD79    =(L =.3   K2 =-2.4910815411726674 )
        SF80    =(L =.3   K2 =1.5144935433134787 )
        SD80    =(L =.3   K2 =-.19816631282694017 )
        SF81    =(L =.3   K2 =.4411099425153359 )
        SD81    =(L =.3   K2 =-.49345061096874954 )
        SF82    =(L =.3   K2 =.40123101951718554 )
        SD82    =(L =.3   K2 =-.7007773441633037 )
        SF83    =(L =.3   K2 =.07046405015881566 )
        SD83    =(L =.3   K2 =-1.4452866692407047 )
        SF84    =(L =.3   K2 =.017086528811005496 )
        SD84    =(L =.3   K2 =-.21551215676097887 )
        SF85    =(L =.3   K2 =.4229458653835778 )
        SD85    =(L =.3   K2 =-.2709839459382022 )
        SF86    =(L =.3   K2 =.04265149144280023 )
        SD86    =(L =.3   K2 =-.8901274317663699 )
        SF87    =(L =.3   K2 =.17623775936411015 )
        SD87    =(L =.3   K2 =-.3437851699423341 )
        SF88    =(L =.3   K2 =.4760151382315678 )
        SD88    =(L =.3   K2 =-.4893880487896844 )
        SF89    =(L =.3   K2 =.6292869286197558 )
        SD89    =(L =.3   K2 =-.2868515676495037 )
        SF90    =(L =.3   K2 =.5541728616009122 )
        SD90    =(L =.3   K2 =-2.283275397855079 )
        SF91    =(L =.3   K2 =2.189485385516382 )
        SD91    =(L =.3   K2 =-.5619131105448215 )
        SF92    =(L =.3   K2 =.8343150982125812 )
        SD92    =(L =.3   K2 =-.34754278986794734 )
        SF93    =(L =.3   K2 =.6987360001415543 )
        SD93    =(L =.3   K2 =-2.4180153573965972 )
        SF94    =(L =.3   K2 =.13176385158748005 )
        SD94    =(L =.3   K2 =-1.8949155281887986 )
        SF95    =(L =.3   K2 =.9404451243269287 )
        SD95    =(L =.3   K2 =-1.1322709774793853 )
        SF96    =(L =.3   K2 =.17735108178301867 )
        SD96    =(L =.3   K2 =-1.0989692001977431 )
        SF97    =(L =.3   K2 =.2516059002007262 )
        SD97    =(L =.3   K2 =-.4935097459176928 )
        SF98    =(L =.3   K2 =.2196455854995744 )
        SD98    =(L =.3   K2 =-.5308674794860476 )
        SF99    =(L =.3   K2 =.28331013713197456 )
        SD99    =(L =.3   K2 =-.1834085581514392 )
        SF100   =(L =.3   K2 =.6944982697739851 )
        SD100   =(L =.3   K2 =-.762268962953747 )
        SF101   =(L =.3   K2 =.08817852361036158 )
        SD101   =(L =.3   K2 =.0982285159614844 )
        SF102   =(L =.3   K2 =.37582891634813964 )
        SD102   =(L =.3   K2 =-.30435202062586103 )
        SF103   =(L =.3   K2 =.38877110822321154 )
        SD103   =(L =.3   K2 =-.19998523616512587 )
        SF104   =(L =.3   K2 =.11890180672595532 )
        SD104   =(L =.3   K2 =-.9575128246101382 )
        SF105   =(L =.3   K2 =.38054272787323923 )
        SD105   =(L =.3   K2 =-.6905332849354017 )
        SF106   =(L =.3   K2 =.06218283153089837 )
        SD106   =(L =.3   K2 =-.9303436370245618 )
        SF107   =(L =.3   K2 =.35913023390547655 )
        SD107   =(L =.3   K2 =-.04384760507801687 )
        SF108   =(L =.3   K2 =.4527037396531079 )
        SD108   =(L =.3   K2 =-1.67275773439012 )
        SF109   =(L =.3   K2 =.4468670879043764 )
        SD109   =(L =.3   K2 =-.3006291605681328 )
        SF110   =(L =.3   K2 =.3555072514703276 )
        SD110   =(L =.3   K2 =-1.6092725725339307 )
        SF111   =(L =.3   K2 =.2403923363738574 )
        SD111   =(L =.3   K2 =-1.5265555357318 )
        SF112   =(L =.3   K2 =.4289464376612507 )
        SD112   =(L =.3   K2 =-.5769691122462381 )
        SF113   =(L =.3   K2 =.07970857474894405 )
        SD113   =(L =.3   K2 =-1.7448987776837226 )
        SF114   =(L =.3   K2 =.6171996127614611 )
        SD114   =(L =.3   K2 =-.3364803673414358 )
        SF115   =(L =.3   K2 =1.7744123257854942 )
        SD115   =(L =.3   K2 =-.2732639906118842 )
        SF116   =(L =.3   K2 =.7670440764563334 )
        SD116   =(L =.3   K2 =-.5232274582179192 )
        SF117   =(L =.3   K2 =.8065946281150234 )
        SD117   =(L =.3   K2 =-1.6239683353725791 )
        SF118   =(L =.3   K2 =.7271347995033107 )
        SD118   =(L =.3   K2 =-.2860403403067639 )
        SF119   =(L =.3   K2 =.7017919725124857 )
        SD119   =(L =.3   K2 =-1.2165442193714335  SK2 =-.24481537859419156 )
        SF120   =(L =.3   K2 =.22061449798835941   SK2 =-.04228049969951134 )
        SD120   =(L =.3   K2 =-.382586872485496    SK2 =.17792066090599346 )
        SF121   =(L =.3   K2 =.37722216866923247   SK2 =-.023502780417771978 )
        SD121   =(L =.3   K2 =-1.3398086655029149  SK2 =.4010772697012309 )
        SF122   =(L =.3   K2 =.7729638076859676    SK2 =-.058632353294244 )
        SD122   =(L =.3   K2 =-.4679599167233553   SK2 =-.060200354839301404 )
        SF123   =(L =.3   K2 =.1590522208087812    SK2 =-.031343138555724015 )
        SY2L    =(L =.15  K2 =.9764045765654709    SK2 =-.01723874746558493 )
        SY1L    =(L =.15  K2 =1.6001025775967086   SK2 =-.01723874746558493 )
        QC2L2   =(L =1.25 DX =-.11062845441510048  DY =-.00017    CHI1 =.015010701319148993     ROTATE =-.049591935867220154 DEG
           K1 =.13063489732137457 )
        QC2L1   =(L =1.25 DX =-.09188758499107687  DY =-.00017    CHI1 =.015010701319148993     ROTATE =-.049591935867220154 DEG
           K1 =.13063489732137457 )
        QC1L2   =(L =1.6  DX =-.06600398011368168  DY =-.00011    CHI1 =.015010701319148993     K1 =-.27747043972180235 )
        QC1L1   =(L =1.6  DX =-.04200493550181795  DY =-.00011    CHI1 =.015010701319148993     K1 =-.27747043972180235 )
        QC1R1   =(L =1.6  DX =.04200493550181795   DY =-.00011    CHI1 =.015010701319148993     K1 =-.27747043972180235 )
        QC1R2   =(L =1.6  DX =.06600398011368168   DY =-.00011    CHI1 =.015010701319148993     K1 =-.27747043972180235 )
        QC2R1   =(L =1.25 DX =.09188758499107687   DY =-.00017    CHI1 =.015010701319148993     ROTATE =.049591935867220154 DEG
           K1 =.13063489732137457 )
        QC2R2   =(L =1.25 DX =.11062845441510048   DY =-.00017    CHI1 =.015010701319148993     ROTATE =.049591935867220154 DEG
           K1 =.13063489732137457 )
        SY1R    =(L =.15  K2 =-1.903776529677675   SK2 =.010941368470248406 )
        SY2R    =(L =.15  K2 =-1.2800785286464373  SK2 =.010941368470248406 )
        SF1     =(L =.3   K2 =.006396254548656612  SK2 =.003760020195595998 )
        SD1     =(L =.3   K2 =-1.4156562286281784  SK2 =.003846540021058208 )
        SF2     =(L =.3   K2 =.6714462152692785    SK2 =.015472620734713616 )
        SD2     =(L =.3   K2 =-.8376147998099014   SK2 =-.023664476907069687 )
        SF3     =(L =.3   K2 =.11692986842456178   SK2 =.007505501572248401 )
        SD3     =(L =.3   K2 =-2.2853000319277132  SK2 =-.003966099628149077 )
        SF4     =(L =.3   K2 =.6079096181440424    SK2 =-.0011378750104103857 )
        SD4     =(L =.3   K2 =-.012715762259789704 SK2 =-.0017756533683331139 )
        SF5     =(L =.3   K2 =.12412416464439202 )
        SF6     =(L =.3   K2 =-.0017508312660344312 )
        SD5     =(L =.3   K2 =-.6587470115667302 )
        SF7     =(L =.3   K2 =.5230013528764698 )
        SD6     =(L =.3   K2 =-2.498445137843867 )
        SF8     =(L =.3   K2 =.0012896837051567054 )
        SD7     =(L =.3   K2 =-2.4115966469458563 )
        SF9     =(L =.3   K2 =1.8237786411023706 )
        SD8     =(L =.3   K2 =-.4601293644303484 )
        SF10    =(L =.3   K2 =1.0183441326574303 )
        SD9     =(L =.3   K2 =-.36070427006812567 )
        SF11    =(L =.3   K2 =.5742756072425468 )
        SD10    =(L =.3   K2 =-.9051726400502546 )
        SF12    =(L =.3   K2 =.00021443461323655526 )
        SD11    =(L =.3   K2 =-.17567234014626093 )
        SF13    =(L =.3   K2 =.19545501021719625 )
        SD12    =(L =.3   K2 =-2.8183112048106422 )
        SF14    =(L =.3   K2 =.3195523073124308 )
        SD13    =(L =.3   K2 =-.8954659793266099 )
        SF15    =(L =.3   K2 =.008737511615924483 )
        SD14    =(L =.3   K2 =-2.4710584171044006 )
        SF16    =(L =.3   K2 =.531792910785198 )
        SD15    =(L =.3   K2 =-.7807398925334907 )
        SF17    =(L =.3   K2 =-.0005898639840570308 )
        SD16    =(L =.3   K2 =-.706723610469595 )
        SF18    =(L =.3   K2 =.954750676632529 )
        SD17    =(L =.3   K2 =-.409978320200674 )
        SF19    =(L =.3   K2 =.8594506152323987 )
        SD18    =(L =.3   K2 =-2.3734361597588025 )
        SF20    =(L =.3   K2 =.14742614821261 )
        SD19    =(L =.3   K2 =-.7714772292686817 )
        SF21    =(L =.3   K2 =.5105302233750421 )
        SD20    =(L =.3   K2 =-3.0210474388140818 )
        SF22    =(L =.3   K2 =.13380890571187215 )
        SD21    =(L =.3   K2 =-.8268039797627145 )
        SF23    =(L =.3   K2 =.2042386438962126 )
        SD22    =(L =.3   K2 =-2.5903454191575475 )
        SF24    =(L =.3   K2 =.8260888519640365 )
        SD23    =(L =.3   K2 =-.6239665479088721 )
        SF25    =(L =.3   K2 =.40828555336655564 )
        SD24    =(L =.3   K2 =-2.474316228016719 )
        SF26    =(L =.3   K2 =.061694236196425264 )
        SD25    =(L =.3   K2 =-.7305132111701094 )
        SF27    =(L =.3   K2 =.0836037352704548 )
        SD26    =(L =.3   K2 =-1.5983939638989673 )
        SF28    =(L =.3   K2 =.3118983310889354 )
        SD27    =(L =.3   K2 =-.7472335549801596 )
        SF29    =(L =.3   K2 =.012673691022713427 )
        SD28    =(L =.3   K2 =-2.266958988613398 )
        SF30    =(L =.3   K2 =-.005246454362790044 )
        SD29    =(L =.3   K2 =-2.1209456754696494 )
        SF31    =(L =.3   K2 =.08429252672456933 )
        SD30    =(L =.3   K2 =-.587471648725859 )
        SF32    =(L =.3   K2 =1.0148524913356651 )
        SD31    =(L =.3   K2 =-.3783232926758883 )
        SF33    =(L =.3   K2 =-.006609574282199323 )
        SD32    =(L =.3   K2 =-1.3213864495666783 )
        SF34    =(L =.3   K2 =1.032664122372681 )
        SD33    =(L =.3   K2 =-.011415235689690403 )
        SF35    =(L =.3   K2 =.5483506932997358 )
        SD34    =(L =.3   K2 =-2.112957923711431 )
        SF36    =(L =.3   K2 =.0012369663959982072 )
        SD35    =(L =.3   K2 =-.6491377227722437 )
        SF37    =(L =.3   K2 =.5033474151944298 )
        SD36    =(L =.3   K2 =-2.219715442043546 )
        SF38    =(L =.3   K2 =-.01378797755207072 )
        SD37    =(L =.3   K2 =-1.0862492035494502 )
        SF39    =(L =.3   K2 =.041033353096646984 )
        SD38    =(L =.3   K2 =-2.400905110889909 )
        SF40    =(L =.3   K2 =.013399792322126942 )
        SD39    =(L =.3   K2 =-.6981262338075765 )
        SF41    =(L =.3   K2 =.0006132023602786307 )
        SD40    =(L =.3   K2 =-2.4471523245204168 )
        SF42    =(L =.3   K2 =.2596021504779473 )
        SD41    =(L =.3   K2 =-.03115090555459048 )
        SF43    =(L =.3   K2 =.04861010589050708 )
        SD42    =(L =.3   K2 =-1.8935087920480533 )
        SF44    =(L =.3   K2 =.982136129262243 )
        SD43    =(L =.3   K2 =-.24417909128276574 )
        SF45    =(L =.3   K2 =.031023192934537033 )
        SD44    =(L =.3   K2 =-1.8369689697513827 )
        SF46    =(L =.3   K2 =.09748684859930895 )
        SD45    =(L =.3   K2 =-.19606958648941922 )
        SF47    =(L =.3   K2 =1.0141571052296985 )
        SD46    =(L =.3   K2 =-.22394235119422032 )
        SF48    =(L =.3   K2 =.12147799829703053 )
        SD47    =(L =.3   K2 =-1.0694447524915038 )
        SF49    =(L =.3   K2 =.5825292844157245 )
        SD48    =(L =.3   K2 =-.7096396796988275 )
        SF50    =(L =.3   K2 =.16759567816937154 )
        SD49    =(L =.3   K2 =-2.4185731575305476 )
        SF51    =(L =.3   K2 =-.0016954074966387526 )
        SD50    =(L =.3   K2 =-2.378217361392164 )
        SF52    =(L =.3   K2 =1.1640477549816652 )
        SD51    =(L =.3   K2 =-1.1981849622171932 )
        SF53    =(L =.3   K2 =.11546533497173928 )
        SD52    =(L =.3   K2 =-2.486888067790107 )
        SF54    =(L =.3   K2 =.36581410014273996 )
        SD53    =(L =.3   K2 =-.9598612274141332 )
        SF55    =(L =.3   K2 =.20554071157506307 )
        SD54    =(L =.3   K2 =-2.3934982978268864 )
        SF56    =(L =.3   K2 =1.0528209103203061 )
        SD55    =(L =.3   K2 =-.42977677121224805 )
        SF57    =(L =.3   K2 =.4795250804688596 )
        SD56    =(L =.3   K2 =-1.8284847294742383 )
        SF58    =(L =.3   K2 =.06813324334767523 )
        SD57    =(L =.3   K2 =-1.1857891026061018 )
        SF59    =(L =.3   K2 =.682631263493993 )
        SD58    =(L =.3   K2 =-2.5543467231411463 )
        SF60    =(L =.3   K2 =.09305760376462058 )
        SD59    =(L =.3   K2 =-.7341386769638205 )
        SF61    =(L =.3   K2 =1.4651917989771148 )
        SD60    =(L =.3   K2 =-2.242153756234823 )
        SF62    =(L =.3   K2 =.832637494115025 )
        SD61    =(L =.3   K2 =-.17147105065652576 )
 ;
 SOL    ES5L    =(BZ =0   BOUND =1  CHI1 =-1.762355022981748e-30  CHI2 =1.5856456772600502e-18  CHI3 =5.739718505595976e-42
           F1 =.1 )
        ES4L    =(BZ =2   BOUND =1  GEO =1    F1 =.1 )
        ES3L    =(BZ =0   DX =-.12300930216282964  DY =-.00025392695801018677    DZ =.0009225917394669017 BOUND =1
           CHI1 =.014999850217665702     CHI2 =3.8606935233574946e-05  CHI3 =5.791416811329824e-07   F1 =.3 )
        ES2L    =(BZ =0   F1 =.1 )
        ES1L    =(BZ =-2  DPX =-.015     BOUND =1  CHI1 =-.015    GEO =1 )
        ES1R    =(BZ =2   DPX =-.015     BOUND =1  CHI1 =.015     CHI2 =-7.6231535909507125e-25 CHI3 =-4.2389763416509325e-24
           GEO =1 )
        ES2R    =(BZ =0   F1 =.1 )
        ES3R    =(BZ =0   DX =.12300930216282964   DY =-.00025392695801018677    DZ =.0009225917394669017 BOUND =1
           CHI1 =-.014999850206486259    CHI2 =3.861127883424721e-05   CHI3 =-4.228080331349436e-24  F1 =.3 )
        ES4R    =(BZ =-2  BOUND =1  CHI1 =1.614619200652498e-45   CHI2 =-1.5856456772600502e-18 GEO =1    F1 =.1 )
        ES5R    =(BZ =0   BOUND =1  CHI2 =-1.5856456772600502e-18 F1 =.1 )
 ;
 CAVI   CA1     =(VOLT =2.3e+08     FREQ =4e+08 )
 ;
 MARK   FRF     =(AX =7.449426919521523e-12   BX =128.4577282675182    AY =9.176603854578875e-12     BY =68.70758052777208
           EX =1.6490643366569945e-14    EPX =7.529946547625301e-16    EY =-2.754224829034683e-13    EPY =-1.4844783879139584e-15
           R1 =1.3453795241697755e-14    R2 =5.494133706592396e-12     R3 =1.3471037635024337e-16    R4 =4.6894513015792886e-14
           DX =2.8610330554240653e-15    DPX =-9.852022490852762e-18   DY =-3.512554668564286e-16    DPY =-1.9270467831881812e-16
           DZ =-5.2059062776999345e-18   DP =.02   SIGZ =.0024211572404482786    EMITX =2.0013882006213186e-09
           EMITY =2.0162216022775557e-16 )
        FRD     =(AX =.4868999619939381  BX =46.12950187326007    PSIX =.5498632139888425  AY =-1.8369886778151765
           BY =176.19514493731924   PSIY =.3757176933604848  EX =4.050990458834916e-14     EPX =5.507013771450853e-16
           EY =-4.622571755432505e-13    EPY =-4.845938347245619e-15   R1 =1.4819438209515692e-13    R2 =4.123931465500133e-12
           R3 =1.687014970751886e-15     R4 =4.6209082831469044e-14    DX =1.0654434296895134e-15    DPX =-4.468516385242799e-17
           DY =-8.303387798696659e-15    DPY =-1.973410822342274e-16   DZ =-5.205906277700759e-18    DP =.02
           EMITX =2.0013882006213186e-09 EMITY =2.0162216022775557e-16 )
        F0      =(AX =-2.361382928080085 BX =119.27261965912513   PSIX =9.394205461075499  AY =.48263017869902164
           BY =22.361907650735375   PSIY =8.240625130625423  EX =.24701996626102599   EPX =.004910913175088347
           EY =-4.5546338464042816e-14   EPY =-3.2999727492666932e-15  R1 =-1.2016587769261911e-14   R2 =5.088550839667685e-13
           R3 =-3.2200062142783354e-15   R4 =1.454443635914408e-13     DX =-2.782454864574107e-15    DPX =-6.462056353700826e-17
           DY =-6.9203495041310956e-15   DPY =1.368756507397595e-17    DZ =-2.907837732989947e-18    DP =.02
           EMITX =2.0013882006213186e-09 EMITY =2.0162216022775557e-16 )
        PSDC    =(AX =.46608711098100447 BX =22.07728310087648    PSIX =10.211275898415732 AY =-2.377913986645649
           BY =120.69460257948123   PSIY =8.978348351055274  EX =.12250462479805417   EPX =-.002355835839469862
           EY =7.891487016040467e-14     EPY =-4.749759436921471e-16   R1 =5.93403642141811e-14 R2 =-9.769523983752688e-13
           R3 =8.518304128964507e-15     R4 =-6.912871133538776e-15    DX =-4.680304302709564e-16    DPX =-4.4726191053841937e-17
           DY =-7.156578765387319e-15    DPY =-2.738094425977454e-16   DZ =1.3967005187423798e-18    DP =.02
           EMITX =2.0013882006213186e-09 EMITY =2.0162216022775557e-16 )
        PSFC    =(AX =-2.3779235123031266     BX =120.69441159545397   PSIX =14.10409405149     AY =.466089569834317
           BY =22.07729172543415    PSIY =12.939511830429236 EX =.24849324021379218   EPX =.004910913175091831
           EY =-1.219994703253324e-13    EPY =8.12564486954429e-15     R1 =9.78919329320603e-15 R2 =1.0076279361276224e-12
           R3 =-4.921617786616756e-15    R4 =-3.302268231321639e-14    DX =-1.1051069730284623e-15   DPX =1.3671511357545951e-18
           DY =-2.9214044671049594e-15   DPY =3.7494994806782013e-16   DZ =-1.0964515855526053e-17   DP =.02
           EMITX =2.0013882006213186e-09 EMITY =2.0162216022775557e-16 )
        PQY1    =(AX =-5.998990193489817e-11  BX =56.78512579180022    PSIX =494.55302593106586 AY =6.108377692548572e-12
           BY =7.598031820408487    PSIY =493.91459035920985 EX =-.048028721221061464 EPX =.0021219376904628665
           EY =2.878453911691822e-12     EPY =2.973549423189453e-14    R1 =2.5606578695203175e-14    R2 =1.3116275910487382e-09
           R3 =5.071295974658337e-16     R4 =-2.0534456628345696e-15   DX =4.3696673182967444e-16    DPX =-3.408103569521223e-17
           DY =2.8745723139780682e-15    DPY =-4.3921243519391133e-16  DZ =-5.569904367463e-18  DP =.02   OFFSET =1.5
           EMITX =2.0013882006213186e-09 EMITY =2.0162216022775557e-16 )
        IP      =(AX =-6.433691418170182e-12  BX =.9999999999884377    PSIX =499.26541491151045 AY =-5.918664993876109e-12
           BY =.000999999999982877  PSIY =500.1977756663532  EX =6.563108269492571e-14     EPX =-3.692011973594887e-14
           EY =-2.4193918915399278e-14   EPY =2.5585485679609263e-12   R1 =-1.2759793265739805e-12   R2 =-2.1684225596043423e-15
           R3 =-2.292623807637927e-14    R4 =-3.380400822549991e-13    DX =-2.5976334916313685e-16   DPX =-5.724587470723463e-17
           DY =3.929555248902165e-17     DPY =-3.828037549510743e-14   DZ =-4.8725244527552495e-18   DP =.02
           SIGZ =.001218123355690918     EMITX =2.0013882006213186e-09 EMITY =2.0162216022775557e-16 )
        FG      =(AX =-2.372449055357034 BX =152.10104139712493   PSIX =510.04332498684187 AY =.4682961352633014
           BY =27.97862710659644    PSIY =513.070806918327   EX =.3052501193300762    EPX =.0047767935460328505
           EY =-5.685484054348851e-12    EPY =1.449465061439133e-13    R1 =-1.9684714350822608e-14   R2 =-6.020161675041775e-13
           R3 =6.027749582126025e-16     R4 =2.4093037717584158e-14    DX =4.6852091145151294e-18    DPX =-1.0291662149809825e-17
           DY =9.21229418864677e-15 DPY =-1.8369911169920025e-17  DZ =-7.940701614274352e-18    DP =.02
           EMITX =2.0013882006213186e-09 EMITY =2.0162216022775557e-16 )
        PSFGC   =(AX =-2.392059910790505 BX =154.24507043189132   PSIX =510.04626291653216 AY =.4486852526583157
           BY =27.565985482031714   PSIY =513.0870112662216  EX =.30739967642578575   EPX =.004776793546032776
           EY =-5.620249860123969e-12    EPY =1.44946506143911e-13     R1 =-1.9415685924325313e-14   R2 =-5.824380744795802e-13
           R3 =5.731708955674833e-16     R4 =2.3824009291086882e-14    DX =5.3961147100718714e-20    DPX =-1.029166214980969e-17
           DY =9.204027728620306e-15     DPY =-1.8369911169920105e-17  DZ =-7.940701614274352e-18    DP =.02   OFFSET =1.5
           EMITX =2.0013882006213186e-09 EMITY =2.0162216022775557e-16 )
        PSDGC   =(AX =.4486829524438646  BX =27.565976311347438   PSIX =513.9505435266007  AY =-2.392051038673711
           BY =154.24530651517574   PSIY =517.0367122895941  EX =.14984656414852215   EPX =-.0022893744335507776
           EY =6.622273558355595e-12     EPY =2.4296632191469418e-14   R1 =-2.7376904950609985e-14   R2 =9.287776903204515e-13
           R3 =-1.4807047463366054e-14   R4 =-2.123671558244392e-15    DX =4.561241731979618e-16     DPX =9.757819552210264e-18
           DY =-2.123812849927393e-14    DPY =-2.657023046241277e-16   DZ =-2.3306392417619096e-18   DP =.02   OFFSET =1.5
           EMITX =2.0013882006213186e-09 EMITY =2.0162216022775557e-16 )
        F1      =(AX =-2.361385902842582 BX =119.2795957102226    PSIX =549.3717777150409  AY =.4826263252388697
           BY =22.36310031810466    PSIY =552.8984982712601  EX =.24703410599445932   EPX =.004910912047899529
           EY =2.885264218059501e-12     EPY =8.972628337677298e-14    R1 =6.773958982424238e-14     R2 =-3.284248722798568e-12
           R3 =4.446108070263468e-16     R4 =-2.3186579380876053e-14   DX =-1.3715324861537428e-15   DPX =-2.667137344314341e-17
           DY =-1.4769342390171804e-15   DPY =-3.610060608115613e-16   DZ =-4.602724823880219e-18    DP =.02
           SIGZ =.021340386968833242     EMITX =2.0013882006213186e-09 EMITY =2.0162216022775557e-16 )
 ;
    LINE FQCELL =(F0 LF03 PSFC SF1 LF03
       QF2 LXSX B1 LXSX
       QD1 LXSX B1 LXSX
       QF2 LXSX B1 LXSX
       QD1 LXSX B1 LF03 PSFC SF1 LF03
       QF2 LXSX B1 LF03 PSDC SD1 LF03
       QD1 LXSX B1 LXSX
       QF2 LXSX B1 LXSX
       QD1 LXSX B1 LXSX
       QF2 LXSX B1 LF03 PSDC SD1 LF03
       QD1 LXSX B1 )
     FQCELL2 =(F1 LF03 PSFGC SF1 LF03
       QF4 LXSX B2 LXSX
       QD3 LXSX B2 LXSX
       QF4 LXSX B2 LXSX
       QD3 LXSX B2 LF03 PSFGC SF1 LF03
       QF4 LXSX B2 LF03 PSDGC SD1 LF03
       QD3 LXSX B2 LXSX
       QF4 LXSX B2 LXSX
       QD3 LXSX B2 LXSX
       QF4 LXSX B2 LF03 PSDGC SD1 LF03
       QD3 LXSX B2 )
     FQCELLG =(FG LF03 PSFGC SF1 LF03
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LXSX
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LF03 PSFGC SF1 LF03
       QFG2 LXSX BG1 LF03 PSDGC SD1 LF03
       QDG1 LXSX BG1 LXSX
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LXSX
       QFG2 LXSX BG1 LF03 PSDGC SD1 LF03
       QDG1 LXSX BG1 )
     FQCELLG1 =(FG LF03 PSFGC SF1 LF03
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LXSX
       QFG2 LXSX BG1 LXSX
       QDG1 LXSX BG1 LF03 PSFGC SF1 LF03
       QG2 LXSX BG2 LF03 LXSX LF03
       QG3 LXSX BG2 LXSX
       QG4 LXSX BG2 LXSX
       QG5 LXSX BG2 LXSX
       QG6 LXSX BG2 LF03 LXSX LF03
       QG7 LXSX BG2 F1)
     RFCELL = (FRF QRF LRF CA1 LRF FRD QRD LRF CA1 LRF QRF)
     DSUPP = (F1 LF03 QH6 LH3 QH5 LF03 BH3 LF03 QH4 LF03 BH2 QH3 LH2 QH2 LH1 QH1 LF03 BH1 LH0 BH0)
     DSUPP1 = (F0 LF03 QI6 LF03 BI3 LF03 QI5 LF03 BI2 LF03 QI4 LI3 QI3 LI2 QI2 LF03  BI1 LH0 BI0)
     DSUPPC = (
       LS2 QS3 LS3 QS4 LS4 LF03 BS LF03 QS5 LF03 BS)
     DSUPPL = (
       LL2 QL3 LL3 QL4 LL4 LF03 BL LF03 QL5 LF03 BL)
     ARCG=(-FQCELLG1 -FQCELLG -FQCELLG -FQCELLG -FQCELLG DSUPPC)
     COL = (IP ES1R LX1 ES2R LX2 QC1R1 QC1R2 LF03 QC2R1 QC2R2 LX3 ES3R ES4R LX4 ES5R
       QK1R 
       LC2 QK2R LF03 BV2 LF03 QK3R LF03 QC3 LF03 BW LF03 QK4R LF03  QC4 LF03 BC1 
         LF03 QK5R LF03  QC5 LC3 QK6R LF03 QC6  LC4 QK7R LF03 QC7 LF03 SY1R SY1R
       LY1 QY2 LF03 BC3 LF03 PQY1 QY1 LF03 BC3 LF03 QY2 LY1 SY2R SY2R
       LF03 QA1 LA1 
       QA2 LA2 QA3 LA3 QA4 LA4 QA5 LA5 QA6 LA6 -ARCG)
     COLL = (IP ES1L LX1 ES2L LX2 -QC1L1 -QC1L2 LF03 -QC2L1 -QC2L2 LX3 ES3L ES4L LX4 ES5L
       QK1L 
       LC2 QK2L LF03 BV2 LF03 QK3L LF03 QC3 LF03 BWL LF03 QK4L LF03  QC4  LF03 BC1L 
         LF03 QK5L LF03  QC5 LC3 QK6L LF03 QC6 LC4 QK7L LF03 QC7 LF03 SY1L SY1L
       LY1 QY2 LF03 BC3L LF03 PQY1 QY1 LF03 BC3L LF03 QY2 LY1 SY2L SY2L
       LF03 QB1 LB1 QB2 LB2 QB3 LB3 QB4 LB4 QB5 LB5 QB6 LB6 -DSUPPL 2*FQCELL)
     IR=(-F0 -FQCELL -FQCELL -COLL COL)
     TTH = ( LT3 QT3 LT4 QT4 LT5 QT5 LT6 QT6 )
     RFSECTION=(DSUPP  -TTH QRF RFCELL QRF TTH -DSUPP1)
;
 ;
FFS USE=FQCELL;

wdir=Catch[If[DirectoryQ[#],Throw[#]]&/@{
  "/Users/oide/FCCee",
  "/Volumes/oide-p73/FCCee",
  "/users/oide/FCCee",
  "/Users/oide/Documents/SuperTRISTAN"}];

Get[wdir//"/Optimize.n"];

sk2s="SY1*|S{FD}{1234}|S{FD}12{0123}|SD119";
ol=OptimizeLifetime[
  dir->wdir,
  DARange->50,turns->100,wz->15.5,nz->9,
  wpoint->40,wpoint1->60,wth->-20,
  damp->True,
  fname->Fetch,
  elm->{
!    {"$$$","NX"},{"$$$","NY"},
    {"S{FD}*|SY1*","K2"} , {sk2s,"SK2"},
    {"SY*","K3"}
  (*  ,{"QC{12}","K3"} *) 
      }
  ];
  dr:=FFS["draw bx by & ex ey q*;"];
  elm0=ol@elm;

  gl=GeoLibrary[olx->ol];

Get["stlib.sad"];

NPARA=12;
ring;rfsw;cod;noradcod;
CONVERGENCE=1e-22;
MINCOUP=1e-3;
PBUNCH=1e15;;
Brho=MOMENTUM/SpeedOfLight;
bqmax=0.8;
bsmax=0.6;
adp=0.02;

{bx0,by0}={1,0.001};

QL[a_,sige_,td_]:=td*(sige/a)^2*Exp[(a/sige)^2/2];

Circ=100e3;
lstr=11000;
nsp=4;
nbsp=4;
nbend=2440;
ncell=nbend/10;
lcell=(Circ-lstr)/ncell;
ba=(2*Pi-0.0488)/nbend;
rffreq=400e6;
{nxc,nyc}={0.25,0.25}
ca1Vc=230e6;

s* dx 0;
dsep=0.8;

lb1=lcell/10-0.6-1.8;
B1 L lb1;
B1 ANGLE ba;
save ;
rho=LINE["L","B1"]/LINE["ANGLE","B1"];
Element["L","LXSX"]=Element["L","LF03"]*2+Element["L","SF1"];
emit0=2e-9;
alpha0=8e-6;
bmax=170;
fit nx 1.25 ny 1.25;

cell; free q*
go;
end



save all;
t f0;
unitcell=ExtractBeamLine[];

use FQCELL2;
cell 
b2 l lb1+dsep*ba;
b2 angle ba;
fit nx 1.25 ny 1.25;
free q*;go;
save all;
t f1;

unitcell1=ExtractBeamLine[];

USE RFCELL;

cell fit nx 0.15 ny 0.15;
free q* cal;
!end
save all ;

lrfc=LINE["S","$$$"];
rfcell=ExtractBeamLine[];

hse0=150e3/0.1/MOMENTUM;
lse0=50;
lh0=0.05/hse0/lse0-lse0/2;

dsupp=ExtractBeamLine[DSUPP];
dsupp1=ExtractBeamLine[DSUPP1];

bxmqt=420;
bymqt=420;

USE RFSECTION;
LINE["L","BH0"]=lse0;
LINE["ANGLE","BH0"]=-hse0*lse0;
LINE["L","BI0"]=lse0;
LINE["ANGLE","BI0"]=hse0*lse0;
LINE["L","LH0"]=lh0;

ins;
fcrsr:=FFS["\
fit frf ax 0 bx @ ay 0 by @ ex 0 epx 0 chi1 0;\
fit f1 f0  bxm bxmqt*0.95 bym bymqt*0.95;"];xs
fcrsl:=FFS["\
fit f0 ax @- bx @ ay @- by @ ex @ epx @- gy dsep chi1 0;\
fit f1 f0  bxm bxmqt*0.95 bym bymqt*0.95;\
fit qrd leng 550;"];
fcrsr;fcrsl;
free q{hit}* l{hit}{^0}* b{hi}{123} b{hi}{123} l ;
fix bi{13} l;
bi3 minmax 0.0027;
q{hitu}{2468} min 0 max 0.05;
q{hitu}{1357} min -0.05 max 0;
l{htu}* min 5;
li{^1} min 5;
li1 min 0.3;

dleng=0;
dltol=0.0001
FitValue["QRD","LENG",_,_,v_]:=(LINE["S","F0"]+dleng)/2-0.3;

cal;
!end

save all;
Clear[FitValue];

nrfc=Ceiling[11e9/2/8e6/lrfc]+1;
rfs=ExtractBeamLine[];
p=Position[rfs,FRF,1,1];
rfs=Insert[rfs,(nrfc-1)*rfcell,p[[1,1]]];
pfrf=nrfc/2+1;
p=Position[rfs,FRF,1,pfrf][[-1,1]];
rfsr=Take[rfs,p];
rfsl=Drop[rfs,p-1];

dsuppc=ExtractBeamLine[DSUPPC];
dsupp1=ExtractBeamLine[DSUPP1];

  nysdr=2.68;
  nysdl=2.68;
  exsy1=0.15;
  bxsy1=22;
  bysy1=7000;
  bymqc=2500;
  bxmqc=1300;
  bxmqb6=600;
  bymql5=600;
  exmqs=0.3;
  bymqg=160;

  fcc:=FFS["\
    fit qk3r chi2 0;\
    fit qk7r+1 r1 0 r2 0 r3 0 r4 0 ey 0 epy 0;"];
  fcg:=FFS["fit fit $$$ gx 3257 gy 109 chi1 6.6385;"];
  fca:=FFS["fit qfg2.1 qfg2.3 nx 0.5 ny 0.5;\
    fit qfg2 qfg2.2 ax 1 ay 1 bx 1 by 1 ex 1 epx 1;"];
  fclc:=FFS["fit ip ex 0 epx 0 ey 0 epy 0 r1 0 r2 0 r3 0 r4 0"];
  fcl:=FFS["  fit ip ax 0 ay 0 bx bx0 by by0 ;\
  fit F0 chi1 chi1ent/Degree;\
  fit qb6 ex 0 epx 0;\
  fit PSFC.8 qk1l+1 nx 1.5;\
  fit PSDC.8 ip ny nysdl;\
  fit qb6 bxm bxmqb6;\
  fit qb4 qb2 bxm bxmqb6*1.3;\
  fit ql5 bym bymql5;\
  fit qb5 qb3 bym bymql5*1.3;\
  "];
    fcr:=FFS["\
  fit F1 ax @; bx @; ay @ ;by @;ex @ epx @;\
  fit QK1R PSFGC nx 1.5;\
  fit ip psdgc ny nysdr;\
  fit qa3 bym 1500;\
  fit qa4 bxm 400;\
  fit qs4 exm exmqs;\
  fit qg2 qg7 bym bymqg;\
  "];
   fcz:=FFS["\
  fit IP SY1R.2 ny 0.75 nx 0.5;\
  fit sy1r.2 sy2r.2 nx 0.5 ny 0.5 ;\
  fit pqy1 ax 0 ay 0;\
  fit qy2.1 bxm 600;\
  fit sy1r.2 bx bxsy1 by bysy1 ex exsy1;\
  fit sy2r.1 ex 0 epx 0;\
  fit qc3 bym bymqc;\
  fit qc4 bxm bxmqc;\
  fit qc5 bym bymqc;\
  fit qc6 bxm bxmqc;\
  "];
  fc:=(fcc;fclc;fcg;fca;fcl;fcr;fcz);

 InitEnt[]:=(eyi=0; epyi=0; r1i=0; r2i=0; r3i=0; r4i=0; dxi=0; dpxi=0; dyi=0; dpyi=0);


USE COL
  ins;
  s* dx 0;
  bxi=bx0;
  byi=by0;
  InitEnt[];
  save ip;
  ins cal

(*
 qc1* l 1.6;
 qc2* l 1.25;
  fit qc1r2 pex 0 pepx Twiss["PEPX","QC1R1"];;
!  fit qc1r2 dx dxqc1r1+LINE["L","QC1R1"]*dpxqc1r1; dpx dpxqc1r1;
  free qc1r1 dx ;free qc1r1 chi1;
go
  rej total;fix *;
  qc1r2 chi1 LINE["CHI1","QC1R1"];
  fit qc1r2+1 pex 0;
  free qc1r2 dx;
go
  rej total;fix *;
  qc2r* chi1 LINE["CHI1","QC1R1"];
  fit qc2r2+1 pex 0 pepx Twiss["PEPX","QC1R1"];
  free qc2* dx;
go
end
  rej total;fix *;
  save all;
  fit lc2 r2 0;free qc2* rotate go
  save all;
  rej total ;fix *;
  fit bv2r+1 chi2 0;
  free bv* go;
  save all;
  rej total;fix *;
  VariableRange[_,"DY",_]:={-0.001,0.001};
*)
  uc=100e3;
  ltheta:=3/2/uc *MOMENTUM^3/MASS^2*ElectronRadius/FineStructureConstant;

  setev:=(ElementValues={
    "L"["BW"]:>ltheta*"ANGLE"["BW"],
    "L"["BC1"]:>ltheta*"ANGLE"["BC1"],
    "DY"["QC2R2"]:>"DY"["QC2R1"],
    "DY"["QC1R2"]:>"DY"["QC1R1"],
    "ROTATE"["QC2R2"]:>"ROTATE"["QC2R1"],
    "ROTATE"["QC1R2"]:>"ROTATE"["QC1R1"]
    });
  setev;
  coup qc1r2 qc1r1 1;
  coup qc2r2 qc2r1 1;

  fcc;fcr;fcz;fca;
  FFS["\
  LC* min 3 max 120;\
  lc2 min 24;\
  L{^CFXMSG}* min 6 max 60;\
  LY* min 20;\
  LA* min 10 max 40;\
  QK* minmax 7e-4;\
  Q{ABXY}{1357} min -0.07 max 0;\
  Q{ABXY}{2468} min 0 max 0.07;\
  QC{357}  min -0.07 max 0;\
  QC{468} min 0 max 0.05;\
  BV* minmax 2e-4;\
  BC{12} min 0 max 0.017;\
  BC3 min 0 max 0.017;\
  BC4 minmax 0.017;"]; !"


 free qy* ly* bc* bw qc* qc2* rotate lc* qa* la* qk* bv* qs* ls* bs* qg* q{df}g*;

 nxtol=0.0002;
 nxtols=0.0008;
 nytol=2e-6;
 bytol=0.2;
 FitValue["QK1R","PSFGC","NX",_,g_,v1_,v2_]:=If[Abs[(v2-v1)-g]<nxtols*2*Pi,Null,v1];
 FitValue["SY1R.2","BY",_,g_,v_]:=If[Abs[v-g]>bytol*g,g,Null,Null];
 FitValue["SY1R.2","EX",_,g_,v_]:=If[v<g,g,Null,Null];

 drr:=FFS["draw IP SY1R.1 bx by & ex & ey & r1 r4 & r2 & r3 qk*;",6];
 rc:=FFS["fix *;free qc* lc* go;free qk* qc2* rotate  go;free bv* go;free bc* bw qy* ly* go;free qa* la* qs* ls* bs* go;",6];
 rr:=FFS["fix *;free bv* go;free qk* qc2* rotate go;free qc* lc* go;free bc* bw qy* ly* go;free qa* la* qs* ls* bs* go;",6];

 go;
!end

save all;
ElementValues=.;
Clear[FitValue];
*)

USE IR
  s* dx 0;
  InitEnt[];
  org ip 0 0 0 0.015/Degree 0 0;
  ins cal
  uc=100e3;
  ltheta:=3/2/uc *MOMENTUM^3/MASS^2*ElectronRadius/FineStructureConstant;
  chi1ent=(ncell/nsp-4)*10*ba-Pi/2;

  coup qc1r2 qc1r1 1;
  coup qc2r2 qc2r1 1;

  setev:=(ElementValues={
    "L"["BW"]:>ltheta*"ANGLE"["BW"],
    "L"["BC1"]:>ltheta*"ANGLE"["BC1"],
    "DY"["QC2R2"]:>"DY"["QC2R1"],
    "DY"["QC1R2"]:>"DY"["QC1R1"],
    "ROTATE"["QC2R2"]:>"ROTATE"["QC2R1"],
    "ROTATE"["QC1R2"]:>"ROTATE"["QC1R1"],
    "ANGLE"["BWL"]:>-"ANGLE"["BW"],
    "ANGLE"["BC1L"]:>-"ANGLE"["BC1"],
    "ANGLE"["BC3L"]:>-"ANGLE"["BC3"],
    "L"["BWL"]:>"L"["BW"],
    "L"["BC1L"]:>"L"["BC1"],
    "L"["BC3L"]:>"L"["BC3"],
    Null@@(With[{n=#},"K1"[n//"L"]:>"K1"[n//"R"]]&/@Table["QK"//i,{i,1,7}]),
    Null@@(With[{n=#},"ROTATE"[n//"L"]:>-"ROTATE"[n//"R"]]&/@Table["QK"//i,{i,1,7}]),
    Null@@(With[{n=#},"K1"[StringReplace[n,"R"->"L"]]:>"K1"[n]]&/@{"QC1R1","QC1R2","QC2R1","QC2R2"}),
    Null@@(With[{n=#},"DX"[StringReplace[n,"R"->"L"]]:>-"DX"[n]]&/@{"QC1R1","QC1R2","QC2R1","QC2R2"}),
    Null@@(With[{n=#},"DY"[StringReplace[n,"R"->"L"]]:>"DY"[n]]&/@{"QC1R1","QC1R2","QC2R1","QC2R2"}),
    Null@@(With[{n=#},"CHI1"[StringReplace[n,"R"->"L"]]:>"CHI1"[n]]&/@{"QC1R1","QC1R2","QC2R1","QC2R2"}),
    Null@@(With[{n=#},"ROTATE"[StringReplace[n,"R"->"L"]]:>-"ROTATE"[n]]&/@{"QC1R1","QC1R2","QC2R1","QC2R2"})
    });
  setev;

  FFS["\
  LC* min 3 max 120;\
  lc2 min 24;\
  L{^CFXMSGBL}* min 6 max 60;\
  LY* min 20;\
  LA* min 10 max 40;\
  QK* minmax 7e-4;\
  Q{ABXY}{1357} min -0.07 max 0;\
  Q{ABXY}{2468} min 0 max 0.07;\
  QC{357}  min -0.07 max 0;\
  QC{468} min 0 max 0.05;\
  BV* minmax 2e-4;\
  BC{12} min 0 max 0.017;\
  BC3 min 0 max 0.017;\
  BC4 minmax 0.017;\
  "];
  fc;

  vrl:=FFS[" free q{fd}G* bg* bg* l qg* qs* ls* bs* qa* la* ql* ll* bl* qb* lb*"];
  vz:=FFS["free qy* ly* bc* bw qc* qc2* rotate lc* qk* bv*"];
  vrl;vz;

 nxtol=0.0002;
 nxtols=0.0008;
 nytol=2e-6;
 bytol=0.2;
 FitValue["QK1R","PSFGC","NX",_,g_,v1_,v2_]:=If[Abs[(v2-v1)-g]<nxtols*2*Pi,Null,v1];
 FitValue["SY1R.2","BY",_,g_,v_]:=If[Abs[v-g]>bytol*g,g,Null,Null];
 FitValue["SY1R.2","EX",_,g_,v_]:=If[v<g,g,Null,Null];
 FitValue["$$$","GX",_,_,_]:=-LINE["GX","^^^"]-dsep*Sin[chi1ent];
 FitValue["$$$","CHI1",_,_,_]:=-LINE["GEO","^^^"][[2,1]];
 FitValue["$$$","GY",_,_,_]:=LINE["GY","^^^"]-dsep*Cos[chi1ent];

 drr:=FFS["draw IP SY1R.1 bx by & ex & ey & r1 r4 & r2 & r3 qk*;",6];
 rc:=FFS["fix *;free qc* lc* go;free qk* qc2* rotate  go;free bv* go;free bc* bw qy* ly* go;free qa* la* qs* ls* bs* go;",6];
 rr:=FFS["fix *;free bv* go;free qk* qc2* rotate go;free qc* lc* go;free bc* bw qy* ly* go;free qa* la* qs* ls* bs* go;",6];
 rs:=FFS["rej total;fix *;vrl;fcl go;fclc go;fca fcg go;fcr go;fc go;",6];

 FFS$NumericalDerivative=1;
 rs;
 
!end

save all;
FFS$NumericalDerivative=0;
ElementValues=.;
Clear[FitValue];
ir=ExtractBeamLine[];

bxmt=bymt=300;

nqr=nsp/4;
QRINGR=BeamLine[ (ncell/nsp-4)*unitcell1, rfsr];
QRINGL=BeamLine[ (ncell/nsp-4)*unitcell, -rfsl];

FRINGA=BeamLine[-QRINGL, ir, QRINGR];

USE FRINGA;

  org ip 0 0 0 0.015/Degree 0 0;
ca1 freq 400e6 ;
ca1 ca1Vc;
cell cal emit;
!sigz0=2.4e-3;
!ca1 #ca1*(SIGZ/sigz0)^2;
save ca1;

dprs[dp_]:=Do[DP=k*0.001;If[ol@RelaxStab[,True],,DP=DP-0.001;FFS["calc",6];Break[]],{k,1,Round[dp/0.001]}];
dprs1[dp_]:=Do[DP=k*0.001;If[ol@RelaxStab[,False],,Break[]],{k,1,Round[dp/0.001]}];
dprs[dp0_,dp_]:=Do[DP=k*0.001;If[ol@RelaxStab[,True],,DP=DP-0.001;FFS["calc",6];Break[]],{k,Round[dp0/0.001],Round[dp/0.001]}];
dprs1[dp0_,dp_]:=Do[DP=k*0.001;If[ol@RelaxStab[,False],,Break[]],{k,Round[dp0/0.001],Round[dp/0.001]}];
CONVERGENCE=1e-20;

ol@AdjustTune[nx_,ny_]:=Module[{},
  FFS["reset qt* qr{fd};reject total;FIT $$$ nx "//nx//" NY "//ny//";\
       fit ip ax 0 ay 0 bx bx0 by by0;\
       fit qt3 qt6 bxm bxmqt bym bymqt;\
       fit frf frf.2 bx 1 by 1;\
       fix *; free qt* qr{fd};\
       go;",6]];

!{nx0,ny0}=Twiss[{"NX","NY"},"$$$"]/2/Pi;
{nx0,ny0}=Floor[Twiss[{"NX","NY"},"$$$"]/2/Pi] +{.53,.570}
 ol@AdjustTune[nx0,ny0];

 gl@PlotIRGeo[];

!end

save all;;
ElementValues=.;

fringa=ExtractBeamLine[];

With[{s=#},Module[{},
  sp=LINE["POSITION",s//"*"];
  ns=Length[sp]/2;
  Do[SetElement[s//i,"MULT",{"L"->LINE["L","SF1"]}],{i,ns}];
  sl=Table[Symbol[s//i],{i,ns}];
  sl=Flatten[Thread[{sl,sl}]];
  sl=RotateRight[sl,61*2];
  pt=Range[ns*2];
  MapThread[(fringa[[sp[[#]]]]=#2)&,{pt,sl}];
!  (fring[[sp[[#]]]]=LXS)&/@pdt;
  ]]&/@{"SF","SD"};


 wfmin=0.1;
 wdp=1;
 fw[x_]:=(1-4(1-wfmin)*x*(1-x));
! FitWeight[_,"DX"|"DY"|"DPX"|"DPY",{_,dp_},w_]:=With[{r=(dp/DP)^2*wdp},w*fw[r]*worb];
! FitWeight["$$$","NX"|"NY",_,w_]:=w*10;
 FitWeight[_,_,{_,dp_},w_]:=With[{r=(dp/DP)^2*wdp},w*fw[r]];
 da:=DynamicApertureSurvey[{{0,10},{0,0.1},Range[-10,10,1]},100,Output->6];

use fringa;

sxshift[]:=(
  Do[LINE["K2","SF"//i]=LINE["K2","SF"//i-4],{i,125,66,-1}];
  Do[LINE["K2","SF"//i]=0,{i,62,65}];
  Do[LINE["SK2","SF"//i]=LINE["SK2","SF"//i-4],{i,125,66,-1}];
  Do[LINE["K2","SD"//i]=LINE["K2","SD"//i-4],{i,124,65,-1}];
  Do[LINE["K2","SD"//i]=0,{i,61,64}];
  Do[LINE["SK2","SD"//i]=LINE["SK2","SD"//i-4],{i,124,65,-1}]);

cell cal;

thetax=Abs[LINE["CHI1","ES1L"]];
kcw=-1/(2 thetax Twiss["BY","IP"] Twiss["BY","SY2R.2"])* Sqrt[Twiss["BX","IP"]/Twiss["BX","SY2R.2"]]
ol@fcw=1;

rej total;fix *;
setev:=(ElementValues={
  "K2"["SY2R"]:>"K2"["SY1R"]-kcw*ol@fcw/2,
  "K2"["SY2L"]:>"K2"["SY1L"]+kcw*ol@fcw/2,
  "SK2"["SY2R"]:>"SK2"["SY1R"],
  "SK2"["SY2L"]:>"SK2"["SY1L"]});
setev;

dxmr=0*Sqrt[EMITX*Twiss["BX","$$$"]]/5;
dpxmr=0*Sqrt[EMITX/Twiss["BX","$$$"]]/5;
dymr=0*Sqrt[EMITX*MINCOUP*Twiss["BY","$$$"]];
dpymr=0*Sqrt[EMITX*MINCOUP/Twiss["BY","$$$"]];
fc:=FFS["fit $$$ nx nx0 24 ny ny0 24;\
  fit frf.11  bx @ 24 by @ 24 ax 0 24 ay 0 24;"];
fc;
fci:=FFS["fit ip bx bx0 24 ax 0 24 dx 0 24 dpx 0 24;"];
fcd:=FFS["fit frf.11 dx dxmr 24 dpx dpxmr 24;"]; 
fcs:=FFS["FIT frf.11 r1 0 24 r2 0 24 r3 0 24 r4 0 24 dy dymr 24 dpy dpymr 24;"];
vs:=FFS["FREE "//sk2s//" sk2;"];
vfs:=FFS["FIX "//sk2s//" sk2;"];
xweight=1/3;
yweight=1/10;
rweight=1/30;
dxweight=1/10;
dyweight=1/20;
FitWeight[_,"AX"|"BX",_,w_]:=w*xweight;
FitWeight[_,"AY"|"BY",_,w_]:=w*yweight;
FitWeight[_,"R1"|"R2"|"R3"|"R4",_,w_]:=w*rweight;
FitWeight[_,"DX"|"DPX",{_,dp_},w_]:=w*(dp/DP)^2;
FitWeight[_,"DX"|"DPX",{_,dp_},w_]:=w*(dp/DP)^2*dxweight;
FitWeight[_,"DY"|"DPY",{_,dp_},w_]:=w*(dp/DP)^2*dyweight;
s* minmax 2.5;
sd* max 0;sf* min 0;
fitp 24;
vary k2 s{fdxy}*;
DP=0.002;free s{fd}*|sy1*;free sy* sk2;fix sy* sk2;
intra ol@emit=Emittance[Output->6];

nointra;
ca1 phi -ArcSin[3084/4600];
FSHIFT=4.0089e-6/Circ*2;
rad;radcod;nofluc;radtaper;codplot;em=Emittance[];
FSHIFT+=(Twiss["DZ","^^^"]-Twiss["DZ","$$$"])/LINE["S","$$$"];
em=Emittance[Output->6];
ol@damp=0;
draw ddp & dx dy s*;

z={1,{{0},{0},{0},{0},{0},{10*SIGE},{1}}};
z1=TrackParticles[z,1]

adjfs:=(FSHIFT+=-(Twiss["DZ","^^^"]-Twiss["DZ","$$$"])/LINE["S","$$$"]);

end


dprs[0.002];
ol@SetupChroma["S*",{0,0}];
reset;

DP=0.02;

end


so@Optimize[MaxIterations->10]

end

!
!nointra radcod codplot emit;
!rad nofluc;
!
!end

e=Emittance[Output->6];
{alpha,sige,bh,damp}={MomentumCompaction,MomentumSpread,BucketHeight,DampingRate}/.e;

nus=Sqrt[Vc/MOMENTUM*2*Pi*rffreq*Circ/SpeedOfLight*alpha]/2/Pi
sigz=sige*alpha*Circ/2/Pi/nus
tau=QL[bh,sige,Circ/SpeedOfLight/damp[[3]]]

 Turns =100 Maximum number of particles =266
 Range    Xmin:   0.000 Xmax:  50.000
         (Ymin:   0.000 Ymax:   1.581)
          Zmin: -15.500 Zmax:  15.500
 Display:    10 turns/character
      NZ     0----|----1----|----2----|----3----|----4----|----5
   -15.50  9 **AAAAAAA1.         .         .         .         .
   -15.26  9 **AAAAAAA2.         .         .         .         .
   -14.57 10 ***AAAAAAA.         .         .         .         .
   -13.42 10 ***AAAAAAA.         .         .         .         .
   -11.87 10 ***AAAAAAA.         .         .         .         .
    -9.96 10 ***AAAAAAA.         .         .         .         .
    -7.75 10 ***AAAAAAA2         .         .         .         .
    -5.30 12 *****AAAAAAA5       .         .         .         .
    -2.69 19 ************AAAAAAA .         .         .         .
     0.00 41 **********************************AAAAAAA211A     .
     2.69 10 ***AAAAAAA31111     .         .         .         .
     5.30  8 *AAAAAAA111111      .         .         .         .
     7.75  8 *AAAAAAA11111       .         .         .         .
     9.96  8 *AAAAAAA1 1111      .         .         .         .
    11.87  8 *AAAAAAA31.11       .         .         .         .
    13.42  9 **AAAAAAA111        .         .         .         .
    14.57  7 AAAAAAA1  11        .         .         .         .
    15.26  6 AAAAAA1   .         .         .         .         .
    15.50  6 AAAAAA1   .         .         .         .         .
      NZ     0----|----1----|----2----|----3----|----4----|----5
    Score:   210
 Turns =100 Maximum number of particles =266
 Range    Xmin:   0.000 Xmax:  50.000
         (Ymin:   0.000 Ymax:   1.581)
          Zmin: -15.500 Zmax:  15.500
 Display:    10 turns/character
      NZ     0----|----1----|----2----|----3----|----4----|----5
   -15.50  3 AAA       .         .         .         .         .
   -15.26  3 AAA1      .         .         .         .         .
   -14.57  4 AAAA      .         .         .         .         .
   -13.42  4 AAAA2     .         .         .         .         .
   -11.87  4 AAAA51    .         .         .         .         .
    -9.96  6 AAAAAA3   .         .         .         .         .
    -7.75  8 *AAAAAAA  .         .         .         .         .
    -5.30  8 *AAAAAAA1 . 1   1   .         .         .         .
    -2.69 11 ****AAAAAAA11       .         .         .         .
     0.00 39 ********************************AAAAAAA328AA111   .
     2.69 15 ********AAAAAAA11   .         .         .         .
     5.30 11 ****AAAAAAA11       .         .         .         .
     7.75  9 **AAAAAAA11         .         .         .         .
     9.96  8 *AAAAAAA  .         .         .         .         .
    11.87  7 AAAAAAA   .         .         .         .         .
    13.42  5 AAAAA1    .         .         .         .         .
    14.57  5 AAAAA1    .         .         .         .         .
    15.26  5 AAAAA2    .         .         .         .         .
    15.50  6 AAAAAA    .         .         .         .         .
      NZ     0----|----1----|----2----|----3----|----4----|----5
    Score:   161
Lifetime:   515.6864 (  845.0025 points)  Stop
 {a1,b1,a2,b2}: {   29.7336,    9.3222,   21.1292,    7.2313} {   12.8989,    7.6785,   14.8401,    9.3808}
